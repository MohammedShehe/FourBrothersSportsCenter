<!DOCTYPE html>
<html lang="sw">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="images/FBSC.png" />
  <title>Admin Panel - Four Brothers Sports Center</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Icons -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.umd.min.js"></script>
  <style>
    :root {
      --primary: #0d6efd;
      --secondary: #6c757d;
      --success: #198754;
      --danger: #dc3545;
      --warning: #ffc107;
      --info: #0dcaf0;
      --light: #f8f9fa;
      --dark: #212529;
      --accent: #0d6efd;
      --accent-light: #e7f1ff;
      --border-radius: 8px;
      --shadow: 0 4px 6px rgba(0,0,0,0.1);
      --transition: all 0.3s ease;
    }
    
    body {
      background-color: #f8f9fa;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      color: #333;
      overflow-x: hidden;
    }
    
    /* Login Styles */
    .login-container {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, var(--primary), var(--info));
      padding: 1rem;
    }

    .login-card {
      background: white;
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
      padding: 2rem;
      width: 100%;
      max-width: 400px;
      transition: transform 0.3s ease;
    }

    .login-card:hover {
      transform: translateY(-2px);
    }

    .login-card h4 {
      margin-bottom: 0.5rem;
      font-size: 1.5rem;
      font-weight: 600;
      color: var(--primary);
    }

    .login-card p {
      margin-bottom: 1.5rem;
      color: var(--secondary);
      font-size: 0.95rem;
    }

    .login-card input[type="text"],
    .login-card input[type="password"] {
      width: 100%;
      padding: 0.75rem;
      margin-bottom: 1rem;
      border: 1px solid #ddd;
      border-radius: var(--border-radius);
      font-size: 1rem;
      transition: border-color 0.3s ease;
    }

    .login-card input:focus {
      border-color: var(--primary);
      outline: none;
    }

    .login-card button {
      width: 100%;
      padding: 0.75rem;
      background-color: var(--primary);
      color: white;
      border: none;
      border-radius: var(--border-radius);
      font-size: 1rem;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }

    .login-card button:hover {
      background-color: #0056b3;
    }

    .logo-container {
      width: 120px;
      height: 48px;
      margin: 0 auto 1rem;
      border-radius: 4px;
      overflow: hidden;
    }

    .logo-container img {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }
    
    /* Admin Panel Styles */
    .sidebar {
      min-width: 260px;
      max-width: 260px;
      background: #fff;
      border-right: 1px solid #e6e6e6;
      min-height: 100vh;
      transition: var(--transition);
      z-index: 1000;
    }
    
    .nav-link {
      color: var(--dark);
      padding: 12px 16px;
      border-radius: var(--border-radius);
      margin-bottom: 5px;
      transition: var(--transition);
      display: flex;
      align-items: center;
    }
    
    .nav-link:hover {
      background-color: var(--accent-light);
    }
    
    .nav-link.active {
      background: linear-gradient(90deg, rgba(13,110,253,0.1), transparent);
      color: var(--primary);
      font-weight: 600;
      border-left: 4px solid var(--primary);
    }
    
    .card-small {
      padding: 16px;
      border-radius: 12px;
      border: none;
      box-shadow: var(--shadow);
      transition: var(--transition);
    }
    
    .card-small:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 20px rgba(0,0,0,0.1);
    }
    
    .product-thumb {
      width: 55px;
      height: 55px;
      object-fit: cover;
      border-radius: 8px;
    }
    
    .pointer {
      cursor: pointer;
    }
    
    .btn {
      border-radius: 30px;
      padding: 8px 20px;
      font-weight: 500;
      transition: var(--transition);
    }
    
    .btn-primary {
      background-color: var(--primary);
      border-color: var(--primary);
    }
    
    .btn-primary:hover {
      background-color: #0b5ed7;
      border-color: #0a58ca;
      transform: translateY(-2px);
    }
    
    .modal-content {
      border-radius: var(--border-radius);
      border: none;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }
    
    .modal-header {
      border-bottom: 1px solid rgba(0,0,0,0.1);
      padding: 1rem 1.5rem;
    }
    
    .modal-footer {
      border-top: 1px solid rgba(0,0,0,0.1);
      padding: 1rem 1.5rem;
    }
    
    .table th {
      border-top: none;
      font-weight: 600;
      color: var(--dark);
    }
    
    .table-responsive {
      border-radius: var(--border-radius);
      overflow: hidden;
    }
    
    .badge-status {
      font-size: 0.75rem;
      padding: 5px 10px;
      border-radius: 20px;
    }
    
    .section-title {
      position: relative;
      margin-bottom: 25px;
      font-weight: 600;
      color: var(--dark);
    }
    
    .section-title:after {
      content: '';
      position: absolute;
      left: 0;
      bottom: -8px;
      width: 50px;
      height: 3px;
      background: var(--primary);
      border-radius: 3px;
    }
    
    .image-preview {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 10px;
    }
    
    .image-preview img {
      width: 80px;
      height: 80px;
      object-fit: cover;
      border-radius: 8px;
      border: 1px solid #ddd;
    }
    
    /* Status Badge Styles */
    .status-badge {
      font-size: 0.75rem;
      padding: 5px 12px;
      border-radius: 20px;
      font-weight: 500;
    }
    
    .status-Imewekwa {
      background-color: var(--primary);
      color: white;
    }
    
    .status-Inasafirishwa {
      background-color: var(--warning);
      color: var(--dark);
    }
    
    .status-Ghairishwa {
      background-color: var(--danger);
      color: white;
    }
    
    .status-Kurudishwa {
      background-color: var(--info);
      color: white;
    }
    
    .status-Imepokelewa {
      background-color: var(--success);
      color: white;
    }
    
    /* Status Control Button Group */
    .status-control-group {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
    }
    
    .status-control-group .btn {
      font-size: 0.7rem;
      padding: 4px 8px;
      border-radius: 4px;
      flex: 1;
      min-width: 80px;
    }
    
    /* Loading spinner */
    .spinner-border-sm {
      width: 1rem;
      height: 1rem;
    }
    
    /* Alert styles */
    .alert {
      border-radius: var(--border-radius);
      border: none;
    }
    
    /* Placeholder image styles */
    .placeholder-img {
      background: linear-gradient(45deg, #f0f0f0, #e0e0e0);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #999;
      font-weight: bold;
      border: 1px solid #ddd;
    }
    
    /* Mobile-first responsive adjustments */
    @media (max-width: 991px) {
      .sidebar {
        position: fixed;
        left: -300px;
        height: 100vh;
        overflow-y: auto;
        box-shadow: 2px 0 10px rgba(0,0,0,0.1);
      }
      
      .sidebar.show {
        left: 0;
      }
      
      .main-content {
        width: 100%;
      }
      
      .status-control-group {
        flex-direction: column;
      }
      
      .status-control-group .btn {
        min-width: 100%;
      }
      
      .modal-dialog {
        margin: 1rem;
      }
      
      .table-responsive {
        font-size: 0.875rem;
      }
      
      .nav-link {
        padding: 10px 12px;
      }
    }
    
    @media (max-width: 768px) {
      .login-card {
        margin: 20px;
        padding: 1.5rem;
      }
      
      .section-title:after {
        width: 30px;
      }
      
      .card-small {
        padding: 12px;
      }
      
      .btn {
        padding: 6px 12px;
        font-size: 0.875rem;
      }
      
      .modal-dialog-scrollable .modal-body {
        max-height: 60vh;
      }
    }
    
    @media (max-width: 576px) {
      .d-flex.justify-content-between.align-items-center {
        flex-direction: column;
        align-items: flex-start !important;
        gap: 10px;
      }
      
      .d-flex.justify-content-between.align-items-center > div {
        width: 100%;
      }
      
      .d-flex.justify-content-between.align-items-center .btn {
        width: 100%;
        margin-bottom: 5px;
      }
      
      .table th, .table td {
        padding: 0.5rem;
      }
      
      .modal-dialog {
        margin: 0.5rem;
      }
      
      .modal-content {
        border-radius: 0;
      }
      
      .modal-header, .modal-footer {
        padding: 0.75rem 1rem;
      }
      
      .section-title {
        font-size: 1.25rem;
      }
      
      .card-small h4 {
        font-size: 1.25rem;
      }
      
      .card-small .fa-2x {
        font-size: 1.5rem;
      }
    }
    
    /* Mobile overlay for sidebar */
    .sidebar-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 999;
      display: none;
    }
    
    .sidebar-overlay.show {
      display: block;
    }
    
    /* Improved mobile form controls */
    .form-control, .form-select {
      padding: 0.75rem;
    }
    
    /* Better mobile table experience */
    .table-mobile-card {
      display: none;
    }
    
    @media (max-width: 768px) {
      .table-responsive table {
        display: none;
      }
      
      .table-mobile-card {
        display: block;
      }
      
      .mobile-card {
        background: white;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 15px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      }
      
      .mobile-card-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 8px;
        padding-bottom: 8px;
        border-bottom: 1px solid #f0f0f0;
      }
      
      .mobile-card-row:last-child {
        border-bottom: none;
        margin-bottom: 0;
        padding-bottom: 0;
      }
      
      .mobile-card-label {
        font-weight: 600;
        color: #666;
      }
      
      .mobile-card-value {
        text-align: right;
      }
    }
    
    /* Improved mobile navigation */
    .mobile-header {
      display: none;
      background: white;
      padding: 15px;
      border-bottom: 1px solid #e6e6e6;
      position: sticky;
      top: 0;
      z-index: 100;
    }
    
    @media (max-width: 991px) {
      .mobile-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
    }
  </style>
</head>
<body>
  <!-- Login Page -->
  <div id="loginPage" class="login-container">
    <div class="login-card">
      <div class="text-center mb-4">
        <div class="logo-container">
          <img src="images/FBSC.png" alt="Four Brothers Logo">
        </div>
        <h4>Admin Ingia</h4>
        <p class="text-muted">Weka maelezo yako ya kuingia</p>
      </div>
      
      <form id="adminLoginForm">
        <div class="mb-3">
          <label class="form-label">Jina la Kwanza</label>
          <input type="text" class="form-control" id="adminFname" required>
        </div>
        
        <div class="mb-3">
          <label class="form-label">Jina la Mwisho</label>
          <input type="text" class="form-control" id="adminLname" required>
        </div>
        
        <div class="d-grid gap-2">
          <button type="submit" class="btn btn-primary">
            <span id="loginBtnText">Tuma OTP</span>
            <span id="loginSpinner" class="spinner-border spinner-border-sm" style="display: none;"></span>
          </button>
        </div>
      </form>
      
      <div id="otpSection" style="display: none;" class="mt-4">
        <div class="mb-3">
          <label class="form-label">Weka OTP</label>
          <input type="text" class="form-control" id="adminOtp" placeholder="123456" required maxlength="6">
        </div>
        
        <div class="d-grid gap-2">
          <button type="button" class="btn btn-success" id="verifyOtpBtn">
            <span id="verifyBtnText">Thibitisha</span>
            <span id="verifySpinner" class="spinner-border spinner-border-sm" style="display: none;"></span>
          </button>
          <button type="button" class="btn btn-outline-secondary" id="backToLoginBtn">Rudi kwenye kuingia</button>
        </div>
      </div>
      
      <div id="loginAlert" class="alert alert-danger mt-3" style="display: none;"></div>
    </div>
  </div>

  <!-- Admin Panel (hidden initially) -->
  <div id="adminPanel" style="display: none;">
    <!-- Mobile Header -->
    <div class="mobile-header">
      <div class="d-flex align-items-center">
        <button class="btn btn-outline-secondary me-3" id="toggleSidebarMobile">
          <i class="fa fa-bars"></i>
        </button>
        <div>
          <h5 class="mb-0" id="mobileSectionTitle">Dashibodi</h5>
          <small class="text-muted">Four Brothers Admin</small>
        </div>
      </div>
      <button class="btn btn-outline-danger" id="btnLogoutMobile">
        <i class="fa fa-sign-out-alt me-1"></i>Toka
      </button>
    </div>
    
    <!-- Sidebar Overlay (for mobile) -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>
    
    <div class="d-flex">
      <!-- Sidebar -->
      <aside class="sidebar p-3 shadow-sm" id="sidebar">
        <div class="d-flex align-items-center mb-4">
          <div class="placeholder-img me-2 rounded-circle" style="width: 48px; height: 48px;">
            <image src="images/FBSC.png" alt="Admin Avatar" style="width: 100%; height: 100%; object-fit: cover;">
          </div>
          <div>
            <h6 class="mb-0">Four Brothers</h6>
            <small class="text-muted">Admin Panel</small>
          </div>
        </div>
        
        <nav class="nav flex-column">
          <a class="nav-link active" data-section="dashboard" href="#">
            <i class="fa fa-tachometer-alt me-2"></i>Dashibodi
          </a>
          <a class="nav-link" data-section="products" href="#">
            <i class="fa fa-box-open me-2"></i>Usimamizi wa Bidhaa
          </a>
          <a class="nav-link" data-section="customers" href="#">
            <i class="fa fa-users me-2"></i>Usimamizi wa Wateja
          </a>
          <a class="nav-link" data-section="ads" href="#">
            <i class="fa fa-bullhorn me-2"></i>Matangazo & Arifa
          </a>
          <a class="nav-link" data-section="notifications" href="#">
            <i class="fa fa-envelope me-2"></i>Arifa & Ujumbe
          </a>
          <a class="nav-link" data-section="orders" href="#">
            <i class="fa fa-shopping-cart me-2"></i>Maagizo Yaliyowekwa
          </a>
        </nav>
        
        <div class="mt-4 small text-muted">
          Imekuwapo kama: <strong id="adminNameDisplay">Admin</strong>
        </div>
      </aside>

      <!-- Main Content -->
      <main class="flex-grow-1 p-3 p-md-4 main-content">
        <div class="d-none d-lg-flex justify-content-between align-items-center mb-4">
          <h3 class="m-0 section-title" id="sectionTitle">Dashibodi ya Msimamizi</h3>
          <div class="d-flex align-items-center gap-2">
            <button class="btn btn-outline-secondary d-lg-none" id="toggleSidebar">
              <i class="fa fa-bars"></i>
            </button>
            <button class="btn btn-outline-danger" id="btnLogout">
              <i class="fa fa-sign-out-alt me-1"></i>Toka
            </button>
          </div>
        </div>

        <!-- Alert container for API messages -->
        <div id="apiAlert" class="alert" style="display: none;"></div>

        <!-- Sections container -->
        <section id="sectionContainer">
          <!-- DASHBOARD -->
          <div id="dashboard" class="section">
            <div class="row g-3 mb-4">
              <div class="col-6 col-md-3">
                <div class="card card-small">
                  <div class="d-flex justify-content-between align-items-center">
                    <div>
                      <small class="text-muted">Wateja Wote</small>
                      <h4 id="totalUsers">0</h4>
                    </div>
                    <i class="fa fa-users text-muted"></i>
                  </div>
                </div>
              </div>
              
              <div class="col-6 col-md-3">
                <div class="card card-small">
                  <div class="d-flex justify-content-between align-items-center">
                    <div>
                      <small class="text-muted">Bidhaa Zote</small>
                      <h4 id="totalProducts">0</h4>
                    </div>
                    <i class="fa fa-box text-muted"></i>
                  </div>
                </div>
              </div>
              
              <div class="col-6 col-md-3">
                <div class="card card-small">
                  <div class="d-flex justify-content-between align-items-center">
                    <div>
                      <small class="text-muted">Mapato (mwaka huu)</small>
                      <h4 id="totalIncome">TSh 0</h4>
                    </div>
                    <i class="fa fa-money-bill-wave text-muted"></i>
                  </div>
                </div>
              </div>
              
              <div class="col-6 col-md-3">
                <div class="card card-small">
                  <div class="d-flex justify-content-between align-items-center">
                    <div>
                      <small class="text-muted">Bidhaa Zilizonunuliwa</small>
                      <h4 id="totalOrders">0</h4>
                    </div>
                    <i class="fa fa-shopping-cart text-muted"></i>
                  </div>
                </div>
              </div>
            </div>

            <div class="card shadow-sm p-3 mb-4">
              <h6 class="section-title">Maendeleo ya Mapato (kila mwezi)</h6>
              <div style="position: relative; height: 300px;">
                <canvas id="incomeChart"></canvas>
              </div>
            </div>
            
            <div class="row g-3">
              <div class="col-md-6">
                <div class="card shadow-sm p-3">
                  <h6 class="section-title">Vitendo vya Haraka</h6>
                  <div class="mt-3 d-flex flex-column gap-2">
                    <button class="btn btn-outline-primary" data-section-target="products" id="quickAddProductBtn">
                      <i class="fa fa-plus me-2"></i>Ongeza Bidhaa
                    </button>
                    <button class="btn btn-outline-success" data-section-target="customers" id="quickAddCustomerBtn">
                      <i class="fa fa-user-plus me-2"></i>Ongeza Mteja
                    </button>
                    <button class="btn btn-outline-warning" data-section-target="ads" id="quickAddAdBtn">
                      <i class="fa fa-bullhorn me-2"></i>Chapisha Tangazo
                    </button>
                  </div>
                </div>
              </div>
              
              <div class="col-md-6">
                <div class="card shadow-sm p-3">
                  <h6 class="section-title">Maagizo ya Hivi Karibuni</h6>
                  <div id="recentOrders" class="mt-2">
                    <!-- Recent orders will be populated here -->
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- PRODUCTS -->
          <div id="products" class="section d-none">
            <div class="d-flex justify-content-between align-items-center mb-3 flex-column flex-md-row gap-2">
              <h5 class="section-title">Usimamizi wa Bidhaa</h5>
              <div class="d-flex flex-column flex-md-row gap-2 w-100 w-md-auto">
                <input type="text" id="productSearch" placeholder="Tafuta bidhaa..." class="form-control" style="min-width: 200px;">
                <button class="btn btn-outline-info" onclick="loadProducts()">
                  <i class="fa fa-refresh me-1"></i>Pakia Upya
                </button>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalAddProduct">
                  <i class="fa fa-plus me-1"></i>Ongeza Bidhaa
                </button>
              </div>
            </div>

            <div class="table-responsive d-none d-md-block">
              <table class="table table-hover align-middle">
                <thead class="table-light">
                  <tr>
                    <th>#</th>
                    <th>Picha</th>
                    <th>Kampuni</th>
                    <th>Jina</th>
                    <th>Rangi</th>
                    <th>Punguzo %</th>
                    <th>Aina</th>
                    <th>Ukubwa (EU)</th>
                    <th>Idadi</th>
                    <th>Bei (TSh)</th>
                    <th>Vitendo</th>
                  </tr>
                </thead>
                <tbody id="productsTableBody"></tbody>
              </table>
            </div>
            
            <!-- Mobile Cards View -->
            <div class="table-mobile-card" id="productsMobileCards"></div>
          </div>

          <!-- CUSTOMERS -->
          <div id="customers" class="section d-none">
            <div class="d-flex justify-content-between align-items-center mb-3 flex-column flex-md-row gap-2">
              <h5 class="section-title">Usimamizi wa Wateja</h5>
              <div class="d-flex flex-column flex-md-row gap-2 w-100 w-md-auto">
                <input type="text" id="customerSearch" placeholder="Tafuta wateja..." class="form-control" style="min-width: 200px;">
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalAddCustomer">
                  <i class="fa fa-plus me-1"></i>Ongeza Mteja
                </button>
              </div>
            </div>

            <div class="table-responsive d-none d-md-block">
              <table class="table table-striped align-middle">
                <thead class="table-light">
                  <tr>
                    <th>#</th>
                    <th>Jina la Kwanza</th>
                    <th>Jina la Mwisho</th>
                    <th>Simu</th>
                    <th>Barua Pepe</th>
                    <th>Jinsia</th>
                    <th>Vitendo</th>
                  </tr>
                </thead>
                <tbody id="customersTableBody"></tbody>
              </table>
            </div>
            
            <!-- Mobile Cards View -->
            <div class="table-mobile-card" id="customersMobileCards"></div>
          </div>

          <!-- ADS -->
          <div id="ads" class="section d-none">
            <div class="d-flex justify-content-between align-items-center mb-3 flex-column flex-md-row gap-2">
              <h5 class="section-title">Matangazo & Arifa</h5>
              <div class="d-flex flex-column flex-md-row gap-2">
                <button class="btn btn-primary me-2" data-bs-toggle="modal" data-bs-target="#modalAddAd">
                  <i class="fa fa-plus me-1"></i>Tangazo Jipya
                </button>
                <button class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#modalPostAnnouncement">
                  <i class="fa fa-bullhorn me-1"></i>Toa Arifa
                </button>
              </div>
            </div>

            <div class="row g-3" id="adsContainer"></div>
          </div>

          <!-- NOTIFICATIONS -->
          <div id="notifications" class="section d-none">
            <div class="d-flex justify-content-between align-items-center mb-3 flex-column flex-md-row gap-2">
              <h5 class="section-title">Arifa & Ujumbe</h5>
              <div>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalSendMessage">
                  <i class="fa fa-paper-plane me-1"></i>Tuma Ujumbe
                </button>
              </div>
            </div>

            <div class="card shadow-sm p-3">
              <h6 class="section-title">Ujumbe kutoka kwa Wateja</h6>
              <div id="messagesList" class="list-group mt-2"></div>
            </div>
          </div>

          <!-- ORDERS -->
          <div id="orders" class="section d-none">
            <div class="d-flex justify-content-between align-items-center mb-3 flex-column flex-md-row gap-2">
              <h5 class="section-title">Maagizo Yaliyowekwa</h5>
              <div>
                <button class="btn btn-outline-primary" id="refreshOrdersBtn">
                  <i class="fa fa-refresh me-1"></i>Pakia Upya
                </button>
              </div>
            </div>

            <div class="table-responsive d-none d-md-block">
              <table class="table table-hover align-middle">
                <thead class="table-light">
                  <tr>
                    <th>Namba ya Agizo</th>
                    <th>Mteja</th>
                    <th>Bidhaa</th>
                    <th>Jumla</th>
                    <th>Hali</th>
                    <th>Kitendo</th>
                  </tr>
                </thead>
                <tbody id="ordersTableBody"></tbody>
              </table>
            </div>
            
            <!-- Mobile Cards View -->
            <div class="table-mobile-card" id="ordersMobileCards"></div>
          </div>
        </section>
      </main>
    </div>
  </div>

  <!-- Modals -->
  <!-- Add/Edit Product Modal -->
  <div class="modal fade" id="modalAddProduct" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <form id="productForm">
          <div class="modal-header">
            <h5 class="modal-title">Ongeza / Hariri Bidhaa</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label">Jina la Bidhaa</label>
                <input class="form-control" id="prodTitle" required>
              </div>
              <div class="col-md-6">
                <label class="form-label">Kampuni</label>
                <select id="prodBrand" class="form-select">
                  <option value="">Chagua...</option>
                  <option>Nike</option>
                  <option>Adidas</option>
                  <option>AirZoom</option>
                  <option>Mercurial</option>
                </select>
              </div>

              <div class="col-md-4">
                <label class="form-label">Rangi</label>
                <select id="prodColor" class="form-select">
                  <option>Nyeusi</option>
                  <option>Nyeupe</option>
                  <option>Njano</option>
                  <option>Buluu</option>
                  <option>Kijani</option>
                  <option>Zambarau</option>
                </select>
              </div>
              <div class="col-md-4">
                <label class="form-label">Punguzo (%)</label>
                <input type="number" min="0" max="100" id="prodOffer" class="form-control" value="0">
              </div>
              <div class="col-md-4">
                <label class="form-label">Aina</label>
                <select id="prodType" class="form-select">
                  <option value="Njumu">Njumu</option>
                  <option value="Trainer">Trainer</option>
                  <option value="Njumu na Trainer">Njumu na Trainer</option>
                </select>
              </div>

              <div class="col-md-4">
                <label class="form-label">Ukubwa (EU)</label>
                <select id="prodSize" class="form-select">
                  <option>39</option>
                  <option>40</option>
                  <option>41</option>
                  <option>42</option>
                  <option>43</option>
                  <option>44</option>
                  <option>45</option>
                </select>
              </div>
              <div class="col-md-4">
                <label class="form-label">Idadi</label>
                <div class="input-group">
                  <button class="btn btn-outline-secondary" type="button" id="qtyMinus">-</button>
                  <input id="prodQuantity" class="form-control text-center" value="1" type="number" min="0">
                  <button class="btn btn-outline-secondary" type="button" id="qtyPlus">+</button>
                </div>
              </div>
              <div class="col-md-4">
                <label class="form-label">Bei (TSh)</label>
                <input type="number" id="prodPrice" class="form-control" required>
              </div>

              <div class="col-12">
                <label class="form-label">Picha (kiwango cha juu 5)</label>
                <input type="file" id="prodImages" class="form-control" accept="image/*" multiple>
                <div id="prodPreview" class="image-preview"></div>
              </div>

              <input type="hidden" id="editingProductId">
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Funga</button>
            <button type="submit" class="btn btn-primary">
              <span id="productBtnText">Hifadhi Bidhaa</span>
              <span id="productSpinner" class="spinner-border spinner-border-sm" style="display: none;"></span>
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Add Customer Modal -->
  <div class="modal fade" id="modalAddCustomer" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <form id="customerForm">
          <div class="modal-header">
            <h5 class="modal-title">Ongeza / Hariri Mteja</h5>
            <button class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <label class="form-label">Jina la Kwanza</label>
              <input id="custFname" class="form-control" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Jina la Mwisho</label>
              <input id="custLname" class="form-control" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Namba ya Simu</label>
              <input id="custMobile" class="form-control" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Barua pepe (hiari)</label>
              <input id="custEmail" class="form-control">
            </div>
            <div class="mb-3">
              <label class="form-label">Jinsia</label>
              <select id="custGender" class="form-select" required>
                <option value="">Chagua...</option>
                <option value="mwanaume">Mwanaume</option>
                <option value="mwanamke">Mwanamke</option>
                <option value="nyengine">Nyengine</option>
              </select>
            </div>
            <input type="hidden" id="editingCustomerId">
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" data-bs-dismiss="modal">Funga</button>
            <button class="btn btn-primary" type="submit">
              <span id="customerBtnText">Hifadhi</span>
              <span id="customerSpinner" class="spinner-border spinner-border-sm" style="display: none;"></span>
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Add Ad Modal -->
  <div class="modal fade" id="modalAddAd" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <form id="adForm">
          <div class="modal-header">
            <h5 class="modal-title">Chapisha Tangazo Jipya</h5>
            <button class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <label class="form-label">Picha ya Tangazo</label>
              <input type="file" id="adImage" class="form-control" accept="image/*" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Kiungo (hiari)</label>
              <input id="adLink" class="form-control" placeholder="https://">
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" data-bs-dismiss="modal">Funga</button>
            <button class="btn btn-primary" type="submit">
              <span id="adBtnText">Chapisha Tangazo</span>
              <span id="adSpinner" class="spinner-border spinner-border-sm" style="display: none;"></span>
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Post Announcement Modal -->
  <div class="modal fade" id="modalPostAnnouncement" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <form id="announcementForm">
          <div class="modal-header">
            <h5 class="modal-title">Toa Arifa</h5>
            <button class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <label class="form-label">Arifa</label>
              <textarea id="announcementText" class="form-control" rows="4" required></textarea>
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" data-bs-dismiss="modal">Funga</button>
            <button class="btn btn-primary" type="submit">
              <span id="announcementBtnText">Toa</span>
              <span id="announcementSpinner" class="spinner-border spinner-border-sm" style="display: none;"></span>
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Send Message Modal -->
  <div class="modal fade" id="modalSendMessage" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <form id="sendMessageForm">
          <div class="modal-header">
            <h5 class="modal-title">Tuma Ujumbe / Barua Pepe kwa Mteja</h5>
            <button class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <label class="form-label">Chagua Mteja (hiari) - acha wazi kutuma kwa wote</label>
              <select id="selectCustomerMsg" class="form-select">
                <option value="">Tuma kwa wote</option>
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label">Ujumbe</label>
              <textarea id="msgBody" class="form-control" rows="4" required></textarea>
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" data-bs-dismiss="modal">Funga</button>
            <button class="btn btn-primary" type="submit">
              <span id="messageBtnText">Tuma</span>
              <span id="messageSpinner" class="spinner-border spinner-border-sm" style="display: none;"></span>
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Order OTP Modal -->
  <div class="modal fade" id="modalConfirmOTP" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Thibitisha Agizo Limepokelewa (ingiza OTP)</h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Namba ya Agizo</label>
            <input id="otpOrderId" class="form-control" readonly>
          </div>
          <div class="mb-3">
            <label class="form-label">Ingiza OTP</label>
            <input id="otpInput" class="form-control" placeholder="Ingiza OTP">
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Ghairi</button>
          <button class="btn btn-success" id="confirmOtpBtn">
            <span id="otpBtnText">Thibitisha</span>
            <span id="otpSpinner" class="spinner-border spinner-border-sm" style="display: none;"></span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // API Configuration
    const API_BASE_URL = 'https://fourbrotherssportscenter-backend.onrender.com/api/admin';
    let authToken = localStorage.getItem('adminToken') || '';
    
    // Check if already logged in
    if (authToken) {
      document.getElementById('loginPage').style.display = 'none';
      document.getElementById('adminPanel').style.display = 'block';
      loadDashboardData();
    }

    // API Helper Functions
    async function apiCall(endpoint, options = {}) {
      const url = `${API_BASE_URL}${endpoint}`;
      
      const config = {
        headers: {
          'Content-Type': 'application/json',
          ...options.headers
        },
        ...options
      };
      
      // Add auth token if available
      if (authToken) {
        config.headers.Authorization = `Bearer ${authToken}`;
      }
      
      try {
        const response = await fetch(url, config);
        const data = await response.json();
        
        if (!response.ok) {
          throw new Error(data.message || `HTTP error! status: ${response.status}`);
        }
        
        return data;
      } catch (error) {
        console.error('API Error:', error);
        showAlert(error.message, 'danger');
        throw error;
      }
    }

    async function apiCallWithFormData(endpoint, formData, method = 'POST') {
      const url = `${API_BASE_URL}${endpoint}`;
      
      const config = {
        method: method,
        headers: {
          'Authorization': `Bearer ${authToken}`
        },
        body: formData
      };
      
      try {
        const response = await fetch(url, config);
        const data = await response.json();
        
        if (!response.ok) {
          throw new Error(data.message || `HTTP error! status: ${response.status}`);
        }
        
        return data;
      } catch (error) {
        console.error('API Error:', error);
        showAlert(error.message, 'danger');
        throw error;
      }
    }

    // Alert Helper
    function showAlert(message, type = 'info') {
      const alertDiv = document.getElementById('apiAlert');
      alertDiv.textContent = message;
      alertDiv.className = `alert alert-${type}`;
      alertDiv.style.display = 'block';
      
      setTimeout(() => {
        alertDiv.style.display = 'none';
      }, 5000);
    }

    // Format price in TSh
    const formatPrice = (price) => {
      return 'TSh ' + Number(price).toLocaleString('en-TZ');
    };

    // ADMIN AUTHENTICATION
    document.getElementById('adminLoginForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const fname = document.getElementById('adminFname').value.trim();
      const lname = document.getElementById('adminLname').value.trim();
      
      if (!fname || !lname) {
        showLoginAlert('Tafadhali jaza jina la kwanza na la mwisho');
        return;
      }
      
      // Show loading state
      document.getElementById('loginBtnText').style.display = 'none';
      document.getElementById('loginSpinner').style.display = 'inline-block';
      
      try {
        const response = await apiCall('/login', {
          method: 'POST',
          body: JSON.stringify({ first_name: fname, last_name: lname })
        });
        
        // Show OTP section
        document.getElementById('adminLoginForm').style.display = 'none';
        document.getElementById('otpSection').style.display = 'block';
        hideLoginAlert();
        
      } catch (error) {
        showLoginAlert(error.message);
      } finally {
        document.getElementById('loginBtnText').style.display = 'inline-block';
        document.getElementById('loginSpinner').style.display = 'none';
      }
    });
    
    document.getElementById('verifyOtpBtn').addEventListener('click', async function() {
      const fname = document.getElementById('adminFname').value.trim();
      const lname = document.getElementById('adminLname').value.trim();
      const otp = document.getElementById('adminOtp').value.trim();
      
      if (otp.length !== 6) {
        showLoginAlert('Tafadhali ingiza OTP sahihi (tarakimu 6)');
        return;
      }
      
      // Show loading state
      document.getElementById('verifyBtnText').style.display = 'none';
      document.getElementById('verifySpinner').style.display = 'inline-block';
      
      try {
        const response = await apiCall('/verify-otp', {
          method: 'POST',
          body: JSON.stringify({ 
            first_name: fname, 
            last_name: lname, 
            otp: otp 
          })
        });
        
        // Login successful
        authToken = response.token;
        localStorage.setItem('adminToken', authToken);
        
        document.getElementById('loginPage').style.display = 'none';
        document.getElementById('adminPanel').style.display = 'block';
        document.getElementById('adminNameDisplay').textContent = fname + ' ' + lname;
        
        // Load dashboard data
        loadDashboardData();
        
      } catch (error) {
        showLoginAlert(error.message);
      } finally {
        document.getElementById('verifyBtnText').style.display = 'inline-block';
        document.getElementById('verifySpinner').style.display = 'none';
      }
    });
    
    function showLoginAlert(message) {
      const alertDiv = document.getElementById('loginAlert');
      alertDiv.textContent = message;
      alertDiv.style.display = 'block';
    }
    
    function hideLoginAlert() {
      document.getElementById('loginAlert').style.display = 'none';
    }
    
    document.getElementById('backToLoginBtn').addEventListener('click', function() {
      document.getElementById('otpSection').style.display = 'none';
      document.getElementById('adminLoginForm').style.display = 'block';
      hideLoginAlert();
    });

    // DASHBOARD DATA
    async function loadDashboardData() {
      try {
        const stats = await apiCall('/dashboard/stats');
        
        // Update dashboard stats
        document.getElementById('totalUsers').innerText = stats.total_customers || 0;
        document.getElementById('totalProducts').innerText = stats.total_products || 0;
        document.getElementById('totalIncome').innerText = formatPrice(stats.total_income || 0);
        document.getElementById('totalOrders').innerText = stats.total_ordered_products || 0;
        
        // Update income chart
        updateIncomeChart(stats.monthly_income || []);
        
        // Load other data
        await loadProducts();
        await loadCustomers();
        await loadAds();
        await loadOrders();
        await loadNotifications();
        
      } catch (error) {
        console.error('Error loading dashboard data:', error);
        // Set default values
        document.getElementById('totalUsers').innerText = 0;
        document.getElementById('totalProducts').innerText = 0;
        document.getElementById('totalIncome').innerText = formatPrice(0);
        document.getElementById('totalOrders').innerText = 0;
        updateIncomeChart([]);
      }
    }

    function updateIncomeChart(monthlyData) {
      const ctx = document.getElementById('incomeChart').getContext('2d');
      
      // Safely destroy existing chart if it exists and is a valid Chart instance
      if (window.incomeChart && typeof window.incomeChart.destroy === 'function') {
        window.incomeChart.destroy();
      }
      
      // Ensure we have valid data
      const months = monthlyData.map(item => item.month) || [];
      const income = monthlyData.map(item => item.income) || [];
      
      // If no data, create empty chart
      if (months.length === 0) {
        months.push('Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec');
        income.push(0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0);
      }
      
      try {
        window.incomeChart = new Chart(ctx, {
          type: 'line',
          data: {
            labels: months,
            datasets: [{
              label: 'Mapato (TSh)',
              data: income,
              fill: true,
              tension: 0.3,
              backgroundColor: 'rgba(13, 110, 253, 0.1)',
              borderColor: 'rgba(13, 110, 253, 1)',
              borderWidth: 2,
              pointBackgroundColor: 'rgba(13, 110, 253, 1)'
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false }
            },
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  callback: function(value) {
                    return 'TSh ' + value.toLocaleString('en-TZ');
                  }
                }
              }
            }
          }
        });
      } catch (error) {
        console.error('Error creating chart:', error);
        // Create a simple error message on the canvas
        ctx.fillStyle = '#f8f9fa';
        ctx.fillRect(0, 0, ctx.canvas.width, ctx.canvas.height);
        ctx.fillStyle = '#6c757d';
        ctx.textAlign = 'center';
        ctx.fillText('Chart could not be loaded', ctx.canvas.width / 2, ctx.canvas.height / 2);
      }
    }

    // ===============================
    // PRODUCTS MANAGEMENT
    // ===============================
    let products = [];

    // ===============================
    // HELPER: Get correct image URL
    // ===============================
    function fixImagePath(path) {
      if (!path) return '';
      // If URL starts with http(s), return as-is (Cloudinary or absolute URL)
      if (path.startsWith('http')) return path;
      // Otherwise, prepend local server URL
      return `http://localhost:5000/${path.replace(/^\//, '')}`;
    }

    // ===============================
    // LOAD PRODUCTS
    // ===============================
    async function loadProducts() {
      try {
        console.log('⏳ Loading products from API...');
        products = await apiCall('/products');
        console.log('✅ Products loaded:', products);

        renderProductsTable();
        renderProductsMobileCards();
      } catch (error) {
        console.error('❌ Error loading products:', error);
        products = [];
        renderProductsTable();
        renderProductsMobileCards();
      }
    }

    // ===============================
    // ADD / EDIT PRODUCT FORM SUBMIT
    // ===============================
    document.getElementById('productForm').addEventListener('submit', async function (e) {
      e.preventDefault();

      const productId = document.getElementById('editingProductId').value;
      const formData = new FormData();

      // Product fields
      formData.append('name', document.getElementById('prodTitle').value);
      formData.append('company', document.getElementById('prodBrand').value);
      formData.append('color', document.getElementById('prodColor').value);
      formData.append('discount_percent', document.getElementById('prodOffer').value);
      formData.append('type', document.getElementById('prodType').value);
      formData.append('size_us', document.getElementById('prodSize').value);
      formData.append('stock', document.getElementById('prodQuantity').value);
      formData.append('price', document.getElementById('prodPrice').value);

      // Images
      const imageFiles = document.getElementById('prodImages').files;
      for (let i = 0; i < imageFiles.length; i++) {
        formData.append('images', imageFiles[i]);
      }

      // Button loading state
      document.getElementById('productBtnText').style.display = 'none';
      document.getElementById('productSpinner').style.display = 'inline-block';

      try {
        if (productId) {
          await apiCallWithFormData(`/products/${productId}`, formData, 'PUT');
          showAlert('Bidhaa imesasishwa kikamilifu');
        } else {
          await apiCallWithFormData('/products', formData);
          showAlert('Bidhaa imeongezwa kikamilifu');
        }

        document.getElementById('productForm').reset();
        document.getElementById('prodPreview').innerHTML = '';
        document.getElementById('editingProductId').value = '';
        bootstrap.Modal.getInstance(document.getElementById('modalAddProduct')).hide();

        await loadProducts();
      } catch (error) {
        console.error('❌ Error saving product:', error);
      } finally {
        document.getElementById('productBtnText').style.display = 'inline-block';
        document.getElementById('productSpinner').style.display = 'none';
      }
    });

    // ===============================
    // RENDER TABLE
    // ===============================
    function renderProductsTable(filter = '') {
      const tbody = document.getElementById('productsTableBody');
      tbody.innerHTML = '';

      const productList = Array.isArray(products) ? products : [];
      const filteredProducts = productList.filter(p => {
        if (!p) return false;
        const search = (p.name + ' ' + (p.company || '') + ' ' + (p.color || '')).toLowerCase();
        return search.includes(filter.toLowerCase());
      });

      if (filteredProducts.length === 0) {
        tbody.innerHTML = `
          <tr><td colspan="11" class="text-center py-4 text-muted">
            ${productList.length === 0 ? 'Hakuna bidhaa zilizopatikana' : 'Hakuna bidhaa zilizoambatana na utafutaji'}
          </td></tr>`;
        return;
      }

      filteredProducts.forEach((product, index) => {
        const tr = document.createElement('tr');
        const imageUrl = product.images?.length > 0 ? fixImagePath(product.images[0]) : '';

        tr.innerHTML = `
          <td>${index + 1}</td>
          <td><img src="${imageUrl}" class="product-thumb" alt="${product.name}"
              onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA2MCA2MCIgZmlsbD0ibm9uZSI+PHJlY3Qgd2lkdGg9IjYwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjZjBmMGYwIi8+PHRleHQgeD0iMzAiIHk9IjMwIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTAiIGZpbGw9IiM5OTkiIHRleHQtYW5jaG9yPSJtaWRkbGUiPkVycm9yPC90ZXh0Pjwvc3ZnPg=='"></td>
          <td>${product.company || '-'}</td>
          <td>${product.name || 'No Name'}</td>
          <td>${product.color || '-'}</td>
          <td>${product.discount_percent || 0}%</td>
          <td>${product.type || '-'}</td>
          <td>${product.size_us || '-'}</td>
          <td>${product.stock || 0}</td>
          <td>${formatPrice(product.price || 0)}</td>
          <td>
            <button class="btn btn-sm btn-outline-primary me-1" onclick="editProduct('${product.id}')">Hariri</button>
            <button class="btn btn-sm btn-outline-danger" onclick="deleteProduct('${product.id}')">Futa</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    // ===============================
    // RENDER MOBILE CARDS
    // ===============================
    function renderProductsMobileCards(filter = '') {
      const container = document.getElementById('productsMobileCards');
      container.innerHTML = '';

      const productList = Array.isArray(products) ? products : [];
      const filteredProducts = productList.filter(p => {
        if (!p) return false;
        const search = (p.name + ' ' + (p.company || '') + ' ' + (p.color || '')).toLowerCase();
        return search.includes(filter.toLowerCase());
      });

      if (filteredProducts.length === 0) {
        container.innerHTML = `<div class="text-center py-4 text-muted">
          ${productList.length === 0 ? 'Hakuna bidhaa zilizopatikana' : 'Hakuna bidhaa zilizoambatana na utafutaji'}
        </div>`;
        return;
      }

      filteredProducts.forEach(product => {
        const imageUrl = product.images?.length > 0 ? fixImagePath(product.images[0]) : '';

        const card = document.createElement('div');
        card.className = 'mobile-card';
        card.innerHTML = `
          <div class="mobile-card-row">
            <div class="mobile-card-label">Picha</div>
            <div class="mobile-card-value">
              <img src="${imageUrl}" style="width:50px;height:50px;object-fit:cover;border-radius:5px;"
                  alt="${product.name}"
                  onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA2MCA2MCI+PHJlY3Qgd2lkdGg9IjYwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjZjBmMGYwIi8+PHRleHQgeD0iMzAiIHk9IjMwIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTAiIGZpbGw9IiM5OTkiIHRleHQtYW5jaG9yPSJtaWRkbGUiPkVycm9yPC90ZXh0Pjwvc3ZnPg=='">
            </div>
          </div>
          <div class="mobile-card-row"><div class="mobile-card-label">Kampuni</div><div class="mobile-card-value">${product.company || '-'}</div></div>
          <div class="mobile-card-row"><div class="mobile-card-label">Jina</div><div class="mobile-card-value">${product.name || '-'}</div></div>
          <div class="mobile-card-row"><div class="mobile-card-label">Rangi</div><div class="mobile-card-value">${product.color || '-'}</div></div>
          <div class="mobile-card-row"><div class="mobile-card-label">Punguzo</div><div class="mobile-card-value">${product.discount_percent || 0}%</div></div>
          <div class="mobile-card-row"><div class="mobile-card-label">Aina</div><div class="mobile-card-value">${product.type || '-'}</div></div>
          <div class="mobile-card-row"><div class="mobile-card-label">Ukubwa (EU)</div><div class="mobile-card-value">${product.size_us || '-'}</div></div>
          <div class="mobile-card-row"><div class="mobile-card-label">Idadi</div><div class="mobile-card-value">${product.stock || 0}</div></div>
          <div class="mobile-card-row"><div class="mobile-card-label">Bei</div><div class="mobile-card-value">${formatPrice(product.price || 0)}</div></div>
          <div class="mobile-card-row">
            <div class="mobile-card-label">Vitendo</div>
            <div class="mobile-card-value">
              <button class="btn btn-sm btn-outline-primary me-1" onclick="editProduct('${product.id}')">Hariri</button>
              <button class="btn btn-sm btn-outline-danger" onclick="deleteProduct('${product.id}')">Futa</button>
            </div>
          </div>
        `;
        container.appendChild(card);
      });
    }

    // ===============================
    // EDIT PRODUCT
    // ===============================
    async function editProduct(id) {
      const product = products.find(p => p.id == id);
      if (!product) return;

      document.getElementById('editingProductId').value = product.id;
      document.getElementById('prodTitle').value = product.name;
      document.getElementById('prodBrand').value = product.company;
      document.getElementById('prodColor').value = product.color;
      document.getElementById('prodOffer').value = product.discount_percent;
      document.getElementById('prodType').value = product.type;
      document.getElementById('prodSize').value = product.size_us;
      document.getElementById('prodQuantity').value = product.stock;
      document.getElementById('prodPrice').value = product.price;

      // Existing images preview
      const preview = document.getElementById('prodPreview');
      preview.innerHTML = '';

      if (product.images?.length > 0) {
        product.images.forEach(imgPath => {
          const img = document.createElement('img');
          img.src = fixImagePath(imgPath);
          img.onerror = function () {
            this.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iODAiIHZpZXdCb3g9IjAgMCA4MCA4MCI+PHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjgwIiBmaWxsPSIjZjBmMGYwIi8+PHRleHQgeD0iNDAiIHk9IjQwIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTIiIGZpbGw9IiM5OTkiIHRleHQtYW5jaG9yPSJtaWRkbGUiPkVycm9yPC90ZXh0Pjwvc3ZnPg==';
          };
          preview.appendChild(img);
        });
      }

      new bootstrap.Modal(document.getElementById('modalAddProduct')).show();
    }

    // ===============================
    // DELETE PRODUCT
    // ===============================
    async function deleteProduct(id) {
      if (!confirm('Una uhakika unataka kufuta bidhaa hii?')) return;

      try {
        await apiCall(`/products/${id}`, { method: 'DELETE' });
        showAlert('Bidhaa imefutwa kikamilifu');
        await loadProducts();
      } catch (error) {
        console.error('❌ Error deleting product:', error);
      }
    }

    // ===============================
    // IMAGE PREVIEW
    // ===============================
    document.getElementById('prodImages').addEventListener('change', function () {
      const preview = document.getElementById('prodPreview');

      if (!document.getElementById('editingProductId').value) {
        preview.innerHTML = '';
      }

      const files = this.files;
      if (files.length > 5) {
        alert('Ruhusiwa picha 5 pekee');
        this.value = '';
        return;
      }

      Array.from(files).forEach(file => {
        const fr = new FileReader();
        fr.onload = () => {
          const img = document.createElement('img');
          img.src = fr.result;
          preview.appendChild(img);
        };
        fr.readAsDataURL(file);
      });
    });

    // ===============================
    // QUANTITY BUTTONS
    // ===============================
    document.getElementById('qtyMinus').addEventListener('click', () => {
      const qty = document.getElementById('prodQuantity');
      qty.value = Math.max(0, Number(qty.value) - 1);
    });

    document.getElementById('qtyPlus').addEventListener('click', () => {
      const qty = document.getElementById('prodQuantity');
      qty.value = Number(qty.value) + 1;
    });

    // CUSTOMERS MANAGEMENT
    let customers = [];

    async function loadCustomers() {
      try {
        customers = await apiCall('/customers');
        renderCustomersTable();
        renderCustomersMobileCards();
        populateCustomerSelects();
      } catch (error) {
        console.error('Error loading customers:', error);
      }
    }

    document.getElementById('customerForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const customerId = document.getElementById('editingCustomerId').value;
      const customerData = {
        first_name: document.getElementById('custFname').value,
        last_name: document.getElementById('custLname').value,
        phone: document.getElementById('custMobile').value,
        email: document.getElementById('custEmail').value || null,
        gender: document.getElementById('custGender').value
      };
      
      // Show loading state
      document.getElementById('customerBtnText').style.display = 'none';
      document.getElementById('customerSpinner').style.display = 'inline-block';
      
      try {
        if (customerId) {
          // Update existing customer
          await apiCall(`/customers/${customerId}`, {
            method: 'PUT',
            body: JSON.stringify(customerData)
          });
          showAlert('Mteja amesasishwa kikamilifu');
        } else {
          // Add new customer
          await apiCall('/customers', {
            method: 'POST',
            body: JSON.stringify(customerData)
          });
          showAlert('Mteja ameongezwa kikamilifu');
        }
        
        // Reset form and close modal
        document.getElementById('customerForm').reset();
        document.getElementById('editingCustomerId').value = '';
        bootstrap.Modal.getInstance(document.getElementById('modalAddCustomer')).hide();
        
        // Reload customers
        await loadCustomers();
        
      } catch (error) {
        console.error('Error saving customer:', error);
      } finally {
        document.getElementById('customerBtnText').style.display = 'inline-block';
        document.getElementById('customerSpinner').style.display = 'none';
      }
    });

    function renderCustomersTable(filter = '') {
      const tbody = document.getElementById('customersTableBody');
      tbody.innerHTML = '';
      
      const filteredCustomers = customers.filter(c => 
        (c.first_name + c.last_name + c.phone + (c.email || '')).toLowerCase().includes(filter.toLowerCase())
      );
      
      if (filteredCustomers.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center py-4 text-muted">Hakuna wateja waliopatikana</td></tr>';
        return;
      }
      
      filteredCustomers.forEach((customer, index) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${index + 1}</td>
          <td>${customer.first_name}</td>
          <td>${customer.last_name}</td>
          <td>${customer.phone}</td>
          <td>${customer.email || '-'}</td>
          <td>${customer.gender}</td>
          <td>
            <button class="btn btn-sm btn-outline-primary me-1" onclick="editCustomer('${customer.id}')">Hariri</button>
            <button class="btn btn-sm btn-outline-danger" onclick="deleteCustomer('${customer.id}')">Futa</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    // Render mobile cards for customers
    function renderCustomersMobileCards(filter = '') {
      const container = document.getElementById('customersMobileCards');
      container.innerHTML = '';
      
      const filteredCustomers = customers.filter(c => 
        (c.first_name + c.last_name + c.phone + (c.email || '')).toLowerCase().includes(filter.toLowerCase())
      );
      
      if (filteredCustomers.length === 0) {
        container.innerHTML = '<div class="text-center py-4 text-muted">Hakuna wateja waliopatikana</div>';
        return;
      }
      
      filteredCustomers.forEach((customer, index) => {
        const card = document.createElement('div');
        card.className = 'mobile-card';
        card.innerHTML = `
          <div class="mobile-card-row">
            <div class="mobile-card-label">#</div>
            <div class="mobile-card-value">${index + 1}</div>
          </div>
          <div class="mobile-card-row">
            <div class="mobile-card-label">Jina la Kwanza</div>
            <div class="mobile-card-value">${customer.first_name}</div>
          </div>
          <div class="mobile-card-row">
            <div class="mobile-card-label">Jina la Mwisho</div>
            <div class="mobile-card-value">${customer.last_name}</div>
          </div>
          <div class="mobile-card-row">
            <div class="mobile-card-label">Simu</div>
            <div class="mobile-card-value">${customer.phone}</div>
          </div>
          <div class="mobile-card-row">
            <div class="mobile-card-label">Barua Pepe</div>
            <div class="mobile-card-value">${customer.email || '-'}</div>
          </div>
          <div class="mobile-card-row">
            <div class="mobile-card-label">Jinsia</div>
            <div class="mobile-card-value">${customer.gender}</div>
          </div>
          <div class="mobile-card-row">
            <div class="mobile-card-label">Vitendo</div>
            <div class="mobile-card-value">
              <button class="btn btn-sm btn-outline-primary me-1" onclick="editCustomer('${customer.id}')">Hariri</button>
              <button class="btn btn-sm btn-outline-danger" onclick="deleteCustomer('${customer.id}')">Futa</button>
            </div>
          </div>
        `;
        container.appendChild(card);
      });
    }

    async function editCustomer(id) {
      const customer = customers.find(c => c.id == id);
      if (!customer) return;
      
      document.getElementById('editingCustomerId').value = customer.id;
      document.getElementById('custFname').value = customer.first_name;
      document.getElementById('custLname').value = customer.last_name;
      document.getElementById('custMobile').value = customer.phone;
      document.getElementById('custEmail').value = customer.email || '';
      document.getElementById('custGender').value = customer.gender;
      
      const modal = new bootstrap.Modal(document.getElementById('modalAddCustomer'));
      modal.show();
    }

    async function deleteCustomer(id) {
      if (!confirm('Una uhakika unataka kufuta mteja huyu?')) return;
      
      try {
        await apiCall(`/customers/${id}`, { method: 'DELETE' });
        showAlert('Mteja amefutwa kikamilifu');
        await loadCustomers();
      } catch (error) {
        console.error('Error deleting customer:', error);
      }
    }

    function populateCustomerSelects() {
      const select = document.getElementById('selectCustomerMsg');
      select.innerHTML = '<option value="">Tuma kwa wote</option>';
      
      customers.forEach(customer => {
        const option = document.createElement('option');
        option.value = customer.id;
        option.textContent = `${customer.first_name} ${customer.last_name} (${customer.phone})`;
        select.appendChild(option);
      });
    }

    // ADS MANAGEMENT
    let ads = [];

    // Load Ads
    async function loadAds() {
      try {
        ads = await apiCall('/ads');
        renderAds();
      } catch (error) {
        console.error('Error loading ads:', error);
        ads = [];
        renderAds();
      }
    }

    // Submit Ad Form
    document.getElementById('adForm').addEventListener('submit', async function (e) {
      e.preventDefault();

      const formData = new FormData();
      const imageFile = document.getElementById('adImage').files[0];
      const link = document.getElementById('adLink').value;

      if (!imageFile) {
        showAlert('Tafadhali chagua picha ya tangazo');
        return;
      }

      formData.append('image', imageFile);
      if (link) formData.append('link', link);

      // Show loading
      document.getElementById('adBtnText').style.display = 'none';
      document.getElementById('adSpinner').style.display = 'inline-block';

      try {
        await apiCallWithFormData('/ads', formData);
        showAlert('Tangazo limechapishwa kikamilifu');

        document.getElementById('adForm').reset();
        bootstrap.Modal.getInstance(document.getElementById('modalAddAd')).hide();

        await loadAds();
      } catch (error) {
        console.error('Error posting ad:', error);
        showAlert('Hitilafu katika kuchapisha tangazo', 'danger');
      } finally {
        document.getElementById('adBtnText').style.display = 'inline-block';
        document.getElementById('adSpinner').style.display = 'none';
      }
    });

    // Render Ads
    function renderAds() {
      const container = document.getElementById('adsContainer');
      container.innerHTML = '';

      if (ads.length === 0) {
        container.innerHTML = `
          <div class="col-12 text-center py-4 text-muted">
            Hakuna matangazo yaliyopo
          </div>`;
        return;
      }

      ads.forEach(ad => {
        const col = document.createElement('div');
        col.className = 'col-md-6 col-lg-4 mb-3';

        col.innerHTML = `
          <div class="card shadow-sm h-100">
            <div class="card-img-top-container" style="height: 200px; overflow: hidden;">
              <img src="${ad.image_url}"
                  class="card-img-top h-100 w-100"
                  style="object-fit: cover;"
                  alt="Tangazo"
                  onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAwIiBoZWlnaHQ9IjIwMCIgdmlld0JveD0iMCAwIDQwMCAyMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSI0MDAiIGhlaWdodD0iMjAwIiBmaWxsPSIjZjBmMGYwIi8+Cjx0ZXh0IHg9IjIwMCIgeT0iMTAwIiBmb250LWZhbWlseT0iQXJpYWwsIHNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGZpbGw9IiM5OTkiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIuM2VtIj5FcnJvcjwvdGV4dD4KPC9zdmc+'">
            </div>

            <div class="card-body d-flex flex-column">
              <div class="mt-auto">
                <div class="d-flex justify-content-between align-items-center">

                  ${ad.link
                    ? `<a href="${ad.link}" target="_blank"
                        class="btn btn-sm btn-outline-primary">
                        <i class="fa fa-external-link-alt me-1"></i>Tembelea
                      </a>`
                    : `<span class="text-muted small">Hakuna kiungo</span>`}

                  <button class="btn btn-sm btn-danger" onclick="deleteAd('${ad.id}')">
                    <i class="fa fa-trash me-1"></i>Futa
                  </button>
                </div>

                <small class="text-muted d-block mt-2">
                  Imeundwa: ${new Date(ad.created_at).toLocaleDateString('sw-TZ')}
                </small>
              </div>
            </div>
          </div>
        `;

        container.appendChild(col);
      });
    }

    // Delete Ad
    async function deleteAd(id) {
      if (!confirm('Una uhakika unataka kufuta tangazo hili?')) return;

      try {
        await apiCall(`/ads/${id}`, { method: 'DELETE' });
        showAlert('Tangazo limefutwa kikamilifu');
        await loadAds();
      } catch (error) {
        console.error('Error deleting ad:', error);
        showAlert('Hitilafu katika kufuta tangazo', 'danger');
      }
    }


    // ANNOUNCEMENTS
    document.getElementById('announcementForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const content = document.getElementById('announcementText').value;
      if (!content) {
        showAlert('Tafadhali andika maudhui ya arifa');
        return;
      }
      
      // Show loading state
      document.getElementById('announcementBtnText').style.display = 'none';
      document.getElementById('announcementSpinner').style.display = 'inline-block';
      
      try {
        await apiCall('/messages', {
          method: 'POST',
          body: JSON.stringify({ content })
        });
        
        showAlert('Arifa imetumwa kikamilifu');
        document.getElementById('announcementForm').reset();
        bootstrap.Modal.getInstance(document.getElementById('modalPostAnnouncement')).hide();
        
      } catch (error) {
        console.error('Error posting announcement:', error);
      } finally {
        document.getElementById('announcementBtnText').style.display = 'inline-block';
        document.getElementById('announcementSpinner').style.display = 'none';
      }
    });

    // MESSAGING
    document.getElementById('sendMessageForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const customerId = document.getElementById('selectCustomerMsg').value;
      const content = document.getElementById('msgBody').value;
      
      if (!content) {
        showAlert('Tafadhali andika ujumbe');
        return;
      }
      
      // Show loading state
      document.getElementById('messageBtnText').style.display = 'none';
      document.getElementById('messageSpinner').style.display = 'inline-block';
      
      try {
        const requestBody = { content };
        if (customerId) {
          requestBody.customer_ids = [customerId];
        }
        
        await apiCall('/notifications/send', {
          method: 'POST',
          body: JSON.stringify(requestBody)
        });
        
        showAlert('Ujumbe umetumwa kikamilifu');
        document.getElementById('sendMessageForm').reset();
        bootstrap.Modal.getInstance(document.getElementById('modalSendMessage')).hide();
        
      } catch (error) {
        console.error('Error sending message:', error);
      } finally {
        document.getElementById('messageBtnText').style.display = 'inline-block';
        document.getElementById('messageSpinner').style.display = 'none';
      }
    });

    // NOTIFICATIONS
    let notifications = [];

    async function loadNotifications() {
      try {
        notifications = await apiCall('/notifications/customer');
        renderNotifications();
      } catch (error) {
        console.error('Error loading notifications:', error);
      }
    }

    function renderNotifications() {
      const list = document.getElementById('messagesList');
      list.innerHTML = '';
      
      if (notifications.length === 0) {
        list.innerHTML = '<div class="text-center py-4 text-muted">Hakuna ujumbe uliopokelewa</div>';
        return;
      }
      
      notifications.forEach(notification => {
        const el = document.createElement('div');
        el.className = 'list-group-item d-flex justify-content-between align-items-start';
        el.innerHTML = `
          <div class="flex-grow-1">
            <div class="d-flex justify-content-between">
              <strong>${notification.first_name} ${notification.last_name}</strong>
              <small class="text-muted">${new Date(notification.created_at).toLocaleDateString('sw-TZ')}</small>
            </div>
            <div class="text-muted small mt-1">${notification.message}</div>
          </div>
          <div class="ms-3">
            <button class="btn btn-sm btn-outline-primary" onclick="replyToCustomer('${notification.id}')">Jibu</button>
          </div>
        `;
        list.appendChild(el);
      });
    }

    function replyToCustomer(notificationId) {
      const notification = notifications.find(n => n.id == notificationId);
      if (!notification) return;
      
      document.getElementById('selectCustomerMsg').value = notification.customer_id || '';
      document.getElementById('msgBody').value = `Jibu kwa ${notification.first_name}:\n\n`;
      
      const modal = new bootstrap.Modal(document.getElementById('modalSendMessage'));
      modal.show();
    }

    // ---------------- ORDERS MANAGEMENT ----------------
    let orders = [];

    // Load all orders
    async function loadOrders() {
      try {
        orders = await apiCall('/orders');
        renderOrders();
        renderOrdersMobileCards();
        renderRecentOrders();
      } catch (error) {
        console.error('Error loading orders:', error);
      }
    }

    // Render orders table
    function renderOrders() {
      const tbody = document.getElementById('ordersTableBody');
      tbody.innerHTML = '';

      if (orders.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-muted">Hakuna maagizo yaliyopatikana</td></tr>';
        return;
      }

      orders.forEach(order => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${order.order_id}</td>
          <td>${order.first_name} ${order.last_name}</td>
          <td>${order.product_name}</td>
          <td>${formatPrice(order.total_price)}</td>
          <td id="status_${order.order_id}">
            <span class="status-badge status-${order.status}">${order.status}</span>
          </td>
          <td>
            <div class="status-control-group">
              <button class="btn btn-sm btn-outline-secondary" onclick="updateOrderStatus('${order.order_id}','Imewekwa')">Imewekwa</button>
              <button class="btn btn-sm btn-outline-warning" onclick="updateOrderStatus('${order.order_id}','Inasafirishwa')">Inasafirishwa</button>
              <button class="btn btn-sm btn-outline-danger" onclick="updateOrderStatus('${order.order_id}','Ghairishwa')">Imeghairishwa</button>
              <button class="btn btn-sm btn-info" onclick="updateOrderStatus('${order.order_id}','Kurudishwa')">Kurudishwa</button>
              <button class="btn btn-sm btn-success" onclick="markAsReceived('${order.order_id}')">Imepokelewa</button>
            </div>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    // Render mobile cards for orders
    function renderOrdersMobileCards() {
      const container = document.getElementById('ordersMobileCards');
      container.innerHTML = '';

      if (orders.length === 0) {
        container.innerHTML = '<div class="text-center py-4 text-muted">Hakuna maagizo yaliyopatikana</div>';
        return;
      }

      orders.forEach(order => {
        const card = document.createElement('div');
        card.className = 'mobile-card';
        card.innerHTML = `
          <div class="mobile-card-row">
            <div class="mobile-card-label">Namba ya Agizo</div>
            <div class="mobile-card-value">${order.order_id}</div>
          </div>
          <div class="mobile-card-row">
            <div class="mobile-card-label">Mteja</div>
            <div class="mobile-card-value">${order.first_name} ${order.last_name}</div>
          </div>
          <div class="mobile-card-row">
            <div class="mobile-card-label">Bidhaa</div>
            <div class="mobile-card-value">${order.product_name}</div>
          </div>
          <div class="mobile-card-row">
            <div class="mobile-card-label">Jumla</div>
            <div class="mobile-card-value">${formatPrice(order.total_price)}</div>
          </div>
          <div class="mobile-card-row">
            <div class="mobile-card-label">Hali</div>
            <div class="mobile-card-value">
              <span class="status-badge status-${order.status}">${order.status}</span>
            </div>
          </div>
          <div class="mobile-card-row">
            <div class="mobile-card-label">Kitendo</div>
            <div class="mobile-card-value">
              <div class="status-control-group">
                <button class="btn btn-sm btn-outline-secondary" onclick="updateOrderStatus('${order.order_id}','Imewekwa')">Imewekwa</button>
                <button class="btn btn-sm btn-outline-warning" onclick="updateOrderStatus('${order.order_id}','Inasafirishwa')">Inasafirishwa</button>
                <button class="btn btn-sm btn-outline-danger" onclick="updateOrderStatus('${order.order_id}','Ghairishwa')">Imeghairishwa</button>
                <button class="btn btn-sm btn-info" onclick="updateOrderStatus('${order.order_id}','Kurudishwa')">Kurudishwa</button>
                <button class="btn btn-sm btn-success" onclick="markAsReceived('${order.order_id}')">Imepokelewa</button>
              </div>
            </div>
          </div>
        `;
        container.appendChild(card);
      });
    }

    // Render recent orders sidebar
    function renderRecentOrders() {
      const container = document.getElementById('recentOrders');
      const recent = orders.slice(0, 3);

      if (recent.length === 0) {
        container.innerHTML = '<div class="text-center py-3 text-muted">Hakuna maagizo ya hivi karibuni</div>';
        return;
      }

      container.innerHTML = '';
      recent.forEach(order => {
        const div = document.createElement('div');
        div.className = 'd-flex justify-content-between align-items-center border-bottom py-2';
        div.innerHTML = `
          <div>
            <div class="fw-bold small">${order.order_id}</div>
            <div class="text-muted small">${order.first_name} ${order.last_name}</div>
          </div>
          <div class="text-end">
            <div class="fw-bold">${formatPrice(order.total_price)}</div>
            <span class="status-badge status-${order.status}">${order.status}</span>
          </div>
        `;
        container.appendChild(div);
      });
    }

    // Update normal statuses
    async function updateOrderStatus(orderId, status) {
      try {
        const response = await apiCall(`/orders/${orderId}/status`, {
          method: 'PUT',
          body: JSON.stringify({ status })
        });

        showAlert(`Hali ya agizo imesasishwa kuwa: ${status}`);

        const statusElement = document.getElementById(`status_${orderId}`);
        if (statusElement) {
          statusElement.innerHTML = `<span class="status-badge status-${status}">${status}</span>`;
        }

        await loadOrders();
        return response;
      } catch (error) {
        console.error('Error updating order status:', error);
        showAlert(error?.message || 'Tatizo kuthibitisha hali ya agizo');
        throw error;
      }
    }

    // Generate OTP and open modal (Imepokelewa flow)
    async function markAsReceived(orderId) {
      try {
        const data = await apiCall(`/orders/${orderId}/generate-otp`, { method: 'POST' });

        console.log(`OTP for order ${orderId}:`, data.otp); // optional debug

        openOtpModal(orderId);
      } catch (err) {
        console.error('Error generating OTP:', err);
        showAlert(err?.message || 'Tatizo kuunda OTP, jaribu tena');
      }
    }

    // Open OTP modal
    function openOtpModal(orderId) {
      document.getElementById('otpOrderId').value = orderId;
      document.getElementById('otpInput').value = '';
      new bootstrap.Modal(document.getElementById('modalConfirmOTP')).show();
    }

    // Confirm OTP
    document.getElementById('confirmOtpBtn').addEventListener('click', async function() {
      const orderId = document.getElementById('otpOrderId').value;
      const otp = document.getElementById('otpInput').value.trim();

      if (!otp) {
        showAlert('Tafadhali ingiza OTP');
        return;
      }

      document.getElementById('otpBtnText').style.display = 'none';
      document.getElementById('otpSpinner').style.display = 'inline-block';

      try {
        await apiCall(`/orders/${orderId}/confirm`, {
          method: 'POST',
          body: JSON.stringify({ otp })
        });

        showAlert('Umepokea agizo kikamilifu');

        bootstrap.Modal.getInstance(document.getElementById('modalConfirmOTP')).hide();

        const statusElement = document.getElementById(`status_${orderId}`);
        if (statusElement) {
          statusElement.innerHTML = `<span class="status-badge status-Imepokelewa">Imepokelewa</span>`;
        }

        await loadOrders();
      } catch (error) {
        console.error('Error confirming order:', error);
        showAlert(error?.message || 'OTP si sahihi, jaribu tena');
      } finally {
        document.getElementById('otpBtnText').style.display = 'inline-block';
        document.getElementById('otpSpinner').style.display = 'none';
      }
    });

    // SEARCH FUNCTIONALITY
    document.getElementById('productSearch').addEventListener('input', (e) => {
      renderProductsTable(e.target.value);
      renderProductsMobileCards(e.target.value);
    });
    
    document.getElementById('customerSearch').addEventListener('input', (e) => {
      renderCustomersTable(e.target.value);
      renderCustomersMobileCards(e.target.value);
    });

    // SIDEBAR NAVIGATION
    document.querySelectorAll('.nav-link').forEach(link => {
      link.addEventListener('click', function(e) {
        e.preventDefault();
        
        console.log('📍 Navigation clicked:', this.getAttribute('data-section'));
        
        // Update active link
        document.querySelectorAll('.nav-link').forEach(x => x.classList.remove('active'));
        this.classList.add('active');
        
        // Show corresponding section
        const sectionId = this.getAttribute('data-section');
        document.querySelectorAll('.section').forEach(s => s.classList.add('d-none'));
        const targetSection = document.getElementById(sectionId);
        targetSection.classList.remove('d-none');
        
        console.log('🎯 Showing section:', sectionId);
        
        // Update section title
        const titleMap = {
          dashboard: 'Dashibodi ya Msimamizi',
          products: 'Usimamizi wa Bidhaa',
          customers: 'Usimamizi wa Wateja',
          ads: 'Matangazo & Arifa',
          notifications: 'Arifa & Ujumbe',
          orders: 'Maagizo Yaliyowekwa'
        };
        document.getElementById('sectionTitle').textContent = titleMap[sectionId] || 'Dashibodi ya Msimamizi';
        document.getElementById('mobileSectionTitle').textContent = titleMap[sectionId] || 'Dashibodi';
        
        // Load data when switching to specific sections
        if (sectionId === 'products') {
          console.log('🔄 Loading products data...');
          loadProducts();
        } else if (sectionId === 'customers') {
          loadCustomers();
        } else if (sectionId === 'orders') {
          loadOrders();
        } else if (sectionId === 'ads') {
          loadAds();
        } else if (sectionId === 'notifications') {
          loadNotifications();
        }
        
        // Close sidebar on mobile after navigation
        if (window.innerWidth < 992) {
          document.getElementById('sidebar').classList.remove('show');
          document.getElementById('sidebarOverlay').classList.remove('show');
        }
        
        window.scrollTo(0, 0);
      });
    });

    // QUICK ACTION BUTTONS
    document.getElementById('quickAddProductBtn').addEventListener('click', () => {
      document.getElementById('editingProductId').value = '';
      document.getElementById('productForm').reset();
      document.getElementById('prodPreview').innerHTML = '';
      new bootstrap.Modal(document.getElementById('modalAddProduct')).show();
    });
    
    document.getElementById('quickAddCustomerBtn').addEventListener('click', () => {
      document.getElementById('editingCustomerId').value = '';
      document.getElementById('customerForm').reset();
      new bootstrap.Modal(document.getElementById('modalAddCustomer')).show();
    });
    
    document.getElementById('quickAddAdBtn').addEventListener('click', () => {
      new bootstrap.Modal(document.getElementById('modalAddAd')).show();
    });

    // SIDEBAR TOGGLE FOR MOBILE
    document.getElementById('toggleSidebar').addEventListener('click', () => {
      document.getElementById('sidebar').classList.toggle('show');
    });
    
    document.getElementById('toggleSidebarMobile').addEventListener('click', () => {
      document.getElementById('sidebar').classList.add('show');
      document.getElementById('sidebarOverlay').classList.add('show');
    });
    
    document.getElementById('sidebarOverlay').addEventListener('click', () => {
      document.getElementById('sidebar').classList.remove('show');
      document.getElementById('sidebarOverlay').classList.remove('show');
    });

    // Close sidebar when clicking on a link in mobile view
    document.querySelectorAll('.nav-link').forEach(link => {
      link.addEventListener('click', () => {
        if (window.innerWidth < 992) {
          document.getElementById('sidebar').classList.remove('show');
          document.getElementById('sidebarOverlay').classList.remove('show');
        }
      });
    });

    // REFRESH ORDERS BUTTON
    document.getElementById('refreshOrdersBtn').addEventListener('click', async () => {
      await loadOrders();
      showAlert('Orodha ya maagizo imesasishwa');
    });

    // LOGOUT
    document.getElementById('btnLogout').addEventListener('click', () => {
      if (confirm('Una uhakika unataka kutoka?')) {
        authToken = '';
        localStorage.removeItem('adminToken');
        
        document.getElementById('adminPanel').style.display = 'none';
        document.getElementById('loginPage').style.display = 'flex';
        document.getElementById('adminLoginForm').reset();
        document.getElementById('adminLoginForm').style.display = 'block';
        document.getElementById('otpSection').style.display = 'none';
        hideLoginAlert();
      }
    });
    
    document.getElementById('btnLogoutMobile').addEventListener('click', () => {
      if (confirm('Una uhakika unataka kutoka?')) {
        authToken = '';
        localStorage.removeItem('adminToken');
        
        document.getElementById('adminPanel').style.display = 'none';
        document.getElementById('loginPage').style.display = 'flex';
        document.getElementById('adminLoginForm').reset();
        document.getElementById('adminLoginForm').style.display = 'block';
        document.getElementById('otpSection').style.display = 'none';
        hideLoginAlert();
      }
    });
  </script>
</body>
</html>