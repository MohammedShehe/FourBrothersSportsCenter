<!DOCTYPE html>
<html lang="sw">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="images/FBSC.png" />
  <title>Admin Panel - Four Brothers Sports Center</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Icons -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.umd.min.js"></script>
  <!-- Animate CSS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
  <style>
    :root {
      --primary: #2c3e50;
      --primary-light: #3498db;
      --secondary: #7f8c8d;
      --success: #27ae60;
      --danger: #e74c3c;
      --warning: #f39c12;
      --info: #1abc9c;
      --light: #ecf0f1;
      --dark: #2c3e50;
      --accent: #2980b9;
      --accent-light: #e8f4fc;
      --border-radius: 10px;
      --shadow: 0 6px 15px rgba(0,0,0,0.08);
      --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
      --gradient-primary: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
      --gradient-success: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
      --gradient-warning: linear-gradient(135deg, #f39c12 0%, #f1c40f 100%);
      --gradient-danger: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
    }
    
    body {
      background-color: #f5f7fa;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      color: #34495e;
      overflow-x: hidden;
      line-height: 1.6;
      height: 100vh;
    }
    
    /* Login Styles - Professional Redesign */
    .login-container {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 1.5rem;
      position: relative;
      overflow: hidden;
    }

    .login-container::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle, rgba(255,255,255,0.1) 1px, transparent 1px);
      background-size: 50px 50px;
      animation: float 20s linear infinite;
      z-index: 0;
    }

    @keyframes float {
      0% { transform: translate(0, 0) rotate(0deg); }
      100% { transform: translate(-50px, -50px) rotate(360deg); }
    }

    .login-card {
      background: rgba(255, 255, 255, 0.95);
      border-radius: var(--border-radius);
      box-shadow: 0 20px 40px rgba(0,0,0,0.1);
      padding: 2.5rem;
      width: 100%;
      max-width: 450px;
      transition: transform 0.4s ease, box-shadow 0.4s ease;
      position: relative;
      z-index: 1;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.2);
      max-height: 90vh;
      overflow-y: auto;
      scrollbar-width: thin;
      scrollbar-color: var(--primary-light) #f1f1f1;
    }

    .login-card::-webkit-scrollbar {
      width: 6px;
    }

    .login-card::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 3px;
    }

    .login-card::-webkit-scrollbar-thumb {
      background: var(--primary-light);
      border-radius: 3px;
    }

    .login-card::-webkit-scrollbar-thumb:hover {
      background: var(--primary);
    }

    .login-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 25px 50px rgba(0,0,0,0.15);
    }

    .logo-container {
      width: 140px;
      height: 60px;
      margin: 0 auto 1.5rem;
      border-radius: 8px;
      overflow: hidden;
      background: white;
      padding: 10px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    .logo-container img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      transition: transform 0.3s ease;
    }

    .logo-container img:hover {
      transform: scale(1.05);
    }

    .login-header {
      text-align: center;
      margin-bottom: 2rem;
    }

    .login-header h4 {
      margin-bottom: 0.5rem;
      font-size: 1.75rem;
      font-weight: 700;
      color: var(--primary);
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .login-header p {
      margin-bottom: 0;
      color: var(--secondary);
      font-size: 0.95rem;
      font-weight: 500;
    }

    .form-group {
      margin-bottom: 1.5rem;
      position: relative;
    }

    .form-label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 600;
      color: var(--primary);
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .form-control {
      width: 100%;
      padding: 0.875rem 1rem;
      border: 2px solid #e1e8ed;
      border-radius: 8px;
      font-size: 1rem;
      transition: all 0.3s ease;
      background: #fff;
    }

    .form-control:focus {
      border-color: var(--primary-light);
      box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
      outline: none;
      transform: translateY(-1px);
    }

    .form-control.is-invalid {
      border-color: var(--danger);
      background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='none' stroke='%23e74c3c' viewBox='0 0 12 12'%3e%3ccircle cx='6' cy='6' r='4.5'/%3e%3cpath stroke-linejoin='round' d='M5.8 3.6h.4L6 6.5z'/%3e%3ccircle cx='6' cy='8.2' r='.6' fill='%23e74c3c' stroke='none'/%3e%3c/svg%3e");
    }

    .invalid-feedback {
      display: block;
      width: 100%;
      margin-top: 0.375rem;
      font-size: 0.875em;
      color: var(--danger);
    }

    .login-btn {
      width: 100%;
      padding: 1rem;
      background: var(--gradient-primary);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      letter-spacing: 0.5px;
    }

    .login-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(52, 152, 219, 0.3);
      background: linear-gradient(135deg, #3498db 0%, #2c3e50 100%);
    }

    .login-btn:active {
      transform: translateY(0);
    }

    .forgot-password {
      text-align: center;
      margin-top: 1.5rem;
    }

    .forgot-password-btn {
      background: none;
      border: none;
      color: var(--primary-light);
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      transition: color 0.3s ease;
      padding: 0.5rem;
    }

    .forgot-password-btn:hover {
      color: var(--primary);
      text-decoration: underline;
    }

    .terms-section {
      margin-top: 2rem;
      padding: 1.5rem;
      background: #f8f9fa;
      border-radius: 8px;
      border-left: 4px solid var(--primary);
      max-height: 250px;
      overflow: hidden;
    }

    .terms-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 1rem;
      cursor: pointer;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid #e1e8ed;
    }

    .terms-header h6 {
      margin: 0;
      color: var(--primary);
      font-weight: 600;
    }

    .terms-content {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.4s ease-out;
      position: relative;
    }

    .terms-content.show {
      max-height: 200px;
      overflow-y: auto;
      padding-right: 5px;
    }

    .terms-content::-webkit-scrollbar {
      width: 4px;
    }

    .terms-content::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 2px;
    }

    .terms-content::-webkit-scrollbar-thumb {
      background: #bdc3c7;
      border-radius: 2px;
    }

    .terms-content ul {
      padding-left: 1.5rem;
      margin-bottom: 0;
      margin-top: 1rem;
    }

    .terms-content li {
      margin-bottom: 0.5rem;
      color: var(--secondary);
      font-size: 0.85rem;
    }

    .alert {
      border-radius: 8px;
      border: none;
      padding: 1rem 1.25rem;
      margin-bottom: 1.5rem;
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .spinner-border {
      width: 1rem;
      height: 1rem;
    }

    /* Animations */
    .animate-slide-up {
      animation: slideUp 0.5s ease forwards;
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .pulse {
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(52, 152, 219, 0.4); }
      70% { box-shadow: 0 0 0 10px rgba(52, 152, 219, 0); }
      100% { box-shadow: 0 0 0 0 rgba(52, 152, 219, 0); }
    }

    /* Responsive adjustments for login */
    @media (max-width: 576px) {
      .login-container {
        padding: 1rem;
        align-items: flex-start;
        padding-top: 2rem;
      }
      
      .login-card {
        padding: 1.5rem;
        margin: 0.5rem;
        max-height: 85vh;
      }
      
      .login-header h4 {
        font-size: 1.4rem;
      }
      
      .logo-container {
        width: 100px;
        height: 45px;
      }
      
      .terms-section {
        margin-top: 1.5rem;
        padding: 1rem;
        max-height: 200px;
      }
      
      .terms-content.show {
        max-height: 150px;
      }
    }

    @media (max-width: 375px) {
      .login-card {
        padding: 1.25rem;
      }
      
      .login-header h4 {
        font-size: 1.25rem;
      }
      
      .form-control {
        padding: 0.75rem;
      }
      
      .login-btn {
        padding: 0.875rem;
      }
    }

    /* Admin Panel Styles */
    .sidebar {
      min-width: 280px;
      max-width: 280px;
      background: linear-gradient(180deg, var(--primary) 0%, #1a2530 100%);
      min-height: 100vh;
      transition: var(--transition);
      z-index: 1000;
      box-shadow: 2px 0 20px rgba(0,0,0,0.1);
      position: fixed;
      left: 0;
      top: 0;
      height: 100%;
      overflow-y: auto;
      scrollbar-width: thin;
      scrollbar-color: rgba(255,255,255,0.3) transparent;
    }
    
    .sidebar::-webkit-scrollbar {
      width: 6px;
    }
    
    .sidebar::-webkit-scrollbar-track {
      background: transparent;
    }
    
    .sidebar::-webkit-scrollbar-thumb {
      background: rgba(255,255,255,0.3);
      border-radius: 3px;
    }
    
    .nav-link {
      color: rgba(255,255,255,0.8);
      padding: 14px 20px;
      border-radius: 8px;
      margin-bottom: 5px;
      transition: var(--transition);
      display: flex;
      align-items: center;
      position: relative;
      overflow: visible !important;
    }
    
    .nav-link:hover {
      background: rgba(255,255,255,0.1);
      color: white;
      transform: translateX(5px);
    }
    
    .nav-link.active {
      background: linear-gradient(90deg, rgba(52, 152, 219, 0.2), transparent);
      color: white;
      font-weight: 600;
      border-left: 4px solid var(--primary-light);
    }
    
    .nav-link .badge {
      position: absolute;
      right: 20px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 0.7rem;
      padding: 3px 8px;
      min-width: 22px;
    }
    
    .card-small {
      padding: 20px;
      border-radius: 12px;
      border: none;
      box-shadow: var(--shadow);
      transition: var(--transition);
      background: white;
      height: 100%;
    }
    
    .card-small:hover {
      transform: translateY(-8px);
      box-shadow: 0 15px 30px rgba(0,0,0,0.15);
    }
    
    .product-thumb {
      width: 55px;
      height: 55px;
      object-fit: cover;
      border-radius: 8px;
      border: 2px solid #f0f0f0;
    }
    
    .pointer {
      cursor: pointer;
    }
    
    .btn {
      border-radius: 8px;
      padding: 10px 24px;
      font-weight: 600;
      transition: var(--transition);
      border: none;
      font-size: 0.9rem;
    }
    
    .btn-primary {
      background: var(--gradient-primary);
      border-color: transparent;
    }
    
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(52, 152, 219, 0.3);
    }
    
    .modal-content {
      border-radius: var(--border-radius);
      border: none;
      box-shadow: 0 20px 40px rgba(0,0,0,0.2);
      overflow: hidden;
    }
    
    .modal-header {
      border-bottom: 1px solid rgba(0,0,0,0.1);
      padding: 1.5rem;
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    }
    
    .modal-footer {
      border-top: 1px solid rgba(0,0,0,0.1);
      padding: 1.5rem;
    }
    
    .table th {
      border-top: none;
      font-weight: 600;
      color: var(--dark);
      background: #f8f9fa;
      padding: 1rem;
      border-bottom: 2px solid #dee2e6;
    }
    
    .table-responsive {
      border-radius: var(--border-radius);
      overflow: hidden;
      border: 1px solid #dee2e6;
    }
    
    .badge-status {
      font-size: 0.75rem;
      padding: 6px 12px;
      border-radius: 20px;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .section-title {
      position: relative;
      margin-bottom: 30px;
      font-weight: 700;
      color: var(--dark);
      font-size: 1.5rem;
    }
    
    .section-title:after {
      content: '';
      position: absolute;
      left: 0;
      bottom: -10px;
      width: 60px;
      height: 4px;
      background: var(--gradient-primary);
      border-radius: 2px;
    }
    
    .image-preview {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 10px;
      max-height: 120px;
      overflow-y: auto;
      padding: 5px;
    }
    
    .image-preview img {
      width: 80px;
      height: 80px;
      object-fit: cover;
      border-radius: 8px;
      border: 2px solid #e1e8ed;
      transition: transform 0.3s ease;
    }
    
    .image-preview img:hover {
      transform: scale(1.1);
    }
    
    /* Status Badge Styles */
    .status-badge {
      font-size: 0.75rem;
      padding: 6px 14px;
      border-radius: 20px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .status-Imewekwa {
      background: var(--gradient-primary);
      color: white;
    }
    
    .status-Inasafirishwa {
      background: var(--gradient-warning);
      color: var(--dark);
    }
    
    .status-Ghairishwa {
      background: var(--gradient-danger);
      color: white;
    }
    
    .status-Kurudishwa {
      background: linear-gradient(135deg, #1abc9c 0%, #16a085 100%);
      color: white;
    }
    
    .status-Imepokelewa {
      background: var(--gradient-success);
      color: white;
    }
    
    /* Notification badges */
    .notification-badge {
      position: absolute;
      top: -5px;
      right: -5px;
      background: var(--danger);
      color: white;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      font-size: 0.7rem;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      animation: pulse 2s infinite;
      z-index: 1;
    }
    
    .mobile-notification-badge {
      position: absolute;
      top: 5px;
      right: 5px;
      background: var(--danger);
      color: white;
      border-radius: 50%;
      width: 16px;
      height: 16px;
      font-size: 0.6rem;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
    }
    
    /* Loading spinner */
    .spinner-border-sm {
      width: 1rem;
      height: 1rem;
    }
    
    /* Placeholder image styles */
    .placeholder-img {
      background: linear-gradient(45deg, #f0f0f0, #e0e0e0);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #999;
      font-weight: bold;
      border: 2px solid #e1e8ed;
    }
    
    /* Mobile-first responsive adjustments */
    @media (max-width: 991px) {
      .sidebar {
        position: fixed;
        left: -300px;
        height: 100vh;
        overflow-y: auto;
        box-shadow: 5px 0 20px rgba(0,0,0,0.2);
      }
      
      .sidebar.show {
        left: 0;
        animation: slideInLeft 0.3s ease;
      }
      
      @keyframes slideInLeft {
        from { left: -300px; }
        to { left: 0; }
      }
      
      .main-content {
        width: 100%;
        margin-left: 0;
        padding-top: 70px;
      }
      
      .modal-dialog {
        margin: 1rem;
      }
      
      .modal-dialog-scrollable .modal-body {
        max-height: calc(80vh - 120px);
        overflow-y: auto;
      }
      
      .table-responsive {
        font-size: 0.875rem;
      }
      
      .nav-link {
        padding: 12px 16px;
      }
      
      .section-title {
        font-size: 1.3rem;
      }
      
      .section-title:after {
        width: 40px;
        bottom: -8px;
      }
    }
    
    @media (max-width: 768px) {
      .login-card {
        margin: 20px;
        padding: 2rem;
      }
      
      .card-small {
        padding: 16px;
      }
      
      .btn {
        padding: 8px 16px;
        font-size: 0.875rem;
      }
      
      .modal-dialog {
        margin: 0.75rem;
      }
      
      .modal-dialog-scrollable .modal-body {
        max-height: calc(70vh - 120px);
      }
    }
    
    @media (max-width: 576px) {
      .d-flex.justify-content-between.align-items-center {
        flex-direction: column;
        align-items: flex-start !important;
        gap: 15px;
      }
      
      .d-flex.justify-content-between.align-items-center > div {
        width: 100%;
      }
      
      .d-flex.justify-content-between.align-items-center .btn {
        width: 100%;
        margin-bottom: 8px;
      }
      
      .table th, .table td {
        padding: 0.75rem;
      }
      
      .modal-dialog {
        margin: 0.5rem;
      }
      
      .modal-content {
        border-radius: 12px;
      }
      
      .modal-header, .modal-footer {
        padding: 1rem;
      }
      
      .section-title {
        font-size: 1.25rem;
      }
      
      .card-small h4 {
        font-size: 1.25rem;
      }
      
      .card-small .fa-2x {
        font-size: 1.5rem;
      }
      
      .quick-action-btn {
        padding: 12px;
        font-size: 0.9rem;
      }
      
      .dashboard-card-icon {
        width: 50px;
        height: 50px;
        font-size: 1.25rem;
      }
    }
    
    /* Mobile overlay for sidebar */
    .sidebar-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 999;
      display: none;
      backdrop-filter: blur(3px);
    }
    
    .sidebar-overlay.show {
      display: block;
      animation: fadeIn 0.3s ease;
    }
    
    /* Improved mobile form controls */
    .form-control, .form-select {
      padding: 0.75rem;
      border-radius: 8px;
    }
    
    /* Better mobile table experience */
    .table-mobile-card {
      display: none;
    }
    
    @media (max-width: 768px) {
      .table-responsive table {
        display: none;
      }
      
      .table-mobile-card {
        display: block;
      }
      
      .mobile-card {
        background: white;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        transition: transform 0.3s ease;
      }
      
      .mobile-card:hover {
        transform: translateY(-3px);
      }
      
      .mobile-card-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 12px;
        padding-bottom: 12px;
        border-bottom: 1px solid #f0f0f0;
      }
      
      .mobile-card-row:last-child {
        border-bottom: none;
        margin-bottom: 0;
        padding-bottom: 0;
      }
      
      .mobile-card-label {
        font-weight: 600;
        color: var(--primary);
        font-size: 0.85rem;
      }
      
      .mobile-card-value {
        text-align: right;
        color: var(--dark);
        font-weight: 500;
        max-width: 60%;
        overflow-wrap: break-word;
      }
    }
    
    /* Improved mobile navigation */
    .mobile-header {
      display: none;
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
      padding: 1rem 1.5rem;
      border-bottom: none;
      position: fixed;
      top: 0;
      width: 100%;
      z-index: 100;
      box-shadow: 0 2px 20px rgba(0,0,0,0.1);
      color: white;
      height: 70px;
    }
    
    @media (max-width: 991px) {
      .mobile-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      
      .mobile-header h5 {
        color: white;
        margin: 0;
        font-weight: 600;
        font-size: 1.1rem;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 200px;
      }
      
      .mobile-header small {
        color: rgba(255,255,255,0.8);
        font-size: 0.8rem;
        display: block;
      }
    }
    
    /* Dashboard improvements */
    .dashboard-card-icon {
      width: 60px;
      height: 60px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      margin-bottom: 15px;
    }
    
    .dashboard-card-icon.users {
      background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
      color: white;
    }
    
    .dashboard-card-icon.products {
      background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%);
      color: white;
    }
    
    .dashboard-card-icon.income {
      background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
      color: white;
    }
    
    .dashboard-card-icon.orders {
      background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
      color: white;
    }
    
    /* Quick actions */
    .quick-action-btn {
      padding: 15px;
      border-radius: 10px;
      border: 2px dashed #e1e8ed;
      background: white;
      color: var(--primary);
      font-weight: 600;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      text-align: center;
      width: 100%;
      cursor: pointer;
    }
    
    .quick-action-btn:hover {
      background: var(--accent-light);
      border-color: var(--primary-light);
      transform: translateY(-2px);
    }
    
    /* Message notification count */
    .message-count {
      display: inline-block;
      background: var(--danger);
      color: white;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      font-size: 0.7rem;
      text-align: center;
      line-height: 20px;
      margin-left: 5px;
      font-weight: bold;
    }
    
    /* Main content area */
    .main-content {
      margin-left: 280px;
      width: calc(100% - 280px);
      min-height: 100vh;
      background-color: #f5f7fa;
      transition: margin-left 0.3s ease;
    }
    
    @media (max-width: 991px) {
      .main-content {
        margin-left: 0;
        width: 100%;
      }
    }
    
    /* Fix for modal scrolling on mobile */
    .modal {
      -webkit-overflow-scrolling: touch;
    }
    
    .modal-body {
      max-height: 70vh;
      overflow-y: auto;
    }
    
    @media (max-height: 600px) {
      .modal-body {
        max-height: 50vh;
      }
    }
    
    /* Fix for chart responsiveness */
    .chart-container {
      position: relative;
      height: 300px;
      width: 100%;
    }
    
    @media (max-width: 768px) {
      .chart-container {
        height: 250px;
      }
    }
    
    /* Better button spacing on mobile */
    .btn-group {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
    }
    
    .btn-group .btn {
      margin: 2px;
      flex: 1;
      min-width: 120px;
    }
    
    /* Adjust modal sizes for mobile */
    @media (max-width: 768px) {
      .modal-lg {
        max-width: 95%;
      }
      
      .modal-dialog-scrollable {
        max-height: 85vh;
      }
    }
    
    /* Improve tap targets on mobile */
    @media (max-width: 768px) {
      .btn, .nav-link, .form-check-label {
        min-height: 44px;
        min-width: 44px;
      }
      
      .btn-sm {
        min-height: 36px;
        min-width: 36px;
      }
    }
    
    /* Prevent horizontal scrolling */
    body, .main-content, .modal-body, .login-card {
      overflow-x: hidden;
    }
    
    /* Better spacing for mobile cards */
    @media (max-width: 576px) {
      .mobile-card {
        padding: 15px;
      }
      
      .mobile-card-row {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .mobile-card-value {
        text-align: left;
        width: 100%;
        margin-top: 4px;
      }
    }
  </style>
</head>
<body>
  <!-- Login Page -->
  <div id="loginPage" class="login-container">
    <div class="login-card animate-slide-up">
      <div class="logo-container">
        <img src="images/FBSC.png" alt="Four Brothers Logo">
      </div>
      
      <div class="login-header">
        <h4>Admin Panel Ingia</h4>
        <p>Ingia kwenye dashibodi ya usimamizi</p>
      </div>
      
      <form id="adminLoginForm" novalidate>
        <div class="form-group">
          <label class="form-label">Nambari ya Simu</label>
          <input type="text" class="form-control" id="adminMobileLogin" required placeholder="Ingiza nambari ya simu">
          <div class="invalid-feedback" id="mobileError">Tafadhali ingiza nambari ya simu</div>
        </div>
        
        <div class="form-group">
          <label class="form-label">Nenosiri</label>
          <input type="password" class="form-control" id="adminPassword" required placeholder="Ingiza nenosiri lako">
          <div class="invalid-feedback" id="passwordError">Tafadhali ingiza nenosiri</div>
        </div>
        
        <button type="submit" class="login-btn">
          <span id="loginBtnText">Ingia kwenye Mfumo</span>
          <span id="loginSpinner" class="spinner-border spinner-border-sm" style="display: none;"></span>
        </button>
        
        <div class="forgot-password">
          <button type="button" class="forgot-password-btn" id="forgotPasswordBtn">
            <i class="fa fa-key me-1"></i>Umesahau nenosiri?
          </button>
        </div>
      </form>
      
      <!-- Terms Section -->
      <div class="terms-section">
        <div class="terms-header" id="termsToggle">
          <h6><i class="fa fa-file-contract me-2"></i>Masharti ya Huduma</h6>
          <i class="fa fa-chevron-down"></i>
        </div>
        <div class="terms-content" id="termsContent">
          <ul>
            <li>Hakikisha wewe ni muhusika (Admini)</li>
            <li>Usigawane maelezo ya kuingia yako na mtu yeyote</li>
            <li>Tumia nenosiri thabiti kama ulivyopewa na kiongozi</li>
            <li>Taarifa zote za mteja lazima zihifadhiwe kwa usalama na faragha</li>
            <li>Matumizi yasiyokuwa ya kimaadili yatapewa hatua kali</li>
            <li>Ripoti matatizo yoyote ya usalama mara moja</li>
          </ul>
        </div>
      </div>
      
      <!-- Forgot Password Section -->
      <div id="forgotPasswordSection" style="display: none;" class="mt-4 animate-slide-up">
        <h5 class="login-header"><i class="fa fa-unlock-alt me-2"></i>Usaidizi wa Nenosiri</h5>
        <form id="forgotPasswordForm">
          <div class="form-group">
            <label class="form-label">Jina la Kwanza</label>
            <input type="text" class="form-control" id="forgotFirstName" required placeholder="Ingiza jina la kwanza">
          </div>
          <div class="form-group">
            <label class="form-label">Jina la Mwisho</label>
            <input type="text" class="form-control" id="forgotLastName" required placeholder="Ingiza jina la mwisho">
          </div>
          
          <button type="submit" class="login-btn btn-warning" style="background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);" id="resetPasswordBtn">
            <span id="resetBtnText">Thibitisha Utambulisho</span>
            <span id="resetSpinner" class="spinner-border spinner-border-sm" style="display: none;"></span>
          </button>
          
          <div class="text-center mt-3">
            <button type="button" class="forgot-password-btn" id="backToLoginBtn">
              <i class="fa fa-arrow-left me-1"></i>Rudi kwenye kuingia
            </button>
          </div>
        </form>
      </div>
      
      <!-- Reset Options Section -->
      <div id="resetOptionsSection" style="display: none;" class="mt-4 animate-slide-up">
        <h5 class="login-header"><i class="fa fa-cogs me-2"></i>Chagua Kitendo</h5>
        <div class="d-grid gap-3">
          <button type="button" class="login-btn" style="background: var(--gradient-primary);" id="resetPasswordOptionBtn">
            <i class="fa fa-key me-2"></i>Badilisha Nenosiri
          </button>
          <button type="button" class="login-btn" style="background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%);" id="resetMobileOptionBtn">
            <i class="fa fa-mobile-alt me-2"></i>Badilisha Nambari ya Simu
          </button>
          <button type="button" class="login-btn" style="background: var(--secondary); border: none;" id="backToForgotBtn">
            <i class="fa fa-arrow-left me-2"></i>Rudi Nyuma
          </button>
        </div>
      </div>
      
      <!-- Reset Password Form -->
      <div id="resetPasswordFormSection" style="display: none;" class="mt-4 animate-slide-up">
        <h5 class="login-header"><i class="fa fa-key me-2"></i>Weka Nenosiri Jipya</h5>
        <form id="newPasswordForm">
          <div class="form-group">
            <label class="form-label">Nenosiri Jipya</label>
            <input type="password" class="form-control" id="newPassword" required placeholder="Ingiza nenosiri jipya">
          </div>
          <div class="form-group">
            <label class="form-label">Rudia Nenosiri Jipya</label>
            <input type="password" class="form-control" id="confirmNewPassword" required placeholder="Rudia nenosiri jipya">
          </div>
          
          <button type="submit" class="login-btn" style="background: var(--gradient-success);" id="submitNewPasswordBtn">
            <span id="newPasswordBtnText">Weka Nenosiri Jipya</span>
            <span id="newPasswordSpinner" class="spinner-border spinner-border-sm" style="display: none;"></span>
          </button>
          
          <div class="text-center mt-3">
            <button type="button" class="forgot-password-btn" id="backToOptionsBtn">
              <i class="fa fa-arrow-left me-1"></i>Rudi Nyuma
            </button>
          </div>
        </form>
      </div>
      
      <!-- Reset Mobile Form -->
      <div id="resetMobileFormSection" style="display: none;" class="mt-4 animate-slide-up">
        <h5 class="login-header"><i class="fa fa-mobile-alt me-2"></i>Badilisha Nambari ya Simu</h5>
        <form id="newMobileForm">
          <div class="form-group">
            <label class="form-label">Nambari Mpya ya Simu</label>
            <input type="text" class="form-control" id="newMobile" required placeholder="Ingiza nambari mpya ya simu">
          </div>
          <div class="form-group">
            <label class="form-label">Rudia Nambari ya Simu</label>
            <input type="text" class="form-control" id="confirmNewMobile" required placeholder="Rudia nambari ya simu">
          </div>
          
          <button type="submit" class="login-btn" style="background: var(--gradient-success);" id="submitNewMobileBtn">
            <span id="newMobileBtnText">Weka Nambari Mpya</span>
            <span id="newMobileSpinner" class="spinner-border spinner-border-sm" style="display: none;"></span>
          </button>
          
          <div class="text-center mt-3">
            <button type="button" class="forgot-password-btn" id="backToOptionsBtn2">
              <i class="fa fa-arrow-left me-1"></i>Rudi Nyuma
            </button>
          </div>
        </form>
      </div>
      
      <div id="loginAlert" class="alert alert-danger mt-3" style="display: none;"></div>
    </div>
  </div>

  <!-- Admin Panel (hidden initially) -->
  <div id="adminPanel" style="display: none;">
    <!-- Mobile Header -->
    <div class="mobile-header">
      <div class="d-flex align-items-center">
        <button class="btn btn-outline-light me-3" id="toggleSidebarMobile">
          <i class="fa fa-bars"></i>
        </button>
        <div>
          <h5 class="mb-0" id="mobileSectionTitle">Dashibodi</h5>
          <small class="text-muted">Four Brothers Admin Panel</small>
        </div>
      </div>
      <button class="btn btn-outline-light" id="btnLogoutMobile">
        <i class="fa fa-sign-out-alt me-1"></i>Toka
      </button>
    </div>
    
    <!-- Sidebar Overlay (for mobile) -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>
    
    <div class="d-flex">
      <!-- Sidebar -->
      <aside class="sidebar p-4" id="sidebar">
        <div class="d-flex align-items-center mb-4">
          <div class="placeholder-img me-3 rounded-circle" style="width: 56px; height: 56px;">
            <img src="images/FBSC.png" alt="Admin Avatar" style="width: 100%; height: 100%; object-fit: cover;">
          </div>
          <div>
            <h6 class="mb-0 text-white">Four Brothers</h6>
            <small class="text-white-50">Admin Dashboard</small>
          </div>
        </div>
        
        <nav class="nav flex-column mb-4">
          <a class="nav-link active" data-section="dashboard" href="#">
            <i class="fa fa-tachometer-alt me-2"></i>Dashibodi
          </a>
          <a class="nav-link" data-section="products" href="#">
            <i class="fa fa-box-open me-2"></i>Usimamizi wa Bidhaa
          </a>
          <a class="nav-link" data-section="customers" href="#">
            <i class="fa fa-users me-2"></i>Usimamizi wa Wateja
          </a>
          <a class="nav-link" data-section="ads" href="#">
            <i class="fa fa-bullhorn me-2"></i>Matangazo & Arifa
          </a>
          <a class="nav-link" data-section="notifications" href="#" id="notificationsNavLink">
            <i class="fa fa-envelope me-2"></i>Arifa & Ujumbe
            <!-- Badge will be added dynamically -->
          </a>
          <a class="nav-link" data-section="orders" href="#" id="ordersNavLink">
            <i class="fa fa-shopping-cart me-2"></i>Maagizo Yaliyowekwa
            <!-- Badge will be added dynamically -->
          </a>
          <a class="nav-link" data-section="admins" href="#" id="adminsNavLink" style="display: none;">
            <i class="fa fa-user-shield me-2"></i>Wasimamizi
          </a>
        </nav>
        
        <div class="mt-auto pt-4 border-top border-white-10">
          <div class="small text-white-50 mb-2">
            Imekuwapo kama:
          </div>
          <div class="d-flex align-items-center">
            <div class="placeholder-img me-2 rounded-circle" style="width: 40px; height: 40px;">
              <i class="fa fa-user text-white"></i>
            </div>
            <div>
              <strong class="text-white" id="adminNameDisplay">Admin</strong>
              <div id="adminRoleDisplay" class="text-white-50" style="font-size: 0.8em;"></div>
            </div>
          </div>
        </div>
      </aside>

      <!-- Main Content -->
      <main class="flex-grow-1 p-3 p-md-4 main-content">
        <div class="d-none d-lg-flex justify-content-between align-items-center mb-4">
          <h3 class="m-0 section-title" id="sectionTitle">Dashibodi ya Msimamizi</h3>
          <div class="d-flex align-items-center gap-2">
            <button class="btn btn-outline-primary d-lg-none" id="toggleSidebar">
              <i class="fa fa-bars"></i>
            </button>
            <button class="btn btn-danger" id="btnLogout">
              <i class="fa fa-sign-out-alt me-1"></i>Toka
            </button>
          </div>
        </div>

        <!-- Alert container for API messages -->
        <div id="apiAlert" class="alert" style="display: none;"></div>

        <!-- Sections container -->
        <section id="sectionContainer">
          <!-- DASHBOARD -->
          <div id="dashboard" class="section">
            <div class="row g-4 mb-4">
              <div class="col-6 col-md-3">
                <div class="card card-small">
                  <div class="dashboard-card-icon users">
                    <i class="fa fa-users"></i>
                  </div>
                  <small class="text-muted d-block">Wateja Wote</small>
                  <h4 class="mt-2" id="totalUsers">0</h4>
                </div>
              </div>
              
              <div class="col-6 col-md-3">
                <div class="card card-small">
                  <div class="dashboard-card-icon products">
                    <i class="fa fa-box"></i>
                  </div>
                  <small class="text-muted d-block">Bidhaa Zote</small>
                  <h4 class="mt-2" id="totalProducts">0</h4>
                </div>
              </div>
              
              <div class="col-6 col-md-3">
                <div class="card card-small">
                  <div class="dashboard-card-icon income">
                    <i class="fa fa-money-bill-wave"></i>
                  </div>
                  <small class="text-muted d-block">Mapato (mwaka huu)</small>
                  <h4 class="mt-2" id="totalIncome">TSh 0</h4>
                </div>
              </div>
              
              <div class="col-6 col-md-3">
                <div class="card card-small">
                  <div class="dashboard-card-icon orders">
                    <i class="fa fa-shopping-cart"></i>
                  </div>
                  <small class="text-muted d-block">Bidhaa Zilizonunuliwa</small>
                  <h4 class="mt-2" id="totalOrders">0</h4>
                </div>
              </div>
            </div>

            <div class="row g-4">
              <div class="col-lg-8">
                <div class="card shadow-sm p-4 mb-4">
                  <h6 class="section-title">Maendeleo ya Mapato (kila mwezi)</h6>
                  <div class="chart-container" style="position: relative; height: 300px; margin-top: 20px;">
                    <canvas id="incomeChart"></canvas>
                  </div>
                </div>
              </div>
              
              <div class="col-lg-4">
                <div class="card shadow-sm p-4 mb-4">
                  <h6 class="section-title">Vitendo vya Haraka</h6>
                  <div class="mt-4 d-flex flex-column gap-3">
                    <button class="quick-action-btn" data-section-target="products" id="quickAddProductBtn">
                      <i class="fa fa-plus-circle me-2"></i>Ongeza Bidhaa Mpya
                    </button>
                    <button class="quick-action-btn" data-section-target="customers" id="quickAddCustomerBtn">
                      <i class="fa fa-user-plus me-2"></i>Ongeza Mteja Mpya
                    </button>
                    <button class="quick-action-btn" data-section-target="ads" id="quickAddAdBtn">
                      <i class="fa fa-bullhorn me-2"></i>Chapisha Tangazo
                    </button>
                    <button class="quick-action-btn" data-section-target="notifications" id="quickViewNotificationsBtn">
                      <i class="fa fa-envelope me-2"></i>Angalia Ujumbe
                      <span class="message-count" id="quickMessageCount" style="display: none;">0</span>
                    </button>
                  </div>
                </div>
              </div>
            </div>
            
            <div class="row g-4">
              <div class="col-12">
                <div class="card shadow-sm p-4">
                  <h6 class="section-title">Maagizo ya Hivi Karibuni</h6>
                  <div id="recentOrders" class="mt-3" style="max-height: 300px; overflow-y: auto;">
                    <!-- Recent orders will be populated here -->
                    <div class="text-center py-4 text-muted">
                      <i class="fa fa-shopping-cart fa-2x mb-3"></i>
                      <p>Hakuna maagizo ya hivi karibuni</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- PRODUCTS -->
          <div id="products" class="section d-none">
            <div class="d-flex justify-content-between align-items-center mb-4 flex-column flex-md-row gap-3">
              <h5 class="section-title">Usimamizi wa Bidhaa</h5>
              <div class="d-flex flex-column flex-md-row gap-2 w-100 w-md-auto">
                <div class="input-group" style="min-width: 250px;">
                  <span class="input-group-text"><i class="fa fa-search"></i></span>
                  <input type="text" id="productSearch" placeholder="Tafuta bidhaa..." class="form-control" autocomplete="off">
                </div>
                <button class="btn btn-outline-info" onclick="loadProducts()">
                  <i class="fa fa-refresh me-1"></i>Pakia Upya
                </button>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalAddProduct">
                  <i class="fa fa-plus me-1"></i>Ongeza Bidhaa
                </button>
              </div>
            </div>

            <div class="table-responsive d-none d-md-block">
              <table class="table table-hover align-middle">
                <thead class="table-light">
                  <tr>
                    <th>#</th>
                    <th>Picha</th>
                    <th>Kampuni</th>
                    <th>Jina</th>
                    <th>Rangi</th>
                    <th>Punguzo %</th>
                    <th>Aina</th>
                    <th>Saizi & Akiba</th>
                    <th>Jumla ya Akiba</th>
                    <th>Bei (TSh)</th>
                    <th>Vitendo</th>
                  </tr>
                </thead>
                <tbody id="productsTableBody"></tbody>
              </table>
            </div>
            
            <!-- Mobile Cards View -->
            <div class="table-mobile-card" id="productsMobileCards"></div>
          </div>

          <!-- CUSTOMERS -->
          <div id="customers" class="section d-none">
            <div class="d-flex justify-content-between align-items-center mb-4 flex-column flex-md-row gap-3">
              <h5 class="section-title">Usimamizi wa Wateja</h5>
              <div class="d-flex flex-column flex-md-row gap-2 w-100 w-md-auto">
                <div class="input-group" style="min-width: 250px;">
                  <span class="input-group-text"><i class="fa fa-search"></i></span>
                  <input type="text" id="customerSearch" placeholder="Tafuta wateja..." class="form-control" autocomplete="off">
                </div>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalAddCustomer">
                  <i class="fa fa-plus me-1"></i>Ongeza Mteja
                </button>
              </div>
            </div>

            <div class="table-responsive d-none d-md-block">
              <table class="table table-striped align-middle">
                <thead class="table-light">
                  <tr>
                    <th>#</th>
                    <th>Jina la Kwanza</th>
                    <th>Jina la Mwisho</th>
                    <th>Simu</th>
                    <th>Barua Pepe</th>
                    <th>Jinsia</th>
                    <th>Vitendo</th>
                  </tr>
                </thead>
                <tbody id="customersTableBody"></tbody>
              </table>
            </div>
            
            <!-- Mobile Cards View -->
            <div class="table-mobile-card" id="customersMobileCards"></div>
          </div>

          <!-- ADS -->
          <div id="ads" class="section d-none">
            <div class="d-flex justify-content-between align-items-center mb-4 flex-column flex-md-row gap-3">
              <h5 class="section-title">Matangazo & Arifa</h5>
              <div class="d-flex flex-column flex-md-row gap-2">
                <button class="btn btn-primary me-2" data-bs-toggle="modal" data-bs-target="#modalAddAd">
                  <i class="fa fa-plus me-1"></i>Tangazo Jipya
                </button>
                <button class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#modalPostAnnouncement">
                  <i class="fa fa-bullhorn me-1"></i>Toa Arifa
                </button>
              </div>
            </div>

            <div class="row g-4" id="adsContainer"></div>
          </div>

          <!-- NOTIFICATIONS -->
          <div id="notifications" class="section d-none">
            <div class="d-flex justify-content-between align-items-center mb-4 flex-column flex-md-row gap-3">
              <h5 class="section-title">Arifa & Ujumbe 
                <span class="badge bg-danger ms-2" id="notificationCountTitle">0</span>
              </h5>
              <div>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalSendMessage">
                  <i class="fa fa-paper-plane me-1"></i>Tuma Ujumbe
                </button>
              </div>
            </div>

            <div class="card shadow-sm p-4 mb-4">
              <h6 class="section-title">Ujumbe kutoka kwa Wateja</h6>
              <div id="messagesList" class="list-group mt-3" style="max-height: 400px; overflow-y: auto;"></div>
            </div>
            
            <div class="card shadow-sm p-4">
              <h6 class="section-title">Historia ya Arifa</h6>
              <div id="announcementsList" class="mt-3" style="max-height: 400px; overflow-y: auto;">
                <div class="text-center py-4 text-muted">
                  <i class="fa fa-bullhorn fa-2x mb-3"></i>
                  <p>Hakuna arifa zilizotolewa</p>
                </div>
              </div>
            </div>
          </div>

          <!-- ORDERS -->
          <div id="orders" class="section d-none">
            <div class="d-flex justify-content-between align-items-center mb-4 flex-column flex-md-row gap-3">
              <h5 class="section-title">Maagizo Yaliyowekwa</h5>
              <div>
                <button class="btn btn-outline-primary" id="refreshOrdersBtn">
                  <i class="fa fa-refresh me-1"></i>Pakia Upya
                </button>
              </div>
            </div>

            <div class="table-responsive d-none d-md-block">
              <table class="table table-hover align-middle">
                <thead class="table-light">
                  <tr>
                    <th>Namba ya Agizo</th>
                    <th>Mteja</th>
                    <th>Bidhaa</th>
                    <th>Jumla</th>
                    <th>Hali</th>
                    <th>Kitendo</th>
                  </tr>
                </thead>
                <tbody id="ordersTableBody"></tbody>
              </table>
            </div>
            
            <!-- Mobile Cards View -->
            <div class="table-mobile-card" id="ordersMobileCards"></div>
          </div>

          <!-- ADMINS MANAGEMENT (Only visible to main admin) -->
          <div id="admins" class="section d-none">
            <div class="d-flex justify-content-between align-items-center mb-4 flex-column flex-md-row gap-3">
              <h5 class="section-title">Usimamizi wa Wasimamizi</h5>
              <div>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalAddAdmin">
                  <i class="fa fa-user-plus me-1"></i>Ongeza Msimamizi
                </button>
              </div>
            </div>

            <div class="table-responsive d-none d-md-block">
              <table class="table table-striped align-middle">
                <thead class="table-light">
                  <tr>
                    <th>#</th>
                    <th>Jina la Kwanza</th>
                    <th>Jina la Mwisho</th>
                    <th>Simu</th>
                    <th>Cheo</th>
                    <th>Tarehe ya Usajili</th>
                    <th>Vitendo</th>
                  </tr>
                </thead>
                <tbody id="adminsTableBody"></tbody>
              </table>
            </div>
            
            <!-- Mobile Cards View -->
            <div class="table-mobile-card" id="adminsMobileCards"></div>
          </div>
        </section>
      </main>
    </div>
  </div>

  <!-- Modals -->
  <!-- Add/Edit Product Modal -->
<div class="modal fade" id="modalAddProduct" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <form id="productForm">
        <div class="modal-header">
          <h5 class="modal-title">Ongeza / Hariri Bidhaa</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="row g-3">
            <!-- Basic Info -->
            <div class="col-md-6">
              <label class="form-label">Jina la Bidhaa <span class="text-danger">*</span></label>
              <input class="form-control" id="prodTitle" required autocomplete="off">
            </div>
            <div class="col-md-6">
              <label class="form-label">Kampuni <span class="text-danger">*</span></label>
              <select id="prodBrand" class="form-select" required>
                <option value="">Chagua...</option>
                <option>Nike</option>
                <option>Adidas</option>
                <option>AirZoom</option>
                <option>Mercurial</option>
              </select>
            </div>

            <div class="col-md-4">
              <label class="form-label">Rangi <span class="text-danger">*</span></label>
              <select id="prodColor" class="form-select" required>
                <option value="">Chagua...</option>
                <option>Nyeusi</option>
                <option>Nyeupe</option>
                <option>Njano</option>
                <option>Buluu</option>
                <option>Kijani</option>
                <option>Zambarau</option>
              </select>
            </div>
            <div class="col-md-4">
              <label class="form-label">Punguzo (%)</label>
              <input type="number" min="0" max="100" id="prodOffer" class="form-control" value="0" autocomplete="off">
            </div>
            <div class="col-md-4">
              <label class="form-label">Aina <span class="text-danger">*</span></label>
              <select id="prodType" class="form-select" required>
                <option value="">Chagua...</option>
                <option value="Njumu">Njumu</option>
                <option value="Trainer">Trainer</option>
                <option value="Njumu na Trainer">Njumu na Trainer</option>
              </select>
            </div>

            <div class="col-md-6">
              <label class="form-label">Bei (TSh) <span class="text-danger">*</span></label>
              <input type="number" id="prodPrice" class="form-control" required min="0" step="1000" autocomplete="off">
            </div>
            
            <div class="col-md-6">
              <label class="form-label">Maelezo (hiari)</label>
              <textarea id="prodDescription" class="form-control" rows="2" placeholder="Maelezo ya bidhaa..." autocomplete="off"></textarea>
            </div>

            <!-- Sizes Management -->
            <div class="col-12">
              <label class="form-label">Saizi na Akiba <span class="text-danger">*</span></label>
              <div id="sizesContainer">
                <!-- Sizes will be added dynamically -->
              </div>
              <button type="button" class="btn btn-sm btn-outline-primary mt-2" id="addSizeBtn">
                <i class="fa fa-plus me-1"></i>Ongeza Saizi Nyingine
              </button>
              <div class="form-text">
                Weka saizi zote zinazopatikana kwa bidhaa hii. Ukiongeza saizi mpya, fanya yafuatayo: <br>
                1. Kifupi (39, M, XL) - Ingiza mfano wa saizi<br>
                2. Jina kamili (39 EU, Medium) - Weka jina kamili la saizi<br>
                3. Akiba - Idadi ya bidhaa zilizopo
              </div>
            </div>

            <!-- Images -->
            <div class="col-12">
              <label class="form-label">Picha (kiwango cha juu 5)</label>
              <input type="file" id="prodImages" class="form-control" accept="image/*" multiple autocomplete="off">
              <div id="prodPreview" class="image-preview"></div>
            </div>

            <input type="hidden" id="editingProductId">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Funga</button>
          <button type="submit" class="btn btn-primary">
            <span id="productBtnText">Hifadhi Bidhaa</span>
            <span id="productSpinner" class="spinner-border spinner-border-sm" style="display: none;"></span>
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

  <!-- Add Customer Modal -->
  <div class="modal fade" id="modalAddCustomer" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <form id="customerForm">
          <div class="modal-header">
            <h5 class="modal-title">Ongeza / Hariri Mteja</h5>
            <button class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <label class="form-label">Jina la Kwanza</label>
              <input id="custFname" class="form-control" required autocomplete="off">
            </div>
            <div class="mb-3">
              <label class="form-label">Jina la Mwisho</label>
              <input id="custLname" class="form-control" required autocomplete="off">
            </div>
            <div class="mb-3">
              <label class="form-label">Namba ya Simu</label>
              <input id="custMobile" class="form-control" required autocomplete="off">
              <div class="invalid-feedback">
                Nambari ya simu tayari imesajiliwa au sio halali!
              </div>
            </div>
            <div class="mb-3">
              <label class="form-label">Barua pepe (hiari)</label>
              <input id="custEmail" class="form-control" autocomplete="off">
            </div>
            <div class="mb-3">
              <label class="form-label">Jinsia</label>
              <select id="custGender" class="form-select" required>
                <option value="">Chagua...</option>
                <option value="mwanaume">Mwanaume</option>
                <option value="mwanamke">Mwanamke</option>
                <option value="nyengine">Nyengine</option>
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label">Nenosiri</label>
              <input type="password" id="custPassword" class="form-control" required autocomplete="new-password">
            </div>
            <div class="mb-3">
              <label class="form-label">Rudia Nenosiri</label>
              <input type="password" id="custConfirmPassword" class="form-control" required autocomplete="new-password">
            </div>
            <input type="hidden" id="editingCustomerId">
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" data-bs-dismiss="modal">Funga</button>
            <button class="btn btn-primary" type="submit">
              <span id="customerBtnText">Hifadhi</span>
              <span id="customerSpinner" class="spinner-border spinner-border-sm" style="display: none;"></span>
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Add Ad Modal -->
  <div class="modal fade" id="modalAddAd" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <form id="adForm">
          <div class="modal-header">
            <h5 class="modal-title">Chapisha Tangazo Jipya</h5>
            <button class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <label class="form-label">Picha ya Tangazo</label>
              <input type="file" id="adImage" class="form-control" accept="image/*" required autocomplete="off">
            </div>
            <div class="mb-3">
              <label class="form-label">Kiungo (hiari)</label>
              <input id="adLink" class="form-control" placeholder="https://" autocomplete="off">
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" data-bs-dismiss="modal">Funga</button>
            <button class="btn btn-primary" type="submit">
              <span id="adBtnText">Chapisha Tangazo</span>
              <span id="adSpinner" class="spinner-border spinner-border-sm" style="display: none;"></span>
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Post Announcement Modal -->
  <div class="modal fade" id="modalPostAnnouncement" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <form id="announcementForm">
          <div class="modal-header">
            <h5 class="modal-title">Toa Arifa</h5>
            <button class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <label class="form-label">Arifa</label>
              <textarea id="announcementText" class="form-control" rows="4" required autocomplete="off"></textarea>
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" data-bs-dismiss="modal">Funga</button>
            <button class="btn btn-primary" type="submit">
              <span id="announcementBtnText">Toa</span>
              <span id="announcementSpinner" class="spinner-border spinner-border-sm" style="display: none;"></span>
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Send Message Modal -->
  <div class="modal fade" id="modalSendMessage" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <form id="sendMessageForm">
          <div class="modal-header">
            <h5 class="modal-title">Tuma Ujumbe / Barua Pepe kwa Mteja</h5>
            <button class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <label class="form-label">Chagua Mteja (hiari) - acha wazi kutuma kwa wote</label>
              <select id="selectCustomerMsg" class="form-select">
                <option value="">Tuma kwa wote</option>
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label">Ujumbe</label>
              <textarea id="msgBody" class="form-control" rows="4" required autocomplete="off"></textarea>
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" data-bs-dismiss="modal">Funga</button>
            <button class="btn btn-primary" type="submit">
              <span id="messageBtnText">Tuma</span>
              <span id="messageSpinner" class="spinner-border spinner-border-sm" style="display: none;"></span>
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Order Password Modal -->
  <div class="modal fade" id="modalConfirmPassword" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Thibitisha Agizo Limepokelewa (ingiza Nenosiri)</h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Namba ya Agizo</label>
            <input id="passwordOrderId" class="form-control" readonly>
          </div>
          <div class="mb-3">
            <label class="form-label">Ingiza Nenosiri la Mteja</label>
            <input type="password" id="passwordInput" class="form-control" placeholder="Ingiza nenosiri la mteja" autocomplete="new-password">
            <div class="form-text">
              Mteja atahitaji kuingiza nenosiri lake kuthibitisha kupokea agizo.
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Ghairi</button>
          <button class="btn btn-success" id="confirmPasswordBtn">
            <span id="passwordBtnText">Thibitisha</span>
            <span id="passwordSpinner" class="spinner-border spinner-border-sm" style="display: none;"></span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Add Admin Modal (Only for main admin) -->
  <div class="modal fade" id="modalAddAdmin" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <form id="adminForm">
          <div class="modal-header">
            <h5 class="modal-title" id="adminModalTitle">Ongeza Msimamizi Mpya</h5>
            <button class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <label class="form-label">Jina la Kwanza</label>
              <input id="adminFname" class="form-control" required autocomplete="off">
            </div>
            <div class="mb-3">
              <label class="form-label">Jina la Mwisho</label>
              <input id="adminLname" class="form-control" required autocomplete="off">
            </div>
            <div class="mb-3">
              <label class="form-label">Namba ya Simu</label>
              <input id="adminMobile" class="form-control" required autocomplete="off">
              <div class="invalid-feedback" id="adminMobileError">
                Nambari ya simu tayari imesajiliwa au sio halali!
              </div>
            </div>
            <div class="mb-3">
              <label class="form-label">Nenosiri</label>
              <input type="password" id="adminNewPassword" class="form-control" placeholder="Nenosiri" required autocomplete="new-password">
            </div>
            <div class="mb-3">
              <label class="form-label">Rudia Nenosiri</label>
              <input type="password" id="adminConfirmPassword" class="form-control" placeholder="Rudia Nenosiri" required autocomplete="new-password">
            </div>
            <input type="hidden" id="editingAdminId">
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" data-bs-dismiss="modal">Funga</button>
            <button class="btn btn-primary" type="submit">
              <span id="adminBtnText">Hifadhi</span>
              <span id="adminSpinner" class="spinner-border spinner-border-sm" style="display: none;"></span>
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // API Configuration
    const API_BASE_URL = 'https://api.fourbrothers.online/api/admin';
    let authToken = localStorage.getItem('adminToken') || '';
    let currentAdmin = null;
    let unreadNotifications = 0;
    let notificationInterval;
    const REFRESH_INTERVAL = 30000; // 30 seconds
    
    // Check if already logged in
    if (authToken) {
      checkAdminAuth();
    }

    // Terms Toggle Functionality
    document.getElementById('termsToggle').addEventListener('click', function() {
      const content = document.getElementById('termsContent');
      const icon = this.querySelector('.fa-chevron-down');
      content.classList.toggle('show');
      icon.classList.toggle('fa-rotate-180');
    });

    // API Helper Functions
    async function apiCall(endpoint, options = {}) {
      const url = `${API_BASE_URL}${endpoint}`;
      
      const config = {
        headers: {
          'Content-Type': 'application/json',
          ...options.headers
        },
        ...options
      };
      
      // Add auth token if available
      if (authToken) {
        config.headers.Authorization = `Bearer ${authToken}`;
      }
      
      try {
        const response = await fetch(url, config);
        
        if (response.status === 401) {
          // Token expired or invalid
          logout();
          throw new Error('Umelazimishwa kuingia tena');
        }
        
        const data = await response.json();
        
        if (!response.ok) {
          throw new Error(data.message || `HTTP error! status: ${response.status}`);
        }
        
        return data;
      } catch (error) {
        console.error('API Error:', error);
        showAlert(error.message, 'danger');
        throw error;
      }
    }

    async function apiCallWithFormData(endpoint, formData, method = 'POST') {
      const url = `${API_BASE_URL}${endpoint}`;
      
      const config = {
        method: method,
        headers: {
          'Authorization': `Bearer ${authToken}`
        },
        body: formData
      };
      
      try {
        const response = await fetch(url, config);
        
        if (response.status === 401) {
          logout();
          throw new Error('Umelazimishwa kuingia tena');
        }
        
        const data = await response.json();
        
        if (!response.ok) {
          throw new Error(data.message || `HTTP error! status: ${response.status}`);
        }
        
        return data;
      } catch (error) {
        console.error('API Error:', error);
        showAlert(error.message, 'danger');
        throw error;
      }
    }

    // Alert Helper
    function showAlert(message, type = 'info') {
      const alertDiv = document.getElementById('apiAlert');
      alertDiv.textContent = message;
      alertDiv.className = `alert alert-${type} animate__animated animate__fadeIn`;
      alertDiv.style.display = 'block';
      
      setTimeout(() => {
        alertDiv.classList.add('animate__fadeOut');
        setTimeout(() => {
          alertDiv.style.display = 'none';
          alertDiv.classList.remove('animate__fadeOut');
        }, 500);
      }, 5000);
    }

    function showLoginAlert(message, type = 'danger') {
      const alertDiv = document.getElementById('loginAlert');
      alertDiv.textContent = message;
      alertDiv.className = `alert alert-${type} animate__animated animate__shakeX`;
      alertDiv.style.display = 'block';
      
      setTimeout(() => {
        alertDiv.style.display = 'none';
      }, 5000);
    }
    
    function hideLoginAlert() {
      document.getElementById('loginAlert').style.display = 'none';
    }

    // Format price in TSh
    const formatPrice = (price) => {
      return 'TSh ' + Number(price).toLocaleString('en-TZ');
    };

    // ===============================
    // NOTIFICATION COUNTS SYSTEM
    // ===============================
    async function loadNotificationCounts() {
      try {
        const counts = await apiCall('/notifications/unread-counts');
        
        // Update notification badges
        updateNotificationBadge('notifications', counts.unread_customer_notifications);
        updateNotificationBadge('orders', counts.unread_order_notifications);
        
        // Update title badge
        const titleBadge = document.getElementById('notificationCountTitle');
        if (titleBadge) {
          titleBadge.textContent = counts.unread_customer_notifications;
        }
        
        // Update quick action button
        const quickCount = document.getElementById('quickMessageCount');
        if (quickCount) {
          if (counts.unread_customer_notifications > 0) {
            quickCount.textContent = counts.unread_customer_notifications;
            quickCount.style.display = 'inline-block';
          } else {
            quickCount.style.display = 'none';
          }
        }
        
        return counts;
      } catch (error) {
        console.error('Error loading notification counts:', error);
        return {
          unread_customer_notifications: 0,
          unread_order_notifications: 0
        };
      }
    }

    function updateNotificationBadge(section, count) {
      const navLink = document.querySelector(`[data-section="${section}"]`);
      if (!navLink) return;
      
      let badge = navLink.querySelector('.notification-badge');
      
      if (!badge && count > 0) {
        badge = document.createElement('span');
        badge.className = 'notification-badge';
        navLink.appendChild(badge);
      }
      
      if (badge) {
        if (count > 0) {
          badge.textContent = count;
          badge.style.display = 'flex';
        } else {
          badge.style.display = 'none';
        }
      }
    }

    async function markNotificationRead(notificationId) {
      try {
        await apiCall(`/notifications/mark-read/${notificationId}`, {
          method: 'PUT'
        });
        
        await loadNotificationCounts();
      } catch (error) {
        console.error('Error marking notification as read:', error);
      }
    }

    async function markOrderViewed(orderId) {
      try {
        await apiCall(`/orders/mark-viewed/${orderId}`, {
          method: 'PUT'
        });
        
        await loadNotificationCounts();
      } catch (error) {
        console.error('Error marking order as viewed:', error);
      }
    }

    // Start auto-refresh for notification counts
    function startAutoRefresh() {
      if (notificationInterval) {
        clearInterval(notificationInterval);
      }
      
      notificationInterval = setInterval(async () => {
        try {
          const activeModal = document.querySelector('.modal.show');
          if (!activeModal) {
            await loadNotificationCounts();
            
            const currentSection = document.querySelector('.section:not(.d-none)').id;
            if (currentSection === 'dashboard') {
              await loadDashboardData();
            }
          }
        } catch (error) {
          console.error('Auto-refresh error:', error);
        }
      }, REFRESH_INTERVAL);
    }

    // Stop auto-refresh
    function stopAutoRefresh() {
      if (notificationInterval) {
        clearInterval(notificationInterval);
        notificationInterval = null;
      }
    }

    // Check admin authentication
    async function checkAdminAuth() {
      try {
        const response = await apiCall('/dashboard/stats');
        document.getElementById('loginPage').style.display = 'none';
        document.getElementById('adminPanel').style.display = 'block';
        
        const storedAdmin = localStorage.getItem('adminData');
        if (storedAdmin) {
          currentAdmin = JSON.parse(storedAdmin);
          document.getElementById('adminNameDisplay').textContent = currentAdmin.first_name + ' ' + currentAdmin.last_name;
          document.getElementById('adminRoleDisplay').textContent = currentAdmin.can_manage_admins ? 'Msimamizi Mkuu' : 'Msimamizi';
          
          if (currentAdmin.can_manage_admins) {
            document.getElementById('adminsNavLink').style.display = 'block';
          }
        }
        
        loadDashboardData();
        startAutoRefresh();
      } catch (error) {
        console.log('Not authenticated:', error);
        logout();
      }
    }

    // ===============================
    // ADMIN AUTHENTICATION
    // ===============================
    document.getElementById('adminLoginForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      // Reset validation
      const mobileInput = document.getElementById('adminMobileLogin');
      const passwordInput = document.getElementById('adminPassword');
      const mobileError = document.getElementById('mobileError');
      const passwordError = document.getElementById('passwordError');
      
      mobileInput.classList.remove('is-invalid');
      passwordInput.classList.remove('is-invalid');
      
      let isValid = true;
      
      const mobile = mobileInput.value.trim();
      const password = passwordInput.value;
      
      if (!mobile) {
        mobileInput.classList.add('is-invalid');
        mobileError.textContent = 'Tafadhali ingiza nambari ya simu';
        isValid = false;
      }
      
      if (!password) {
        passwordInput.classList.add('is-invalid');
        passwordError.textContent = 'Tafadhali ingiza nenosiri';
        isValid = false;
      }
      
      if (!isValid) {
        return;
      }
      
      document.getElementById('loginBtnText').style.display = 'none';
      document.getElementById('loginSpinner').style.display = 'inline-block';
      
      try {
        const response = await fetch(`${API_BASE_URL}/login`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ mobile, password })
        });
        
        const data = await response.json();
        
        if (response.ok) {
          authToken = data.token;
          currentAdmin = data.admin;
          localStorage.setItem('adminToken', authToken);
          localStorage.setItem('adminData', JSON.stringify(data.admin));
          
          document.getElementById('loginPage').style.display = 'none';
          document.getElementById('adminPanel').style.display = 'block';
          document.getElementById('adminNameDisplay').textContent = currentAdmin.first_name + ' ' + currentAdmin.last_name;
          document.getElementById('adminRoleDisplay').textContent = currentAdmin.can_manage_admins ? 'Msimamizi Mkuu' : 'Msimamizi';
          
          if (currentAdmin.can_manage_admins) {
            document.getElementById('adminsNavLink').style.display = 'block';
          }
          
          startAutoRefresh();
          loadDashboardData();
          
        } else {
          showLoginAlert(data.message || 'Ingio imeshindikana');
        }
      } catch (error) {
        console.error('Login Error:', error);
        showLoginAlert('Hitilafu ya mtandao. Tafadhali jaribu tena.');
      } finally {
        document.getElementById('loginBtnText').style.display = 'inline-block';
        document.getElementById('loginSpinner').style.display = 'none';
      }
    });
    
    // Forgot Password Button
    document.getElementById('forgotPasswordBtn').addEventListener('click', function() {
      document.getElementById('adminLoginForm').style.display = 'none';
      document.getElementById('forgotPasswordSection').style.display = 'block';
      hideLoginAlert();
    });
    
    // Back to Login Button
    document.getElementById('backToLoginBtn').addEventListener('click', function() {
      document.getElementById('forgotPasswordSection').style.display = 'none';
      document.getElementById('resetOptionsSection').style.display = 'none';
      document.getElementById('resetPasswordFormSection').style.display = 'none';
      document.getElementById('resetMobileFormSection').style.display = 'none';
      document.getElementById('adminLoginForm').style.display = 'block';
      hideLoginAlert();
    });
    
    // Back to Forgot Button
    document.getElementById('backToForgotBtn').addEventListener('click', function() {
      document.getElementById('resetOptionsSection').style.display = 'none';
      document.getElementById('forgotPasswordSection').style.display = 'block';
    });
    
    // Back to Options Buttons
    document.getElementById('backToOptionsBtn').addEventListener('click', function() {
      document.getElementById('resetPasswordFormSection').style.display = 'none';
      document.getElementById('resetOptionsSection').style.display = 'block';
    });
    
    document.getElementById('backToOptionsBtn2').addEventListener('click', function() {
      document.getElementById('resetMobileFormSection').style.display = 'none';
      document.getElementById('resetOptionsSection').style.display = 'block';
    });
    
    // Forgot Password Form
    document.getElementById('forgotPasswordForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const firstName = document.getElementById('forgotFirstName').value.trim();
      const lastName = document.getElementById('forgotLastName').value.trim();
      
      if (!firstName || !lastName) {
        showLoginAlert('Tafadhali jaza jina la kwanza na la mwisho');
        return;
      }
      
      document.getElementById('resetBtnText').style.display = 'none';
      document.getElementById('resetSpinner').style.display = 'inline-block';
      
      try {
        const response = await fetch(`${API_BASE_URL}/forgot-password`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ first_name: firstName, last_name: lastName })
        });
        
        const data = await response.json();
        
        if (response.ok) {
          document.getElementById('forgotPasswordSection').style.display = 'none';
          document.getElementById('resetOptionsSection').style.display = 'block';
          hideLoginAlert();
        } else {
          showLoginAlert(data.message || 'Msimamizi huyu hakupatikana');
        }
      } catch (error) {
        console.error('Forgot Password Error:', error);
        showLoginAlert('Hitilafu ya mtandao. Tafadhali jaribu tena.');
      } finally {
        document.getElementById('resetBtnText').style.display = 'inline-block';
        document.getElementById('resetSpinner').style.display = 'none';
      }
    });
    
    // Reset Password Option
    document.getElementById('resetPasswordOptionBtn').addEventListener('click', function() {
      document.getElementById('resetOptionsSection').style.display = 'none';
      document.getElementById('resetPasswordFormSection').style.display = 'block';
    });
    
    // Reset Mobile Option
    document.getElementById('resetMobileOptionBtn').addEventListener('click', function() {
      document.getElementById('resetOptionsSection').style.display = 'none';
      document.getElementById('resetMobileFormSection').style.display = 'block';
    });
    
    // New Password Form
    document.getElementById('newPasswordForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const newPassword = document.getElementById('newPassword').value;
      const confirmPassword = document.getElementById('confirmNewPassword').value;
      const firstName = document.getElementById('forgotFirstName').value.trim();
      const lastName = document.getElementById('forgotLastName').value.trim();
      
      if (!newPassword || !confirmPassword) {
        showLoginAlert('Tafadhali jaza nenosiri jipya na urudie');
        return;
      }
      
      if (newPassword !== confirmPassword) {
        showLoginAlert('Nenosiri halifanani');
        return;
      }
      
      document.getElementById('newPasswordBtnText').style.display = 'none';
      document.getElementById('newPasswordSpinner').style.display = 'inline-block';
      
      try {
        const forgotResponse = await fetch(`${API_BASE_URL}/forgot-password`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ first_name: firstName, last_name: lastName })
        });
        
        const forgotData = await forgotResponse.json();
        
        if (forgotResponse.ok) {
          const resetResponse = await fetch(`${API_BASE_URL}/reset-password`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              reset_token: forgotData.reset_token,
              new_password: newPassword,
              confirm_password: confirmPassword
            })
          });
          
          const resetData = await resetResponse.json();
          
          if (resetResponse.ok) {
            showLoginAlert('Nenosiri limebadilishwa kikamilifu! Unaweza kuingia sasa.', 'success');
            
            setTimeout(() => {
              document.getElementById('resetPasswordFormSection').style.display = 'none';
              document.getElementById('adminLoginForm').style.display = 'block';
              document.getElementById('adminLoginForm').reset();
              document.getElementById('newPasswordForm').reset();
              document.getElementById('forgotPasswordForm').reset();
              hideLoginAlert();
            }, 2000);
          } else {
            showLoginAlert(resetData.message || 'Hitilafu katika kubadilisha nenosiri');
          }
        } else {
          showLoginAlert(forgotData.message || 'Hitilafu katika kuthibitisha utambulisho');
        }
      } catch (error) {
        console.error('Reset Password Error:', error);
        showLoginAlert('Hitilafu ya mtandao. Tafadhali jaribu tena.');
      } finally {
        document.getElementById('newPasswordBtnText').style.display = 'inline-block';
        document.getElementById('newPasswordSpinner').style.display = 'none';
      }
    });
    
    // New Mobile Form
    document.getElementById('newMobileForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const newMobile = document.getElementById('newMobile').value.trim();
      const confirmMobile = document.getElementById('confirmNewMobile').value.trim();
      const firstName = document.getElementById('forgotFirstName').value.trim();
      const lastName = document.getElementById('forgotLastName').value.trim();
      
      if (!newMobile || !confirmMobile) {
        showLoginAlert('Tafadhali jaza nambari ya simu na urudie');
        return;
      }
      
      if (newMobile !== confirmMobile) {
        showLoginAlert('Nambari za simu hazifanani');
        return;
      }
      
      document.getElementById('newMobileBtnText').style.display = 'none';
      document.getElementById('newMobileSpinner').style.display = 'inline-block';
      
      try {
        const response = await fetch(`${API_BASE_URL}/change-mobile`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            first_name: firstName,
            last_name: lastName,
            new_mobile: newMobile,
            confirm_mobile: confirmMobile
          })
        });
        
        const data = await response.json();
        
        if (response.ok) {
          showLoginAlert('Nambari ya simu imebadilishwa kikamilifu! Unaweza kuingia sasa.', 'success');
          
          setTimeout(() => {
            document.getElementById('resetMobileFormSection').style.display = 'none';
            document.getElementById('adminLoginForm').style.display = 'block';
            document.getElementById('adminLoginForm').reset();
            document.getElementById('newMobileForm').reset();
            document.getElementById('forgotPasswordForm').reset();
            hideLoginAlert();
          }, 2000);
        } else {
          showLoginAlert(data.message || 'Hitilafu katika kubadilisha nambari ya simu');
        }
      } catch (error) {
        console.error('Change Mobile Error:', error);
        showLoginAlert('Hitilafu ya mtandao. Tafadhali jaribu tena.');
      } finally {
        document.getElementById('newMobileBtnText').style.display = 'inline-block';
        document.getElementById('newMobileSpinner').style.display = 'none';
      }
    });

    // ===============================
    // DASHBOARD DATA
    // ===============================
    async function loadDashboardData() {
      try {
        const stats = await apiCall('/dashboard/stats');
        
        document.getElementById('totalUsers').innerText = stats.total_customers || 0;
        document.getElementById('totalProducts').innerText = stats.total_products || 0;
        document.getElementById('totalIncome').innerText = formatPrice(stats.total_income || 0);
        document.getElementById('totalOrders').innerText = stats.total_ordered_products || 0;
        
        updateIncomeChart(stats.monthly_income || []);
        
        await loadNotificationCounts();
        await loadProducts();
        await loadCustomers();
        await loadAds();
        await loadOrders();
        await loadNotifications();
        
        if (currentAdmin && currentAdmin.can_manage_admins) {
          await loadAdmins();
        }
        
      } catch (error) {
        console.error('Error loading dashboard data:', error);
        document.getElementById('totalUsers').innerText = 0;
        document.getElementById('totalProducts').innerText = 0;
        document.getElementById('totalIncome').innerText = formatPrice(0);
        document.getElementById('totalOrders').innerText = 0;
        updateIncomeChart([]);
      }
    }

    function updateIncomeChart(monthlyData) {
      const ctx = document.getElementById('incomeChart').getContext('2d');
      
      if (window.incomeChart && typeof window.incomeChart.destroy === 'function') {
        window.incomeChart.destroy();
      }
      
      const months = monthlyData.map(item => item.month) || [];
      const income = monthlyData.map(item => item.income) || [];
      
      if (months.length === 0) {
        months.push('Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec');
        income.push(0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0);
      }
      
      try {
        window.incomeChart = new Chart(ctx, {
          type: 'line',
          data: {
            labels: months,
            datasets: [{
              label: 'Mapato (TSh)',
              data: income,
              fill: true,
              tension: 0.4,
              backgroundColor: 'rgba(52, 152, 219, 0.1)',
              borderColor: 'rgba(52, 152, 219, 1)',
              borderWidth: 3,
              pointBackgroundColor: 'rgba(52, 152, 219, 1)',
              pointBorderColor: '#fff',
              pointBorderWidth: 2,
              pointRadius: 5,
              pointHoverRadius: 7
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { 
                display: true,
                position: 'top',
                labels: {
                  font: {
                    size: 12
                  },
                  padding: 20
                }
              },
              tooltip: {
                mode: 'index',
                intersect: false,
                backgroundColor: 'rgba(0, 0, 0, 0.7)',
                titleFont: {
                  size: 12
                },
                bodyFont: {
                  size: 12
                },
                padding: 12,
                callbacks: {
                  label: function(context) {
                    let label = context.dataset.label || '';
                    if (label) {
                      label += ': ';
                    }
                    label += 'TSh ' + context.parsed.y.toLocaleString('en-TZ');
                    return label;
                  }
                }
              }
            },
            scales: {
              x: {
                grid: {
                  display: true,
                  color: 'rgba(0, 0, 0, 0.05)'
                },
                ticks: {
                  font: {
                    size: 11
                  }
                }
              },
              y: {
                beginAtZero: true,
                grid: {
                  display: true,
                  color: 'rgba(0, 0, 0, 0.05)'
                },
                ticks: {
                  font: {
                    size: 11
                  },
                  callback: function(value) {
                    return 'TSh ' + value.toLocaleString('en-TZ');
                  }
                }
              }
            },
            interaction: {
              intersect: false,
              mode: 'nearest'
            },
            animations: {
              tension: {
                duration: 1000,
                easing: 'linear'
              }
            }
          }
        });
      } catch (error) {
        console.error('Error creating chart:', error);
        ctx.fillStyle = '#f8f9fa';
        ctx.fillRect(0, 0, ctx.canvas.width, ctx.canvas.height);
        ctx.fillStyle = '#6c757d';
        ctx.textAlign = 'center';
        ctx.font = '14px Arial';
        ctx.fillText('Chart could not be loaded', ctx.canvas.width / 2, ctx.canvas.height / 2);
      }
    }

    // ===============================
    // PRODUCTS MANAGEMENT - MULTI-SIZE APPROACH
    // ===============================
    let products = [];

    // Size Management System
    const sizeManager = {
      container: null,
      
      init: function() {
        this.container = document.getElementById('sizesContainer');
        this.addDefaultSizeRow();
        this.bindEvents();
      },
      
      addDefaultSizeRow: function() {
        this.container.innerHTML = '';
        this.addSizeRow();
      },
      
      addSizeRow: function(sizeData = { code: '', label: '', stock: 0 }) {
        const sizeRow = document.createElement('div');
        sizeRow.className = 'row g-2 mb-2 size-row';
        sizeRow.innerHTML = `
          <div class="col-md-3">
            <input type="text" class="form-control size-code" placeholder="Kifupi (39, M, XL)" 
                  value="${sizeData.code || ''}" required autocomplete="off">
            <div class="invalid-feedback">Kifupi cha saizi kinahitajika</div>
          </div>
          <div class="col-md-5">
            <input type="text" class="form-control size-label" placeholder="Jina kamili (39 EU, Medium)" 
                  value="${sizeData.label || ''}" required autocomplete="off">
            <div class="invalid-feedback">Jina kamili la saizi linahitajika</div>
          </div>
          <div class="col-md-3">
            <input type="number" class="form-control size-stock" placeholder="Akiba" 
                  min="0" value="${sizeData.stock || 0}" required autocomplete="off">
            <div class="invalid-feedback">Akiba inahitajika</div>
          </div>
          <div class="col-md-1">
            <button type="button" class="btn btn-danger btn-sm remove-size" ${this.getRowCount() === 0 ? 'disabled' : ''}>
              <i class="fa fa-times"></i>
            </button>
          </div>
        `;
        
        this.container.appendChild(sizeRow);
        
        const removeBtn = sizeRow.querySelector('.remove-size');
        removeBtn.addEventListener('click', () => {
          if (this.getRowCount() > 1) {
            sizeRow.remove();
            this.updateRemoveButtons();
          }
        });
        
        this.updateRemoveButtons();
      },
      
      bindEvents: function() {
        document.getElementById('addSizeBtn').addEventListener('click', () => {
          this.addSizeRow();
        });
        
        this.updateRemoveButtons();
      },
      
      getRowCount: function() {
        return document.querySelectorAll('.size-row').length;
      },
      
      updateRemoveButtons: function() {
        const sizeRows = document.querySelectorAll('.size-row');
        const removeButtons = document.querySelectorAll('.remove-size');
        
        if (sizeRows.length <= 1) {
          removeButtons.forEach(btn => btn.disabled = true);
        } else {
          removeButtons.forEach(btn => btn.disabled = false);
        }
      },
      
      getSizesData: function() {
        const sizeRows = document.querySelectorAll('.size-row');
        const sizes = [];
        
        sizeRows.forEach(row => {
          const codeInput = row.querySelector('.size-code');
          const labelInput = row.querySelector('.size-label');
          const stockInput = row.querySelector('.size-stock');
          
          const code = codeInput.value.trim();
          const label = labelInput.value.trim();
          const stock = parseInt(stockInput.value) || 0;
          
          // Validate inputs
          let isValid = true;
          
          if (!code) {
            codeInput.classList.add('is-invalid');
            isValid = false;
          } else {
            codeInput.classList.remove('is-invalid');
          }
          
          if (!label) {
            labelInput.classList.add('is-invalid');
            isValid = false;
          } else {
            labelInput.classList.remove('is-invalid');
          }
          
          if (stock < 0) {
            stockInput.classList.add('is-invalid');
            isValid = false;
          } else {
            stockInput.classList.remove('is-invalid');
          }
          
          if (isValid) {
            sizes.push({
              code: code,
              label: label,
              stock: stock
            });
          }
        });
        
        return sizes;
      },
      
      setSizesData: function(sizes) {
        this.container.innerHTML = '';
        
        if (sizes && sizes.length > 0) {
          // Add all sizes from data
          sizes.forEach(size => {
            this.addSizeRow({
              code: size.size_code || size.code || '',
              label: size.size_label || size.label || '',
              stock: size.stock || 0
            });
          });
        } else {
          // Add one empty row if no sizes
          this.addSizeRow();
        }
        
        this.updateRemoveButtons();
      },
      
      validateSizes: function() {
        const sizeRows = document.querySelectorAll('.size-row');
        if (sizeRows.length === 0) {
          showAlert('Tafadhali angalau ongeza saizi moja', 'warning');
          return false;
        }
        
        let hasValidSize = false;
        const sizes = this.getSizesData();
        
        if (sizes.length === 0) {
          showAlert('Tafadhali angalau ongeza saizi moja', 'warning');
          return false;
        }
        
        return true;
      }
    };

    // Initialize size manager
    if (document.getElementById('sizesContainer')) {
      sizeManager.init();
    }

    // Get correct image URL
    function fixImagePath(path) {
      if (!path) return '';
      if (path.startsWith('http')) return path;
      if (path.startsWith('/')) {
        return `https://api.fourbrothers.online${path}`;
      }
      return `https://api.fourbrothers.online/${path}`;
    }

        // LOAD PRODUCTS
        async function loadProducts() {
          try {
            products = await apiCall('/products');
            renderProductsTable();
            renderProductsMobileCards();
          } catch (error) {
            console.error('Error loading products:', error);
            showAlert('Hitilafu katika kupakia bidhaa', 'danger');
            products = [];
            renderProductsTable();
            renderProductsMobileCards();
          }
        }

    // ADD / EDIT PRODUCT FORM SUBMIT
    document.getElementById('productForm').addEventListener('submit', async function(e) {
      e.preventDefault();

      // Reset validation
      const inputs = this.querySelectorAll('input, select');
      inputs.forEach(input => input.classList.remove('is-invalid'));
      
      // Validate required fields
      let isValid = true;
      
      if (!document.getElementById('prodTitle').value.trim()) {
        document.getElementById('prodTitle').classList.add('is-invalid');
        isValid = false;
      }
      
      if (!document.getElementById('prodBrand').value) {
        document.getElementById('prodBrand').classList.add('is-invalid');
        isValid = false;
      }
      
      if (!document.getElementById('prodColor').value) {
        document.getElementById('prodColor').classList.add('is-invalid');
        isValid = false;
      }
      
      if (!document.getElementById('prodType').value) {
        document.getElementById('prodType').classList.add('is-invalid');
        isValid = false;
      }
      
      const price = document.getElementById('prodPrice').value;
      if (!price || price <= 0) {
        document.getElementById('prodPrice').classList.add('is-invalid');
        isValid = false;
      }
      
      if (!isValid) {
        showAlert('Tafadhali jaza sehemu zote zinazohitajika', 'warning');
        return;
      }
      
      if (!sizeManager.validateSizes()) {
        return;
      }

      const productId = document.getElementById('editingProductId').value;
      const formData = new FormData();

      formData.append('name', document.getElementById('prodTitle').value);
      formData.append('company', document.getElementById('prodBrand').value);
      formData.append('color', document.getElementById('prodColor').value);
      formData.append('discount_percent', document.getElementById('prodOffer').value || 0);
      formData.append('type', document.getElementById('prodType').value);
      formData.append('price', document.getElementById('prodPrice').value);
      formData.append('description', document.getElementById('prodDescription').value || '');

      const sizesData = sizeManager.getSizesData();
      formData.append('sizes', JSON.stringify(sizesData));

      const imageFiles = document.getElementById('prodImages').files;
      for (let i = 0; i < imageFiles.length; i++) {
        formData.append('images', imageFiles[i]);
      }

      document.getElementById('productBtnText').style.display = 'none';
      document.getElementById('productSpinner').style.display = 'inline-block';

      try {
        let result;
        if (productId) {
          result = await apiCallWithFormData(`/products/${productId}`, formData, 'PUT');
          showAlert('Bidhaa imesasishwa kikamilifu', 'success');
        } else {
          result = await apiCallWithFormData('/products', formData);
          showAlert('Bidhaa imeongezwa kikamilifu', 'success');
        }

        this.reset();
        document.getElementById('prodPreview').innerHTML = '';
        document.getElementById('editingProductId').value = '';
        sizeManager.setSizesData([]);
        
        const productModal = bootstrap.Modal.getInstance(document.getElementById('modalAddProduct'));
        if (productModal) {
          productModal.hide();
        }

        await loadProducts();
        
        // Reload the products array with fresh data
        products = await apiCall('/products');
      } catch (error) {
        console.error('Error saving product:', error);
        showAlert(error.message || 'Hitilafu katika kuhifadhi bidhaa', 'danger');
      } finally {
        document.getElementById('productBtnText').style.display = 'inline-block';
        document.getElementById('productSpinner').style.display = 'none';
      }
    });

    // RENDER PRODUCTS TABLE
    function renderProductsTable(filter = '') {
      const tbody = document.getElementById('productsTableBody');
      tbody.innerHTML = '';

      const productList = Array.isArray(products) ? products : [];
      const filteredProducts = productList.filter(p => {
        if (!p) return false;
        const search = (p.name + ' ' + (p.company || '') + ' ' + (p.color || '')).toLowerCase();
        return search.includes(filter.toLowerCase());
      });

      if (filteredProducts.length === 0) {
        tbody.innerHTML = `
          <tr><td colspan="12" class="text-center py-4 text-muted">
            ${productList.length === 0 ? 'Hakuna bidhaa zilizopatikana' : 'Hakuna bidhaa zilizoambatana na utafutaji'}
          </td></tr>`;
        return;
      }

      filteredProducts.forEach((product, index) => {
        const tr = document.createElement('tr');
        const imageUrl = product.images?.length > 0 ? fixImagePath(product.images[0]) : '';
        
        let sizesDisplay = 'Hakuna saizi';
        let totalStock = 0;
        
        if (product.sizes && product.sizes.length > 0) {
          sizesDisplay = product.sizes.map(size => 
            `${size.size_label || size.label} (${size.stock || 0})`
          ).join(', ');
          
          totalStock = product.sizes.reduce((sum, size) => sum + (parseInt(size.stock) || 0), 0);
        } else if (product.stock) {
          totalStock = product.stock;
          sizesDisplay = product.size_us ? `${product.size_us} (${product.stock})` : `${product.stock} units`;
        }

        tr.innerHTML = `
          <td>${index + 1}</td>
          <td><img src="${imageUrl}" class="product-thumb" alt="${product.name}"
              onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA2MCA2MCI+PHJlY3Qgd2lkdGg9IjYwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjZjBmMGYwIi8+PHRleHQgeD0iMzAiIHk9IjMwIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTAiIGZpbGw9IiM5OTkiIHRleHQtYW5jaG9yPSJtaWRkbGUiPkVycm9yPC90ZXh0Pjwvc3ZnPg=='"></td>
          <td>${product.company || '-'}</td>
          <td>${product.name || 'No Name'}</td>
          <td>${product.color || '-'}</td>
          <td>${product.discount_percent || 0}%</td>
          <td>${product.type || '-'}</td>
          <td>${sizesDisplay}</td>
          <td>${totalStock}</td>
          <td>${formatPrice(product.price || 0)}</td>
          <td>
            <button class="btn btn-sm btn-outline-primary me-1" onclick="editProduct('${product.id}')">Hariri</button>
            <button class="btn btn-sm btn-outline-danger" onclick="deleteProduct('${product.id}')">Futa</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    // RENDER PRODUCTS MOBILE CARDS
    function renderProductsMobileCards(filter = '') {
      const container = document.getElementById('productsMobileCards');
      container.innerHTML = '';

      const productList = Array.isArray(products) ? products : [];
      const filteredProducts = productList.filter(p => {
        if (!p) return false;
        const search = (p.name + ' ' + (p.company || '') + ' ' + (p.color || '')).toLowerCase();
        return search.includes(filter.toLowerCase());
      });

      if (filteredProducts.length === 0) {
        container.innerHTML = `<div class="text-center py-4 text-muted">
          ${productList.length === 0 ? 'Hakuna bidhaa zilizopatikana' : 'Hakuna bidhaa zilizoambatana na utafutaji'}
        </div>`;
        return;
      }

      filteredProducts.forEach((product, index) => {
        const imageUrl = product.images?.length > 0 ? fixImagePath(product.images[0]) : '';
        
        let totalStock = 0;
        let sizesDisplay = 'Hakuna saizi';
        
        if (product.sizes && product.sizes.length > 0) {
          totalStock = product.sizes.reduce((sum, size) => sum + (parseInt(size.stock) || 0), 0);
          sizesDisplay = product.sizes.map(size => 
            `${size.size_label || size.label} (${size.stock || 0})`
          ).join(', ');
        } else if (product.stock) {
          totalStock = product.stock;
          sizesDisplay = product.size_us ? `${product.size_us} (${product.stock})` : `${product.stock} units`;
        }

        const card = document.createElement('div');
        card.className = 'mobile-card';
        card.innerHTML = `
          <div class="mobile-card-row">
            <div class="mobile-card-label">#</div>
            <div class="mobile-card-value">${index + 1}</div>
          </div>
          <div class="mobile-card-row">
            <div class="mobile-card-label">Picha</div>
            <div class="mobile-card-value">
              <img src="${imageUrl}" style="width:50px;height:50px;object-fit:cover;border-radius:5px;"
                  alt="${product.name}"
                  onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA2MCA2MCI+PHJlY3Qgd2lkdGg9IjYwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjZjBmMGYwIi8+PHRleHQgeD0iMzAiIHk9IjMwIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTAiIGZpbGw9IiM5OTkiIHRleHQtYW5jaG9yPSJtaWRkbGUiPkVycm9yPC90ZXh0Pjwvc3ZnPg=='">
            </div>
          </div>
          <div class="mobile-card-row"><div class="mobile-card-label">Kampuni</div><div class="mobile-card-value">${product.company || '-'}</div></div>
          <div class="mobile-card-row"><div class="mobile-card-label">Jina</div><div class="mobile-card-value">${product.name || '-'}</div></div>
          <div class="mobile-card-row"><div class="mobile-card-label">Rangi</div><div class="mobile-card-value">${product.color || '-'}</div></div>
          <div class="mobile-card-row"><div class="mobile-card-label">Punguzo</div><div class="mobile-card-value">${product.discount_percent || 0}%</div></div>
          <div class="mobile-card-row"><div class="mobile-card-label">Aina</div><div class="mobile-card-value">${product.type || '-'}</div></div>
          <div class="mobile-card-row"><div class="mobile-card-label">Saizi</div><div class="mobile-card-value">${sizesDisplay}</div></div>
          <div class="mobile-card-row"><div class="mobile-card-label">Jumla ya Akiba</div><div class="mobile-card-value">${totalStock}</div></div>
          <div class="mobile-card-row"><div class="mobile-card-label">Bei</div><div class="mobile-card-value">${formatPrice(product.price || 0)}</div></div>
          <div class="mobile-card-row">
            <div class="mobile-card-label">Vitendo</div>
            <div class="mobile-card-value">
              <button class="btn btn-sm btn-outline-primary me-1" onclick="editProduct('${product.id}')">Hariri</button>
              <button class="btn btn-sm btn-outline-danger" onclick="deleteProduct('${product.id}')">Futa</button>
            </div>
          </div>
        `;
        container.appendChild(card);
      });
    }

        // EDIT PRODUCT
        async function editProduct(id) {
          try {
            // Load fresh product data from API
            const product = await apiCall(`/products/${id}`);
            
            if (!product) {
              showAlert('Bidhaa haijapatikana', 'danger');
              return;
            }

            document.getElementById('editingProductId').value = product.id;
            
            // Fill basic product info
            document.getElementById('prodTitle').value = product.name || '';
            document.getElementById('prodBrand').value = product.company || '';
            document.getElementById('prodColor').value = product.color || '';
            document.getElementById('prodOffer').value = product.discount_percent || 0;
            document.getElementById('prodType').value = product.type || '';
            document.getElementById('prodPrice').value = product.price || 0;
            document.getElementById('prodDescription').value = product.description || '';

            // Load sizes - handle both property naming conventions
            if (product.sizes && product.sizes.length > 0) {
              sizeManager.setSizesData(product.sizes.map(size => ({
                code: size.size_code || size.code || '',
                label: size.size_label || size.label || '',
                stock: size.stock || 0
              })));
            } else {
              // Fallback for old products with single size
              sizeManager.setSizesData([{
                code: product.size_us || '',
                label: product.size_us || '',
                stock: product.stock || 0
              }]);
            }

            const preview = document.getElementById('prodPreview');
            preview.innerHTML = '';

            if (product.images && product.images.length > 0) {
              product.images.forEach(imgPath => {
                const img = document.createElement('img');
                img.src = fixImagePath(imgPath);
                img.onerror = function () {
                  this.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iODAiIHZpZXdCb3g9IjAgMCA4MCA4MCI+PHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjgwIiBmaWxsPSIjZjBmMGYwIi8+PHRleHQgeD0iNDAiIHk9IjQwIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTIiIGZpbGw9IiM5OTkiIHRleHQtYW5jaG9yPSJtaWRkbGUiPkVycm9yPC90ZXh0Pjwvc3ZnPg==';
                };
                img.style.width = '80px';
                img.style.height = '80px';
                img.style.objectFit = 'cover';
                img.style.margin = '5px';
                img.style.borderRadius = '5px';
                img.style.border = '2px solid #e1e8ed';
                preview.appendChild(img);
              });
            }

            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('modalAddProduct'));
            modal.show();
            
            // Update modal title for editing
            document.querySelector('#modalAddProduct .modal-title').textContent = 'Hariri Bidhaa';
            
          } catch (error) {
            console.error('Error loading product for editing:', error);
            showAlert('Hitilafu katika kupakia taarifa za bidhaa', 'danger');
          }
        }

    // DELETE PRODUCT
    async function deleteProduct(id) {
      if (!confirm('Una uhakika unataka kufuta bidhaa hii?')) return;

      try {
        await apiCall(`/products/${id}`, { method: 'DELETE' });
        showAlert('Bidhaa imefutwa kikamilifu', 'success');
        await loadProducts();
      } catch (error) {
        console.error('Error deleting product:', error);
        showAlert(error.message || 'Hitilafu katika kufuta bidhaa', 'danger');
      }
    }

    // IMAGE PREVIEW
    document.getElementById('prodImages').addEventListener('change', function() {
      const preview = document.getElementById('prodPreview');

      if (!document.getElementById('editingProductId').value) {
        preview.innerHTML = '';
      }

      const files = this.files;
      if (files.length > 5) {
        showAlert('Ruhusiwa picha 5 pekee', 'warning');
        this.value = '';
        return;
      }

      Array.from(files).forEach(file => {
        if (!file.type.startsWith('image/')) {
          showAlert('Tafadhali chagua faili za picha tu', 'warning');
          return;
        }

        const fr = new FileReader();
        fr.onload = () => {
          const img = document.createElement('img');
          img.src = fr.result;
          img.style.maxWidth = '100px';
          img.style.maxHeight = '100px';
          img.style.objectFit = 'cover';
          img.style.margin = '5px';
          img.style.borderRadius = '5px';
          preview.appendChild(img);
        };
        fr.readAsDataURL(file);
      });
    });

        // Reset product form when modal is closed
        document.getElementById('modalAddProduct').addEventListener('hidden.bs.modal', function() {
          document.getElementById('productForm').reset();
          document.getElementById('editingProductId').value = '';
          document.getElementById('prodPreview').innerHTML = '';
          sizeManager.setSizesData([]);
          document.querySelector('#modalAddProduct .modal-title').textContent = 'Ongeza / Hariri Bidhaa';
        });
    

    // ===============================
    // CUSTOMERS MANAGEMENT
    // ===============================
    let customers = [];

    async function loadCustomers() {
      try {
        customers = await apiCall('/customers');
        renderCustomersTable();
        renderCustomersMobileCards();
        populateCustomerSelects();
      } catch (error) {
        console.error('Error loading customers:', error);
        showAlert('Hitilafu katika kupakia wateja', 'danger');
      }
    }

    document.getElementById('customerForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const customerId = document.getElementById('editingCustomerId').value;
      const password = document.getElementById('custPassword').value;
      const confirmPassword = document.getElementById('custConfirmPassword').value;
      
      if (password !== confirmPassword) {
        showAlert('Nenosiri halifanani!', 'danger');
        return;
      }
      
      const customerData = {
        first_name: document.getElementById('custFname').value,
        last_name: document.getElementById('custLname').value,
        phone: document.getElementById('custMobile').value,
        email: document.getElementById('custEmail').value || null,
        gender: document.getElementById('custGender').value,
        password: password,
        confirm_password: confirmPassword
      };
      
      document.getElementById('customerBtnText').style.display = 'none';
      document.getElementById('customerSpinner').style.display = 'inline-block';
      
      try {
        if (customerId) {
          await apiCall(`/customers/${customerId}`, {
            method: 'PUT',
            body: JSON.stringify(customerData)
          });
          showAlert('Mteja amesasishwa kikamilifu');
        } else {
          await apiCall('/customers', {
            method: 'POST',
            body: JSON.stringify(customerData)
          });
          showAlert('Mteja ameongezwa kikamilifu');
        }
        
        document.getElementById('customerForm').reset();
        document.getElementById('editingCustomerId').value = '';
        bootstrap.Modal.getInstance(document.getElementById('modalAddCustomer')).hide();
        
        await loadCustomers();
        
      } catch (error) {
        console.error('Error saving customer:', error);
        showAlert(error.message || 'Hitilafu katika kuhifadhi mteja', 'danger');
      } finally {
        document.getElementById('customerBtnText').style.display = 'inline-block';
        document.getElementById('customerSpinner').style.display = 'none';
      }
    });

    function renderCustomersTable(filter = '') {
      const tbody = document.getElementById('customersTableBody');
      tbody.innerHTML = '';
      
      const filteredCustomers = customers.filter(c => 
        (c.first_name + c.last_name + c.phone + (c.email || '')).toLowerCase().includes(filter.toLowerCase())
      );
      
      if (filteredCustomers.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center py-4 text-muted">Hakuna wateja waliopatikana</td></tr>';
        return;
      }
      
      filteredCustomers.forEach((customer, index) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${index + 1}</td>
          <td>${customer.first_name}</td>
          <td>${customer.last_name}</td>
          <td>${customer.phone}</td>
          <td>${customer.email || '-'}</td>
          <td>${customer.gender}</td>
          <td>
            <button class="btn btn-sm btn-outline-primary me-1" onclick="editCustomer('${customer.id}')">Hariri</button>
            <button class="btn btn-sm btn-outline-danger" onclick="deleteCustomer('${customer.id}')">Futa</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    // Render mobile cards for customers
    function renderCustomersMobileCards(filter = '') {
      const container = document.getElementById('customersMobileCards');
      container.innerHTML = '';
      
      const filteredCustomers = customers.filter(c => 
        (c.first_name + c.last_name + c.phone + (c.email || '')).toLowerCase().includes(filter.toLowerCase())
      );
      
      if (filteredCustomers.length === 0) {
        container.innerHTML = '<div class="text-center py-4 text-muted">Hakuna wateja waliopatikana</div>';
        return;
      }
      
      filteredCustomers.forEach((customer, index) => {
        const card = document.createElement('div');
        card.className = 'mobile-card';
        card.innerHTML = `
          <div class="mobile-card-row">
            <div class="mobile-card-label">#</div>
            <div class="mobile-card-value">${index + 1}</div>
          </div>
          <div class="mobile-card-row">
            <div class="mobile-card-label">Jina la Kwanza</div>
            <div class="mobile-card-value">${customer.first_name}</div>
          </div>
          <div class="mobile-card-row">
            <div class="mobile-card-label">Jina la Mwisho</div>
            <div class="mobile-card-value">${customer.last_name}</div>
          </div>
          <div class="mobile-card-row">
            <div class="mobile-card-label">Simu</div>
            <div class="mobile-card-value">${customer.phone}</div>
          </div>
          <div class="mobile-card-row">
            <div class="mobile-card-label">Barua Pepe</div>
            <div class="mobile-card-value">${customer.email || '-'}</div>
          </div>
          <div class="mobile-card-row">
            <div class="mobile-card-label">Jinsia</div>
            <div class="mobile-card-value">${customer.gender}</div>
          </div>
          <div class="mobile-card-row">
            <div class="mobile-card-label">Vitendo</div>
            <div class="mobile-card-value">
              <button class="btn btn-sm btn-outline-primary me-1" onclick="editCustomer('${customer.id}')">Hariri</button>
              <button class="btn btn-sm btn-outline-danger" onclick="deleteCustomer('${customer.id}')">Futa</button>
            </div>
          </div>
        `;
        container.appendChild(card);
      });
    }

    async function editCustomer(id) {
      const customer = customers.find(c => c.id == id);
      if (!customer) return;
      
      document.getElementById('editingCustomerId').value = customer.id;
      document.getElementById('custFname').value = customer.first_name;
      document.getElementById('custLname').value = customer.last_name;
      document.getElementById('custMobile').value = customer.phone;
      document.getElementById('custEmail').value = customer.email || '';
      document.getElementById('custGender').value = customer.gender;
      document.getElementById('custPassword').value = '';
      document.getElementById('custConfirmPassword').value = '';
      
      const modal = new bootstrap.Modal(document.getElementById('modalAddCustomer'));
      modal.show();
    }

    async function deleteCustomer(id) {
      if (!confirm('Una uhakika unataka kufuta mteja huyu?')) return;
      
      try {
        await apiCall(`/customers/${id}`, { method: 'DELETE' });
        showAlert('Mteja amefutwa kikamilifu');
        await loadCustomers();
      } catch (error) {
        console.error('Error deleting customer:', error);
        showAlert('Hitilafu katika kufuta mteja', 'danger');
      }
    }

    function populateCustomerSelects() {
      const select = document.getElementById('selectCustomerMsg');
      if (!select) return;
      
      select.innerHTML = '<option value="">Tuma kwa wote</option>';
      
      customers.forEach(customer => {
        const option = document.createElement('option');
        option.value = customer.id;
        option.textContent = `${customer.first_name} ${customer.last_name} (${customer.phone})`;
        select.appendChild(option);
      });
    }

    // ===============================
    // ADS MANAGEMENT
    // ===============================
    let ads = [];

    // Load Ads
    async function loadAds() {
      try {
        ads = await apiCall('/ads');
        renderAds();
      } catch (error) {
        console.error('Error loading ads:', error);
        ads = [];
        renderAds();
      }
    }

    // Submit Ad Form
    document.getElementById('adForm').addEventListener('submit', async function (e) {
      e.preventDefault();

      const formData = new FormData();
      const imageFile = document.getElementById('adImage').files[0];
      const link = document.getElementById('adLink').value;

      if (!imageFile) {
        showAlert('Tafadhali chagua picha ya tangazo');
        return;
      }

      formData.append('image', imageFile);
      if (link) formData.append('link', link);

      document.getElementById('adBtnText').style.display = 'none';
      document.getElementById('adSpinner').style.display = 'inline-block';

      try {
        await apiCallWithFormData('/ads', formData);
        showAlert('Tangazo limechapishwa kikamilifu');

        document.getElementById('adForm').reset();
        bootstrap.Modal.getInstance(document.getElementById('modalAddAd')).hide();

        await loadAds();
      } catch (error) {
        console.error('Error posting ad:', error);
        showAlert('Hitilafu katika kuchapisha tangazo', 'danger');
      } finally {
        document.getElementById('adBtnText').style.display = 'inline-block';
        document.getElementById('adSpinner').style.display = 'none';
      }
    });

    // Render Ads
    function renderAds() {
      const container = document.getElementById('adsContainer');
      container.innerHTML = '';

      if (ads.length === 0) {
        container.innerHTML = `
          <div class="col-12 text-center py-4 text-muted">
            Hakuna matangazo yaliyopo
          </div>`;
        return;
      }

      ads.forEach(ad => {
        const col = document.createElement('div');
        col.className = 'col-md-6 col-lg-4 mb-3';

        col.innerHTML = `
          <div class="card shadow-sm h-100">
            <div class="card-img-top-container" style="height: 200px; overflow: hidden;">
              <img src="${ad.image_url}"
                  class="card-img-top h-100 w-100"
                  style="object-fit: cover;"
                  alt="Tangazo"
                  onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAwIiBoZWlnaHQ9IjIwMCIgdmlld0JveD0iMCAwIDQwMCAyMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSI0MDAiIGhlaWdodD0iMjAwIiBmaWxsPSIjZjBmMGYwIi8+Cjx0ZXh0IHg9IjIwMCIgeT0iMTAwIiBmb250LWZhbWlseT0iQXJpYWwsIHNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGZpbGw9IiM5OTkiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIuM2VtIj5FcnJvcjwvdGV4dD4KPC9zdmc+'">
            </div>

            <div class="card-body d-flex flex-column">
              <div class="mt-auto">
                <div class="d-flex justify-content-between align-items-center">

                  ${ad.link
                    ? `<a href="${ad.link}" target="_blank"
                        class="btn btn-sm btn-outline-primary">
                        <i class="fa fa-external-link-alt me-1"></i>Tembelea</a>`
                    : `<span class="text-muted small">Hakuna kiungo</span>`}

                  <button class="btn btn-sm btn-danger" onclick="deleteAd('${ad.id}')">
                    <i class="fa fa-trash me-1"></i>Futa
                  </button>
                </div>

                <small class="text-muted d-block mt-2">
                  Imeundwa: ${new Date(ad.created_at).toLocaleDateString('sw-TZ')}
                </small>
              </div>
            </div>
          </div>
        `;

        container.appendChild(col);
      });
    }

    // Delete Ad
    async function deleteAd(id) {
      if (!confirm('Una uhakika unataka kufuta tangazo hili?')) return;

      try {
        await apiCall(`/ads/${id}`, { method: 'DELETE' });
        showAlert('Tangazo limefutwa kikamilifu');
        await loadAds();
      } catch (error) {
        console.error('Error deleting ad:', error);
        showAlert('Hitilafu katika kufuta tangazo', 'danger');
      }
    }

    // ===============================
    // ANNOUNCEMENTS
    // ===============================
    document.getElementById('announcementForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const content = document.getElementById('announcementText').value;
      if (!content) {
        showAlert('Tafadhali andika maudhui ya arifa');
        return;
      }
      
      document.getElementById('announcementBtnText').style.display = 'none';
      document.getElementById('announcementSpinner').style.display = 'inline-block';
      
      try {
        await apiCall('/messages', {
          method: 'POST',
          body: JSON.stringify({ content })
        });
        
        showAlert('Arifa imetumwa kikamilifu');
        document.getElementById('announcementForm').reset();
        bootstrap.Modal.getInstance(document.getElementById('modalPostAnnouncement')).hide();
        
      } catch (error) {
        console.error('Error posting announcement:', error);
        showAlert('Hitilafu katika kutuma arifa', 'danger');
      } finally {
        document.getElementById('announcementBtnText').style.display = 'inline-block';
        document.getElementById('announcementSpinner').style.display = 'none';
      }
    });

    // ===============================
    // MESSAGING
    // ===============================
    document.getElementById('sendMessageForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const customerId = document.getElementById('selectCustomerMsg').value;
      const content = document.getElementById('msgBody').value;
      
      if (!content) {
        showAlert('Tafadhali andika ujumbe');
        return;
      }
      
      document.getElementById('messageBtnText').style.display = 'none';
      document.getElementById('messageSpinner').style.display = 'inline-block';
      
      try {
        const requestBody = { content };
        if (customerId) {
          requestBody.customer_ids = [customerId];
        }
        
        await apiCall('/notifications/send', {
          method: 'POST',
          body: JSON.stringify(requestBody)
        });
        
        showAlert('Ujumbe umetumwa kikamilifu');
        document.getElementById('sendMessageForm').reset();
        bootstrap.Modal.getInstance(document.getElementById('modalSendMessage')).hide();
        
      } catch (error) {
        console.error('Error sending message:', error);
        showAlert('Hitilafu katika kutuma ujumbe', 'danger');
      } finally {
        document.getElementById('messageBtnText').style.display = 'inline-block';
        document.getElementById('messageSpinner').style.display = 'none';
      }
    });

        // ===============================
        // NOTIFICATIONS
        // ===============================
        let notifications = [];

        // Helper function to update notification count display
        function updateNotificationCount(count) {
          const titleBadge = document.getElementById('notificationCountTitle');
          if (titleBadge) {
            titleBadge.textContent = count;
          }
          
          // Update quick action button
          const quickCount = document.getElementById('quickMessageCount');
          if (quickCount) {
            if (count > 0) {
              quickCount.textContent = count;
              quickCount.style.display = 'inline-block';
            } else {
              quickCount.style.display = 'none';
            }
          }
        }

        async function loadNotifications() {
          try {
            notifications = await apiCall('/notifications/customer');
            renderNotifications();
            
            const unreadCount = notifications.length;
            updateNotificationCount(unreadCount);
          } catch (error) {
            console.error('Error loading notifications:', error);
            updateNotificationCount(0);
            showAlert('Hitilafu katika kupakia arifa', 'danger');
          }
        }

        function renderNotifications() {
          const list = document.getElementById('messagesList');
          list.innerHTML = '';
          
          if (notifications.length === 0) {
            list.innerHTML = '<div class="text-center py-4 text-muted">Hakuna ujumbe uliopokelewa</div>';
            return;
          }
          
          notifications.forEach(notification => {
            const el = document.createElement('div');
            el.className = 'list-group-item d-flex justify-content-between align-items-start border-0 mb-2 rounded';
            el.style.borderLeft = '4px solid var(--primary-light)';
            el.innerHTML = `
              <div class="flex-grow-1">
                <div class="d-flex justify-content-between align-items-center mb-1">
                  <strong>${notification.first_name} ${notification.last_name}</strong>
                  <small class="text-muted">${new Date(notification.created_at).toLocaleDateString('sw-TZ')}</small>
                </div>
                <div class="text-muted mb-2">${notification.message}</div>
                <div class="d-flex gap-2">
                  <span class="badge bg-light text-dark"><i class="fa fa-phone me-1"></i>${notification.phone}</span>
                  ${notification.email ? `<span class="badge bg-light text-dark"><i class="fa fa-envelope me-1"></i>${notification.email}</span>` : ''}
                </div>
              </div>
              <div class="ms-3">
                <button class="btn btn-sm btn-outline-primary" onclick="replyToCustomer('${notification.id}')">
                  <i class="fa fa-reply me-1"></i>Jibu
                </button>
              </div>
            `;
            list.appendChild(el);
          });
        }

        function replyToCustomer(notificationId) {
          const notification = notifications.find(n => n.id == notificationId);
          if (!notification) return;
          
          document.getElementById('selectCustomerMsg').value = notification.customer_id || '';
          document.getElementById('msgBody').value = `Jibu kwa ${notification.first_name}:\n\n`;
          
          const modal = new bootstrap.Modal(document.getElementById('modalSendMessage'));
          modal.show();
        }

    // ===============================
    // ORDERS MANAGEMENT
    // ===============================
    let orders = [];

    // Load all orders
    async function loadOrders() {
      try {
        const ordersData = await apiCall('/orders');
        orders = ordersData;
        renderOrders();
        renderOrdersMobileCards();
        renderRecentOrders();
        
        const currentSection = document.querySelector('.section:not(.d-none)').id;
        if (currentSection === 'orders') {
          await markAllOrdersAsViewed();
        }
      } catch (error) {
        console.error('Error loading orders:', error);
        showAlert('Hitilafu katika kupakia maagizo', 'danger');
      }
    }

    // Function to mark all orders as viewed
    async function markAllOrdersAsViewed() {
      try {
        const unviewedOrders = orders.filter(order => !order.admin_viewed);
        
        for (const order of unviewedOrders) {
          await markOrderViewed(order.order_id);
        }
        
        await loadNotificationCounts();
      } catch (error) {
        console.error('Error marking all orders as viewed:', error);
      }
    }

    // Render orders table
    function renderOrders() {
      const tbody = document.getElementById('ordersTableBody');
      tbody.innerHTML = '';

      if (!orders || orders.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-muted">Hakuna maagizo yaliyopatikana</td></tr>';
        return;
      }

      orders.forEach(order => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><strong>${order.order_id || order.id}</strong></td>
          <td>${order.first_name || ''} ${order.last_name || ''}</td>
          <td>${order.product_name || ''}</td>
          <td>${formatPrice(order.total_price || 0)}</td>
          <td id="status_${order.order_id || order.id}">
            <span class="status-badge status-${order.status}">${order.status}</span>
          </td>
          <td>
            <div class="btn-group" role="group">
              <button class="btn btn-sm btn-outline-secondary" onclick="updateOrderStatus('${order.order_id || order.id}','Imewekwa')">Imewekwa</button>
              <button class="btn btn-sm btn-outline-warning" onclick="updateOrderStatus('${order.order_id || order.id}','Inasafirishwa')">Safirishwa</button>
              <button class="btn btn-sm btn-outline-danger" onclick="updateOrderStatus('${order.order_id || order.id}','Ghairishwa')">Ghairi</button>
              <button class="btn btn-sm btn-info" onclick="updateOrderStatus('${order.order_id || order.id}','Kurudishwa')">Rudisha</button>
              <button class="btn btn-sm btn-success" onclick="markAsReceived('${order.order_id || order.id}')">Pokea</button>
            </div>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    // Render mobile cards for orders
    function renderOrdersMobileCards() {
      const container = document.getElementById('ordersMobileCards');
      container.innerHTML = '';

      if (!orders || orders.length === 0) {
        container.innerHTML = '<div class="text-center py-4 text-muted">Hakuna maagizo yaliyopatikana</div>';
        return;
      }

      orders.forEach(order => {
        const card = document.createElement('div');
        card.className = 'mobile-card';
        card.innerHTML = `
          <div class="mobile-card-row">
            <div class="mobile-card-label">Namba ya Agizo</div>
            <div class="mobile-card-value"><strong>${order.order_id || order.id}</strong></div>
          </div>
          <div class="mobile-card-row">
            <div class="mobile-card-label">Mteja</div>
            <div class="mobile-card-value">${order.first_name || ''} ${order.last_name || ''}</div>
          </div>
          <div class="mobile-card-row">
            <div class="mobile-card-label">Bidhaa</div>
            <div class="mobile-card-value">${order.product_name || ''}</div>
          </div>
          <div class="mobile-card-row">
            <div class="mobile-card-label">Jumla</div>
            <div class="mobile-card-value">${formatPrice(order.total_price || 0)}</div>
          </div>
          <div class="mobile-card-row">
            <div class="mobile-card-label">Hali</div>
            <div class="mobile-card-value">
              <span class="status-badge status-${order.status}">${order.status}</span>
            </div>
          </div>
          <div class="mobile-card-row">
            <div class="mobile-card-label">Kitendo</div>
            <div class="mobile-card-value">
              <div class="d-flex flex-wrap gap-1">
                <button class="btn btn-sm btn-outline-secondary" onclick="updateOrderStatus('${order.order_id || order.id}','Imewekwa')">Imewekwa</button>
                <button class="btn btn-sm btn-outline-warning" onclick="updateOrderStatus('${order.order_id || order.id}','Inasafirishwa')">Safirishwa</button>
                <button class="btn btn-sm btn-outline-danger" onclick="updateOrderStatus('${order.order_id || order.id}','Ghairishwa')">Ghairi</button>
                <button class="btn btn-sm btn-info" onclick="updateOrderStatus('${order.order_id || order.id}','Kurudishwa')">Rudisha</button>
                <button class="btn btn-sm btn-success" onclick="markAsReceived('${order.order_id || order.id}')">Pokea</button>
              </div>
            </div>
          </div>
        `;
        container.appendChild(card);
      });
    }

    // Render recent orders sidebar
    function renderRecentOrders() {
      const container = document.getElementById('recentOrders');
      const recent = orders.slice(0, 5);

      if (recent.length === 0) {
        container.innerHTML = '<div class="text-center py-3 text-muted">Hakuna maagizo ya hivi karibuni</div>';
        return;
      }

      container.innerHTML = '';
      recent.forEach(order => {
        const div = document.createElement('div');
        div.className = 'd-flex justify-content-between align-items-center border-bottom py-3';
        div.innerHTML = `
          <div>
            <div class="fw-bold small">${order.order_id || order.id}</div>
            <div class="text-muted small">${order.first_name || ''} ${order.last_name || ''}</div>
            <div class="text-muted small mt-1">${order.product_name || ''}</div>
          </div>
          <div class="text-end">
            <div class="fw-bold">${formatPrice(order.total_price || 0)}</div>
            <span class="status-badge status-${order.status} mt-1">${order.status}</span>
          </div>
        `;
        container.appendChild(div);
      });
    }

    // Update normal statuses
    async function updateOrderStatus(orderId, status) {
      try {
        const response = await apiCall(`/orders/${orderId}/status`, {
          method: 'PUT',
          body: JSON.stringify({ status })
        });

        showAlert(`Hali ya agizo imesasishwa kuwa: ${status}`);

        const statusElement = document.getElementById(`status_${orderId}`);
        if (statusElement) {
          statusElement.innerHTML = `<span class="status-badge status-${status}">${status}</span>`;
        }

        await loadOrders();
        return response;
      } catch (error) {
        console.error('Error updating order status:', error);
        showAlert(error?.message || 'Tatizo kuthibitisha hali ya agizo', 'danger');
        throw error;
      }
    }

    // Mark as received (opens password modal)
    async function markAsReceived(orderId) {
      try {
        openPasswordModal(orderId);
      } catch (err) {
        console.error('Error marking as received:', err);
        showAlert(err?.message || 'Tatizo, jaribu tena', 'danger');
      }
    }

    // Open Password modal
    function openPasswordModal(orderId) {
      document.getElementById('passwordOrderId').value = orderId;
      document.getElementById('passwordInput').value = '';
      new bootstrap.Modal(document.getElementById('modalConfirmPassword')).show();
    }

    // Confirm Password for order reception
    document.getElementById('confirmPasswordBtn').addEventListener('click', async function() {
      const orderId = document.getElementById('passwordOrderId').value;
      const password = document.getElementById('passwordInput').value.trim();

      if (!password) {
        showAlert('Tafadhali ingiza nenosiri');
        return;
      }

      document.getElementById('passwordBtnText').style.display = 'none';
      document.getElementById('passwordSpinner').style.display = 'inline-block';

      try {
        await apiCall(`/orders/${orderId}/status`, {
          method: 'PUT',
          body: JSON.stringify({ status: 'Inasafirishwa' })
        });

        showAlert('Agizo limewekwa kwenye hali ya usafirishaji. Mteja atahitaji kuthibitisha kwa nenosiri lake.');

        bootstrap.Modal.getInstance(document.getElementById('modalConfirmPassword')).hide();

        const statusElement = document.getElementById(`status_${orderId}`);
        if (statusElement) {
          statusElement.innerHTML = `<span class="status-badge status-Inasafirishwa">Inasafirishwa</span>`;
        }

        await loadOrders();
      } catch (error) {
        console.error('Error confirming order:', error);
        showAlert(error?.message || 'Tatizo, jaribu tena', 'danger');
      } finally {
        document.getElementById('passwordBtnText').style.display = 'inline-block';
        document.getElementById('passwordSpinner').style.display = 'none';
      }
    });

    // ===============================
    // SEARCH FUNCTIONALITY
    // ===============================
    document.getElementById('productSearch').addEventListener('input', (e) => {
      renderProductsTable(e.target.value);
      renderProductsMobileCards(e.target.value);
    });
    
    document.getElementById('customerSearch').addEventListener('input', (e) => {
      renderCustomersTable(e.target.value);
      renderCustomersMobileCards(e.target.value);
    });

    // ===============================
    // SIDEBAR NAVIGATION
    // ===============================
    document.querySelectorAll('.nav-link').forEach(link => {
      link.addEventListener('click', function(e) {
        e.preventDefault();
        
        document.querySelectorAll('.nav-link').forEach(x => x.classList.remove('active'));
        this.classList.add('active');
        
        const sectionId = this.getAttribute('data-section');
        document.querySelectorAll('.section').forEach(s => s.classList.add('d-none'));
        const targetSection = document.getElementById(sectionId);
        
        if (sectionId === 'admins') {
          if (!currentAdmin || !currentAdmin.can_manage_admins) {
            showAlert('Huna ruhusa ya kupata ukurasa huu!', 'danger');
            document.querySelectorAll('.nav-link').forEach(x => x.classList.remove('active'));
            document.querySelector('[data-section="dashboard"]').classList.add('active');
            document.querySelectorAll('.section').forEach(s => s.classList.add('d-none'));
            document.getElementById('dashboard').classList.remove('d-none');
            document.getElementById('sectionTitle').textContent = 'Dashibodi ya Msimamizi';
            document.getElementById('mobileSectionTitle').textContent = 'Dashibodi';
            return;
          }
        }
        
        targetSection.classList.remove('d-none');
        
        const titleMap = {
          dashboard: 'Dashibodi ya Msimamizi',
          products: 'Usimamizi wa Bidhaa',
          customers: 'Usimamizi wa Wateja',
          ads: 'Matangazo & Arifa',
          notifications: 'Arifa & Ujumbe',
          orders: 'Maagizo Yaliyowekwa',
          admins: 'Usimamizi wa Wasimamizi'
        };
        document.getElementById('sectionTitle').textContent = titleMap[sectionId] || 'Dashibodi ya Msimamizi';
        document.getElementById('mobileSectionTitle').textContent = titleMap[sectionId] || 'Dashibodi';
        
        if (sectionId === 'products') {
          loadProducts();
        } else if (sectionId === 'customers') {
          loadCustomers();
        } else if (sectionId === 'orders') {
          loadOrders();
        } else if (sectionId === 'ads') {
          loadAds();
        } else if (sectionId === 'notifications') {
          loadNotifications();
        } else if (sectionId === 'admins') {
          loadAdmins();
        }
        
        if (window.innerWidth < 992) {
          document.getElementById('sidebar').classList.remove('show');
          document.getElementById('sidebarOverlay').classList.remove('show');
        }
        
        window.scrollTo(0, 0);
      });
    });

    // ===============================
    // QUICK ACTION BUTTONS
    // ===============================
    document.getElementById('quickAddProductBtn').addEventListener('click', () => {
      document.getElementById('editingProductId').value = '';
      document.getElementById('productForm').reset();
      document.getElementById('prodPreview').innerHTML = '';
      sizeManager.setSizesData([]);
      new bootstrap.Modal(document.getElementById('modalAddProduct')).show();
    });
    
    document.getElementById('quickAddCustomerBtn').addEventListener('click', () => {
      document.getElementById('editingCustomerId').value = '';
      document.getElementById('customerForm').reset();
      new bootstrap.Modal(document.getElementById('modalAddCustomer')).show();
    });
    
    document.getElementById('quickAddAdBtn').addEventListener('click', () => {
      new bootstrap.Modal(document.getElementById('modalAddAd')).show();
    });
    
    document.getElementById('quickViewNotificationsBtn').addEventListener('click', () => {
      document.querySelectorAll('.nav-link').forEach(x => x.classList.remove('active'));
      document.querySelector('[data-section="notifications"]').classList.add('active');
      document.querySelectorAll('.section').forEach(s => s.classList.add('d-none'));
      document.getElementById('notifications').classList.remove('d-none');
      document.getElementById('sectionTitle').textContent = 'Arifa & Ujumbe';
      document.getElementById('mobileSectionTitle').textContent = 'Arifa & Ujumbe';
      loadNotifications();
    });

    // ===============================
    // SIDEBAR TOGGLE FOR MOBILE
    // ===============================
    document.getElementById('toggleSidebar').addEventListener('click', () => {
      document.getElementById('sidebar').classList.toggle('show');
      document.getElementById('sidebarOverlay').classList.toggle('show');
    });
    
    document.getElementById('toggleSidebarMobile').addEventListener('click', () => {
      document.getElementById('sidebar').classList.add('show');
      document.getElementById('sidebarOverlay').classList.add('show');
    });
    
    document.getElementById('sidebarOverlay').addEventListener('click', () => {
      document.getElementById('sidebar').classList.remove('show');
      document.getElementById('sidebarOverlay').classList.remove('show');
    });

    // Close sidebar when clicking on a link in mobile view
    document.querySelectorAll('.nav-link').forEach(link => {
      link.addEventListener('click', () => {
        if (window.innerWidth < 992) {
          document.getElementById('sidebar').classList.remove('show');
          document.getElementById('sidebarOverlay').classList.remove('show');
        }
      });
    });

    // REFRESH ORDERS BUTTON
    document.getElementById('refreshOrdersBtn').addEventListener('click', async () => {
      await loadOrders();
      showAlert('Orodha ya maagizo imesasishwa');
    });

    // ===============================
    // LOGOUT
    // ===============================
    document.getElementById('btnLogout').addEventListener('click', () => {
      if (confirm('Una uhakika unataka kutoka?')) {
        logout();
      }
    });
    
    document.getElementById('btnLogoutMobile').addEventListener('click', () => {
      if (confirm('Una uhakika unataka kutoka?')) {
        logout();
      }
    });

    function logout() {
      stopAutoRefresh();
      
      authToken = '';
      currentAdmin = null;
      localStorage.removeItem('adminToken');
      localStorage.removeItem('adminData');
      
      document.getElementById('adminPanel').style.display = 'none';
      document.getElementById('loginPage').style.display = 'flex';
      document.getElementById('adminLoginForm').reset();
      document.getElementById('adminLoginForm').style.display = 'block';
      document.getElementById('forgotPasswordSection').style.display = 'none';
      document.getElementById('resetOptionsSection').style.display = 'none';
      document.getElementById('resetPasswordFormSection').style.display = 'none';
      document.getElementById('resetMobileFormSection').style.display = 'none';
      hideLoginAlert();
    }

    // ===============================
    // ADMIN MANAGEMENT (Only for main admin)
    // ===============================
    let admins = [];

    async function loadAdmins() {
      if (!currentAdmin || !currentAdmin.can_manage_admins) {
        console.log('Not authorized to view admins');
        document.getElementById('admins').classList.add('d-none');
        return;
      }
      
      try {
        admins = await apiCall('/admins');
        renderAdminsTable();
        renderAdminsMobileCards();
        document.getElementById('admins').classList.remove('d-none');
      } catch (error) {
        console.error('Error loading admins:', error);
        document.getElementById('admins').classList.add('d-none');
        showAlert('Hitilafu katika kupakia wasimamizi', 'danger');
      }
    }

    function renderAdminsTable() {
      const tbody = document.getElementById('adminsTableBody');
      tbody.innerHTML = '';

      if (!admins || admins.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center py-4 text-muted">Hakuna wasimamizi waliopatikana</td></tr>';
        return;
      }

      admins.forEach((admin, index) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${index + 1}</td>
          <td>${admin.first_name}</td>
          <td>${admin.last_name}</td>
          <td>${admin.mobile}</td>
          <td>${admin.can_manage_admins ? '<span class="badge bg-primary">Msimamizi Mkuu</span>' : '<span class="badge bg-secondary">Msimamizi</span>'}</td>
          <td>${new Date(admin.created_at).toLocaleDateString('sw-TZ')}</td>
          <td>
            ${admin.id !== 1 ? `
              <button class="btn btn-sm btn-outline-primary me-1" onclick="editAdmin('${admin.id}')">Hariri</button>
              <button class="btn btn-sm btn-outline-danger" onclick="deleteAdmin('${admin.id}')">Futa</button>
            ` : '<span class="text-muted small">Huwezi kuhariri msimamizi mkuu</span>'}
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    function renderAdminsMobileCards() {
      const container = document.getElementById('adminsMobileCards');
      container.innerHTML = '';

      if (!admins || admins.length === 0) {
        container.innerHTML = '<div class="text-center py-4 text-muted">Hakuna wasimamizi waliopatikana</div>';
        return;
      }

      admins.forEach((admin, index) => {
        const card = document.createElement('div');
        card.className = 'mobile-card';
        card.innerHTML = `
          <div class="mobile-card-row">
            <div class="mobile-card-label">#</div>
            <div class="mobile-card-value">${index + 1}</div>
          </div>
          <div class="mobile-card-row">
            <div class="mobile-card-label">Jina la Kwanza</div>
            <div class="mobile-card-value">${admin.first_name}</div>
          </div>
          <div class="mobile-card-row">
            <div class="mobile-card-label">Jina la Mwisho</div>
            <div class="mobile-card-value">${admin.last_name}</div>
          </div>
          <div class="mobile-card-row">
            <div class="mobile-card-label">Simu</div>
            <div class="mobile-card-value">${admin.mobile}</div>
          </div>
          <div class="mobile-card-row">
            <div class="mobile-card-label">Cheo</div>
            <div class="mobile-card-value">${admin.can_manage_admins ? '<span class="badge bg-primary">Msimamizi Mkuu</span>' : '<span class="badge bg-secondary">Msimamizi</span>'}</div>
          </div>
          <div class="mobile-card-row">
            <div class="mobile-card-label">Tarehe ya Usajili</div>
            <div class="mobile-card-value">${new Date(admin.created_at).toLocaleDateString('sw-TZ')}</div>
          </div>
          <div class="mobile-card-row">
            <div class="mobile-card-label">Vitendo</div>
            <div class="mobile-card-value">
              ${admin.id !== 1 ? `
                <button class="btn btn-sm btn-outline-primary me-1" onclick="editAdmin('${admin.id}')">Hariri</button>
                <button class="btn btn-sm btn-outline-danger" onclick="deleteAdmin('${admin.id}')">Futa</button>
              ` : '<span class="text-muted small">Huwezi kuhariri msimamizi mkuu</span>'}
            </div>
          </div>
        `;
        container.appendChild(card);
      });
    }

    async function editAdmin(id) {
      if (!currentAdmin || !currentAdmin.can_manage_admins) {
        showAlert('Huna ruhusa ya kuhariri wasimamizi!', 'danger');
        return;
      }
      
      const admin = admins.find(a => a.id == id);
      if (!admin) return;
      
      if (parseInt(id) === 1) {
        showAlert('Huwezi kuhariri msimamizi mkuu!', 'warning');
        return;
      }
      
      document.getElementById('editingAdminId').value = admin.id;
      document.getElementById('adminFname').value = admin.first_name;
      document.getElementById('adminLname').value = admin.last_name;
      document.getElementById('adminMobile').value = admin.mobile;
      
      document.getElementById('adminNewPassword').value = '';
      document.getElementById('adminConfirmPassword').value = '';
      document.getElementById('adminNewPassword').placeholder = 'Nenosiri jipya (hiari)';
      document.getElementById('adminConfirmPassword').placeholder = 'Rudia nenosiri jipya (hiari)';
      document.getElementById('adminNewPassword').removeAttribute('required');
      document.getElementById('adminConfirmPassword').removeAttribute('required');
      
      document.getElementById('adminModalTitle').textContent = 'Hariri Msimamizi';
      
      const modal = new bootstrap.Modal(document.getElementById('modalAddAdmin'));
      modal.show();
    }

    async function deleteAdmin(id) {
      if (!currentAdmin || !currentAdmin.can_manage_admins) {
        showAlert('Huna ruhusa ya kufuta wasimamizi!', 'danger');
        return;
      }
      
      if (parseInt(id) === 1) {
        showAlert('Huwezi kufuta msimamizi mkuu!', 'warning');
        return;
      }
      
      if (!confirm('Una uhakika unataka kufuta msimamizi huyu?')) return;
      
      try {
        await apiCall(`/admins/${id}`, { method: 'DELETE' });
        showAlert('Msimamizi amefutwa kikamilifu', 'success');
        await loadAdmins();
      } catch (error) {
        console.error('Error deleting admin:', error);
        showAlert(error.message || 'Hitilafu katika kufuta msimamizi', 'danger');
      }
    }

    // ===============================
    // ADMIN FORM SUBMIT
    // ===============================
    document.getElementById('adminForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      if (!currentAdmin || !currentAdmin.can_manage_admins) {
        showAlert('Huna ruhusa ya kuongeza/kuhariri wasimamizi!', 'danger');
        return;
      }
      
      const adminId = document.getElementById('editingAdminId').value;
      const firstName = document.getElementById('adminFname').value.trim();
      const lastName = document.getElementById('adminLname').value.trim();
      const mobile = document.getElementById('adminMobile').value.trim();
      const password = document.getElementById('adminNewPassword').value;
      const confirmPassword = document.getElementById('adminConfirmPassword').value;
      
      if (!firstName || !lastName || !mobile) {
        showAlert('Tafadhali jaza sehemu zote zinazohitajika!', 'danger');
        return;
      }
      
      if (!/^[0-9+\-\s()]{10,15}$/.test(mobile)) {
        showAlert('Tafadhali ingiza nambari ya simu halali!', 'danger');
        document.getElementById('adminMobile').classList.add('is-invalid');
        return;
      }
      
      if (!adminId && (!password || !confirmPassword)) {
        showAlert('Nenosiri linahitajika kwa msimamizi mpya!', 'danger');
        return;
      }
      
      if (password && password !== confirmPassword) {
        showAlert('Nenosiri halifanani!', 'danger');
        return;
      }
      
      if (!adminId && password && password.length < 6) {
        showAlert('Nenosiri lazima liwe na angalau herufi 6!', 'danger');
        return;
      }
      
      const adminData = {
        first_name: firstName,
        last_name: lastName,
        mobile: mobile
      };
      
      if (password) {
        adminData.password = password;
        if (!adminId) {
          adminData.confirm_password = confirmPassword;
        }
      }
      
      document.getElementById('adminBtnText').style.display = 'none';
      document.getElementById('adminSpinner').style.display = 'inline-block';
      
      try {
        let response;
        
        if (adminId) {
          response = await apiCall(`/admins/${adminId}`, {
            method: 'PUT',
            body: JSON.stringify(adminData)
          });
          showAlert('Msimamizi amesasishwa kikamilifu', 'success');
        } else {
          response = await apiCall('/admins', {
            method: 'POST',
            body: JSON.stringify(adminData)
          });
          showAlert('Msimamizi ameongezwa kikamilifu', 'success');
        }
        
        document.getElementById('adminForm').reset();
        document.getElementById('editingAdminId').value = '';
        document.getElementById('adminMobile').classList.remove('is-invalid');
        
        document.getElementById('adminModalTitle').textContent = 'Ongeza Msimamizi Mpya';
        document.getElementById('adminNewPassword').placeholder = 'Nenosiri';
        document.getElementById('adminConfirmPassword').placeholder = 'Rudia Nenosiri';
        document.getElementById('adminNewPassword').setAttribute('required', 'true');
        document.getElementById('adminConfirmPassword').setAttribute('required', 'true');
        
        const modal = bootstrap.Modal.getInstance(document.getElementById('modalAddAdmin'));
        if (modal) {
          modal.hide();
        }
        
        await loadAdmins();
        
      } catch (error) {
        console.error('Error saving admin:', error);
        
        if (error.message.includes('Mobile number already registered') || error.message.includes('already in use')) {
          showAlert('Nambari ya simu tayari imesajiliwa! Tafadhali tumia nambari nyingine.', 'danger');
          document.getElementById('adminMobile').classList.add('is-invalid');
          document.getElementById('adminMobile').focus();
        } else if (error.message.includes('Invalid mobile') || error.message.includes('not valid')) {
          showAlert('Nambari ya simu sio halali! Tafadhali angalia tena.', 'danger');
          document.getElementById('adminMobile').classList.add('is-invalid');
          document.getElementById('adminMobile').focus();
        } else if (error.message.includes('Password') || error.message.includes('password')) {
          showAlert('Hitilafu kwenye nenosiri: ' + error.message, 'danger');
          document.getElementById('adminNewPassword').focus();
        } else if (error.message.includes('required') || error.message.includes('All fields')) {
          showAlert('Sehemu zote zinazohitajika hazijajazwa kikamilifu!', 'danger');
        } else {
          showAlert(error.message || 'Hitilafu katika kuhifadhi msimamizi', 'danger');
        }
      } finally {
        document.getElementById('adminBtnText').style.display = 'inline-block';
        document.getElementById('adminSpinner').style.display = 'none';
      }
    });

    // ===============================
    // ADMIN MODAL SETUP
    // ===============================
    const adminModal = document.getElementById('modalAddAdmin');
    if (adminModal) {
      adminModal.addEventListener('show.bs.modal', function () {
        if (!currentAdmin || !currentAdmin.can_manage_admins) {
          showAlert('Huna ruhusa ya kuongeza wasimamizi!', 'danger');
          setTimeout(() => {
            const bsModal = bootstrap.Modal.getInstance(adminModal);
            if (bsModal) {
              bsModal.hide();
            }
          }, 100);
          return;
        }
        
        if (!document.getElementById('editingAdminId').value) {
          document.getElementById('adminForm').reset();
          document.getElementById('adminModalTitle').textContent = 'Ongeza Msimamizi Mpya';
          document.getElementById('adminNewPassword').placeholder = 'Nenosiri';
          document.getElementById('adminConfirmPassword').placeholder = 'Rudia Nenosiri';
          document.getElementById('adminNewPassword').setAttribute('required', 'true');
          document.getElementById('adminConfirmPassword').setAttribute('required', 'true');
          document.getElementById('adminMobile').classList.remove('is-invalid');
        }
      });
      
      adminModal.addEventListener('hidden.bs.modal', function () {
        document.getElementById('adminForm').reset();
        document.getElementById('editingAdminId').value = '';
        document.getElementById('adminModalTitle').textContent = 'Ongeza Msimamizi Mpya';
        document.getElementById('adminNewPassword').placeholder = 'Nenosiri';
        document.getElementById('adminConfirmPassword').placeholder = 'Rudia Nenosiri';
        document.getElementById('adminNewPassword').setAttribute('required', 'true');
        document.getElementById('adminConfirmPassword').setAttribute('required', 'true');
        document.getElementById('adminMobile').classList.remove('is-invalid');
      });
    }

    // ===============================
    // MOBILE NUMBER VALIDATION
    // ===============================
    document.getElementById('adminMobile').addEventListener('blur', function() {
      const mobile = this.value.trim();
      
      if (mobile && !/^[0-9+\-\s()]{10,15}$/.test(mobile)) {
        this.classList.add('is-invalid');
        document.getElementById('adminMobileError').textContent = 'Nambari ya simu sio halali!';
      } else {
        this.classList.remove('is-invalid');
      }
    });
    
    document.getElementById('adminMobile').addEventListener('input', function() {
      this.classList.remove('is-invalid');
    });

    // Initialize size manager when script loads
    if (document.getElementById('sizesContainer')) {
      sizeManager.init();
    }

    // Prevent autofill from browser on product search
    document.getElementById('productSearch').addEventListener('focus', function() {
      this.value = '';
    });
  </script>
</body>
</html>