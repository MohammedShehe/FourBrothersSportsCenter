<!DOCTYPE html>
<html lang="sw">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="images/FBSC-32.png" sizes="32x32" type="image/png">
    <title>Four Brothers Sports Center</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #1a73e8;
            --secondary-color: #f8f9fa;
            --accent-color: #ff6b35;
            --text-color: #333;
            --light-text: #6c757d;
            --border-color: #dee2e6;
            --card-bg: #ffffff;
            --body-bg: #f5f5f5;
            --header-bg: #ffffff;
            --footer-bg: #2c3e50;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --radius: 10px;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
            --admin-color: #6f42c1;
            --form-bg: #ffffff;
            --form-border: #e0e0e0;
            --form-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            --form-radius: 12px;
        }

        [data-theme="dark"] {
            --primary-color: #4dabf7;
            --secondary-color: #343a40;
            --accent-color: #ff922b;
            --text-color: #f8f9fa;
            --light-text: #adb5bd;
            --border-color: #495057;
            --card-bg: #343a40;
            --body-bg: #212529;
            --header-bg: #343a40;
            --footer-bg: #1a252f;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            --success-color: #20c997;
            --warning-color: #fd7e14;
            --danger-color: #e83e8c;
            --admin-color: #8c68cd;
            --form-bg: #2c3e50;
            --form-border: #34495e;
            --form-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: var(--text-color);
            background-color: var(--body-bg);
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        .main-content {
            flex: 1;
        }
        
        /* ==================== LOADING SCREEN ==================== */
        #loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--body-bg), var(--primary-color), var(--success-color));
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            transition: opacity 0.5s ease, visibility 0.5s ease;
        }
        
        .loading-container {
            text-align: center;
            padding: 40px;
            border-radius: 20px;
            background: rgba(255, 255, 255, 0.95);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
            max-width: 500px;
            width: 90%;
            animation: fadeIn 0.8s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .logo-animation {
            width: 120px;
            height: 120px;
            margin: 0 auto 30px;
            position: relative;
        }
        
        .logo-circle {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: linear-gradient(45deg, #28a745, #000000, #1a73e8);
            position: relative;
            overflow: hidden;
            animation: rotate 3s linear infinite;
            box-shadow: 0 0 30px rgba(26, 115, 232, 0.3);
        }
        
        .logo-circle::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.4), transparent);
            transform: rotate(45deg);
            animation: shine 2s linear infinite;
        }
        
        .logo-inner {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 2.5rem;
            color: white;
            font-weight: bold;
            z-index: 2;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        
        @keyframes rotate {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @keyframes shine {
            0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
            100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
        }
        
        .loading-text {
            margin-top: 20px;
            color: var(--text-color);
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 10px;
        }
        
        .loading-subtext {
            color: var(--light-text);
            margin-bottom: 30px;
            font-size: 1rem;
        }
        
        .progress-container {
            width: 100%;
            height: 6px;
            background: rgba(0, 0, 0, 0.1);
            border-radius: 3px;
            overflow: hidden;
            margin: 20px 0;
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #28a745, #000000, #1a73e8);
            width: 0%;
            border-radius: 3px;
            transition: width 0.3s ease;
            animation: progressAnimation 2s ease-in-out infinite;
        }
        
        @keyframes progressAnimation {
            0% { width: 0%; left: 0; }
            50% { width: 100%; left: 0; }
            100% { width: 0%; left: 100%; }
        }
        
        .loading-dots {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-top: 20px;
        }
        
        .dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            animation: dotPulse 1.5s ease-in-out infinite;
        }
        
        .dot:nth-child(1) {
            background: #28a745;
        }
        
        .dot:nth-child(2) {
            background: #000000;
            animation-delay: 0.2s;
        }
        
        .dot:nth-child(3) {
            background: #1a73e8;
            animation-delay: 0.4s;
        }
        
        @keyframes dotPulse {
            0%, 100% { transform: scale(1); opacity: 0.5; }
            50% { transform: scale(1.5); opacity: 1; }
        }
        
        .loading-stats {
            display: flex;
            justify-content: space-around;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid rgba(0, 0, 0, 0.1);
        }
        
        .stat-item {
            text-align: center;
        }
        
        .stat-value {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--primary-color);
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 0.8rem;
            color: var(--light-text);
        }
        
        .loading-error {
            display: none;
            margin-top: 20px;
            padding: 15px;
            background: rgba(220, 53, 69, 0.1);
            border-radius: var(--radius);
            border-left: 4px solid var(--danger-color);
            animation: shake 0.5s ease-in-out;
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        
        .retry-button {
            margin-top: 15px;
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: var(--radius);
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .retry-button:hover {
            background: var(--accent-color);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .loading-success {
            display: none;
            margin-top: 20px;
            padding: 15px;
            background: rgba(40, 167, 69, 0.1);
            border-radius: var(--radius);
            border-left: 4px solid var(--success-color);
            animation: bounceIn 0.5s ease-out;
        }
        
        @keyframes bounceIn {
            0% { transform: scale(0.8); opacity: 0; }
            60% { transform: scale(1.05); opacity: 1; }
            100% { transform: scale(1); }
        }
        
        /* Main app content - initially hidden */
        #app-content {
            opacity: 0;
            transition: opacity 0.5s ease;
        }
        
        /* Rest of your existing CSS styles remain the same */
        .navbar {
            background-color: var(--header-bg) !important;
            box-shadow: var(--shadow);
            transition: all 0.3s ease;
        }
        
        .navbar-brand img {
            height: 40px;
        }
        
        .profile-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--primary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        
        .search-bar {
            position: relative;
        }
        
        .search-bar input {
            padding-right: 40px;
            background-color: var(--card-bg);
            border-color: var(--border-color);
            color: var(--text-color);
            transition: all 0.3s ease;
        }
        
        .search-bar i {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--light-text);
        }
        
        .ads-container {
            height: 300px;
            background-color: var(--secondary-color);
            border-radius: var(--radius);
            overflow: hidden;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
            transition: all 0.3s ease;
        }
        
        .announcements {
            background-color: #94c9f7;
            border: 1px solid #ffeaa7;
            border-radius: var(--radius);
            padding: 10px 15px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
            overflow: hidden;
        }
        
        .announcements marquee {
            margin: 0;
        }
        
        .product-card {
            border: none;
            border-radius: var(--radius);
            overflow: hidden;
            transition: transform 0.3s, box-shadow 0.3s;
            margin-bottom: 20px;
            background-color: var(--card-bg);
            box-shadow: var(--shadow);
            color: var(--text-color);
            transition: all 0.3s ease;
        }
        
        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.15);
        }
        
        .product-img {
            height: 200px;
            object-fit: cover;
            width: 100%;
        }
        
        .offer-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: var(--accent-color);
            color: white;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
            z-index: 1;
        }
        
        .price-old {
            text-decoration: line-through;
            color: var(--light-text);
            margin-right: 5px;
        }
        
        .price-new {
            color: var(--accent-color);
            font-weight: bold;
        }
        
        .rating {
            color: #ffc107;
        }
        
        .product-detail-img {
            height: 350px;
            object-fit: contain;
            width: 100%;
            border-radius: var(--radius);
        }
        
        .quantity-selector {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .quantity-btn {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background-color: var(--secondary-color);
            border: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .quantity-btn:hover {
            background-color: var(--primary-color);
            color: white;
        }

        /* Enhanced Share Links Styling */
        .share-links {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .share-links a {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            color: white;
            text-decoration: none;
            transition: all 0.3s ease;
            font-size: 1.2rem;
            box-shadow: 0 3px 6px rgba(0,0,0,0.16);
        }

        .share-links a:hover {
            transform: translateY(-3px) scale(1.1);
            box-shadow: 0 8px 15px rgba(0,0,0,0.2);
        }

        .share-whatsapp {
            background: linear-gradient(135deg, #25D366, #128C7E);
        }

        .share-facebook {
            background: linear-gradient(135deg, #1877F2, #0D5AB6);
        }

        .share-twitter {
            background: linear-gradient(135deg, #1DA1F2, #0C85D0);
        }

        .share-telegram {
            background: linear-gradient(135deg, #0088cc, #006699);
        }

        .share-instagram {
            background: linear-gradient(45deg, #E4405F, #C13584, #833AB4);
        }

        .share-copy {
            background: linear-gradient(135deg, var(--primary-color), #0d6efd);
        }

        .qr-code-container {
            margin-top: 15px;
            text-align: center;
        }

        .qr-code {
            max-width: 200px;
            height: auto;
            margin: 0 auto;
            border: 10px solid white;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        /* Enhanced Size Options Styling */
        .size-options-container {
            margin: 20px 0;
        }
        
        .size-options-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        
        .size-option {
            height: 50px;
            border: 2px solid var(--border-color);
            border-radius: var(--radius);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background-color: var(--card-bg);
            color: var(--text-color);
            position: relative;
            overflow: hidden;
        }
        
        .size-option:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }
        
        .size-option.active {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
            transform: scale(1.05);
        }
        
        .size-option.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            position: relative;
        }
        
        .size-option.disabled::after {
            content: "";
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 2px;
            background-color: var(--danger-color);
            transform: rotate(-45deg);
        }
        
        .size-label {
            font-size: 1rem;
            font-weight: 600;
        }
        
        .size-stock {
            font-size: 0.7rem;
            margin-top: 2px;
            opacity: 0.8;
        }
        
        .size-option.active .size-stock {
            color: rgba(255, 255, 255, 0.9);
        }
        
        .cart-item {
            border-bottom: 1px solid var(--border-color);
            padding: 15px 0;
            transition: all 0.3s ease;
        }
        
        .order-step {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .step-number {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background-color: var(--secondary-color);
            border: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        
        .step-active .step-number {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        
        .account-menu {
            list-style: none;
            padding: 0;
            border-radius: var(--radius);
            overflow: hidden;
            box-shadow: var(--shadow);
        }
        
        .account-menu li {
            padding: 10px 15px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            background-color: var(--card-bg);
            transition: all 0.3s ease;
        }
        
        .account-menu li:last-child {
            border-bottom: none;
        }
        
        .account-menu li:hover {
            background-color: var(--secondary-color);
        }
        
        .account-menu li.active {
            background-color: var(--primary-color);
            color: white;
            font-weight: bold;
        }
        
        .order-status {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
        }
        
        .status-imewekwa {
            background-color: #d1ecf1;
            color: #0c5460;
        }
        
        .status-inasafirishwa {
            background-color: #fff3cd;
            color: #856404;
        }
        
        .status-imepokelewa {
            background-color: #d4edda;
            color: #155724;
        }
        
        .status-ghairishwa {
            background-color: #f8d7da;
            color: #721c24;
        }
        
        .status-kurudishwa {
            background-color: #e2e3e5;
            color: #383d41;
        }
        
        .rating-stars {
            color: #ffc107;
            font-size: 1.2rem;
        }
        
        .section-title {
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 10px;
            margin-bottom: 20px;
            color: var(--text-color);
            transition: all 0.3s ease;
        }
        
        .hidden {
            display: none !important;
        }
        
        footer {
            background-color: var(--footer-bg);
            padding: 40px 0 20px;
            margin-top: 50px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            color: #ecf0f1;
        }
        
        footer h5 {
            color: #ffffff;
            font-weight: 600;
            margin-bottom: 20px;
            position: relative;
        }
        
        footer h5::after {
            content: '';
            position: absolute;
            bottom: -8px;
            left: 0;
            width: 40px;
            height: 2px;
            background-color: var(--primary-color);
        }
        
        footer p, footer a {
            color: #bdc3c7;
            transition: color 0.3s ease;
        }
        
        footer a:hover {
            color: var(--primary-color);
            text-decoration: none;
        }
        
        .footer-links {
            list-style: none;
            padding: 0;
        }
        
        .footer-links li {
            margin-bottom: 10px;
        }
        
        .footer-links a {
            display: flex;
            align-items: center;
            color: #bdc3c7;
            transition: all 0.3s ease;
        }
        
        .footer-links a:hover {
            color: var(--primary-color);
            transform: translateX(5px);
        }
        
        .footer-links i {
            margin-right: 10px;
            width: 20px;
            text-align: center;
        }
        
        .social-links {
            display: flex;
            gap: 15px;
            margin-top: 15px;
        }
        
        .social-links a {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: rgba(255, 255, 255, 0.1);
            color: #ecf0f1;
            transition: all 0.3s ease;
        }
        
        .social-links a:hover {
            background-color: var(--primary-color);
            transform: translateY(-3px);
        }
        
        .footer-bottom {
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            padding-top: 20px;
            margin-top: 30px;
            text-align: center;
            color: #95a5a6;
            font-size: 0.9rem;
        }
        
        .card {
            background-color: var(--card-bg);
            border-color: var(--border-color);
            color: var(--text-color);
            transition: all 0.3s ease;
        }
        
        /* Enhanced Form Styling */
        .form-control, .form-select {
            background-color: var(--form-bg);
            border: 2px solid var(--form-border);
            color: var(--text-color);
            transition: all 0.3s ease;
            border-radius: 8px;
            padding: 12px 15px;
            font-size: 15px;
        }
        
        .form-control:focus, .form-select:focus {
            background-color: var(--form-bg);
            border-color: var(--primary-color);
            color: var(--text-color);
            box-shadow: 0 0 0 0.25rem rgba(26, 115, 232, 0.15);
        }
        
        .form-label {
            font-weight: 500;
            margin-bottom: 8px;
            color: var(--text-color);
        }
        
        .form-check-input {
            width: 18px;
            height: 18px;
            margin-top: 0.2rem;
        }
        
        .form-check-input:checked {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }
        
        .table {
            color: var(--text-color);
        }
        
        .modal-content {
            background-color: var(--form-bg);
            color: var(--text-color);
            transition: all 0.3s ease;
            border-radius: var(--form-radius);
            border: 1px solid var(--form-border);
            box-shadow: var(--form-shadow);
        }
        
        .modal-header {
            border-bottom: 1px solid var(--form-border);
            padding: 20px 25px;
        }
        
        .modal-title {
            font-weight: 600;
            color: var(--text-color);
        }
        
        .modal-body {
            padding: 25px;
        }
        
        .btn-close {
            filter: invert(0.6);
        }
        
        .theme-toggle {
            background: none;
            border: none;
            font-size: 1.2rem;
            color: var(--text-color);
            cursor: pointer;
            margin-left: 10px;
            transition: all 0.3s ease;
        }
        
        .theme-toggle:hover {
            color: var(--primary-color);
        }
        
        .carousel-control-prev, .carousel-control-next {
            width: 5%;
        }
        
        .carousel-indicators button {
            background-color: var(--light-text);
        }
        
        .carousel-indicators .active {
            background-color: var(--primary-color);
        }
        
        .nav-tabs .nav-link {
            color: var(--text-color);
            background-color: var(--secondary-color);
            border-color: var(--border-color);
        }
        
        .nav-tabs .nav-link.active {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
            color: white;
        }
        
        .tab-content {
            background-color: var(--card-bg);
            border-color: var(--border-color);
            transition: all 0.3s ease;
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            background-color: #0d6efd;
            border-color: #0d6efd;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(26, 115, 232, 0.3);
        }
        
        .btn-outline-primary {
            color: var(--primary-color);
            border-color: var(--primary-color);
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .btn-outline-primary:hover {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(26, 115, 232, 0.3);
        }
        
        .text-muted {
            color: var(--light-text) !important;
        }

        .contact-links a {
            display: block;
            margin-bottom: 10px;
            color: var(--text-color);
            text-decoration: none;
        }

        .contact-links a:hover {
            color: var(--primary-color);
        }

        .product-type-badge {
            background-color: var(--primary-color);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            margin-right: 5px;
        }

        .mobile-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: var(--header-bg);
            display: flex;
            justify-content: space-around;
            padding: 10px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
        }

        .mobile-nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-decoration: none;
            color: var(--text-color);
            font-size: 0.8rem;
            position: relative;
        }

        .mobile-nav-item.active {
            color: var(--primary-color);
        }

        .out-of-stock {
            opacity: 0.6;
            position: relative;
        }

        .out-of-stock::after {
            content: "HAKUNA AKIBA";
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(255, 0, 0, 0.8);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-weight: bold;
            font-size: 0.9rem;
        }

        .address-card {
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            padding: 15px;
            margin-bottom: 10px;
            background-color: var(--card-bg);
            transition: all 0.3s ease;
        }

        .address-card:hover {
            border-color: var(--primary-color);
        }

        .address-card.selected {
            border-color: var(--primary-color);
            background-color: rgba(26, 115, 232, 0.1);
        }

        .address-card .btn-sm {
            margin-top: 10px;
        }

        /* Enhanced Mobile Responsiveness */
        @media (max-width: 768px) {
            .desktop-nav {
                display: none;
            }
            .mobile-nav {
                display: flex;
            }
            .footer-content {
                text-align: center;
            }
            footer h5::after {
                left: 50%;
                transform: translateX(-50%);
            }
            .product-detail-section {
                position: relative;
                background-color: var(--body-bg);
                padding: 15px;
            }
            .modal-dialog {
                margin: 10px;
            }
            .size-options-grid {
                grid-template-columns: repeat(auto-fill, minmax(55px, 1fr));
            }
            .loading-container {
                padding: 20px;
                width: 95%;
            }
            .logo-animation {
                width: 80px;
                height: 80px;
            }
            
            /* IMPROVED Cart Styling for Mobile - Fixed quantity selector */
            .cart-item .row {
                align-items: center;
                flex-wrap: nowrap;
            }
            
            .cart-item .col-2 {
                flex: 0 0 50px;
                max-width: 50px;
                padding: 5px;
            }
            
            .cart-item .col-5 {
                flex: 1;
                max-width: none;
                padding: 5px;
            }
            
            .cart-item .col-2:nth-child(3) {
                flex: 0 0 100px;
                max-width: 100px;
                padding: 5px;
            }
            
            .cart-item .col-2:nth-child(4) {
                flex: 0 0 80px;
                max-width: 80px;
                text-align: right;
                padding: 5px 10px 5px 5px;
            }
            
            .cart-item .col-1 {
                flex: 0 0 40px;
                max-width: 40px;
                padding: 5px 0 5px 5px;
            }
            
            .cart-item img {
                height: 50px !important;
                width: 50px;
                object-fit: cover;
            }
            
            .cart-item h6 {
                font-size: 0.85rem;
                margin-bottom: 3px;
                line-height: 1.2;
            }
            
            .cart-item p {
                font-size: 0.75rem;
                margin-bottom: 2px;
                line-height: 1.2;
            }
            
            .cart-item .quantity-selector {
                gap: 5px;
                justify-content: center;
            }
            
            .cart-item .quantity-btn {
                width: 28px;
                height: 28px;
                font-size: 0.9rem;
                display: flex;
                align-items: center;
                justify-content: center;
            }
            
            .cart-item .quantity-selector span {
                font-size: 0.9rem;
                min-width: 30px;
                text-align: center;
                font-weight: bold;
            }
            
            .cart-item .text-primary {
                font-size: 0.85rem;
                white-space: nowrap;
                font-weight: bold;
            }
            
            .cart-item .remove-item {
                padding: 5px 8px;
                font-size: 0.75rem;
                width: 30px;
                height: 30px;
                display: flex;
                align-items: center;
                justify-content: center;
            }
            
            /* Fixed spacing for mobile cart items */
            .cart-item {
                padding: 12px 0;
                margin: 0;
            }
            
            .cart-item .row > div {
                display: flex;
                align-items: center;
            }
            
            /* Improved Product Detail for Mobile */
            .product-detail-img {
                height: 250px;
            }
            
            /* Share links responsive */
            .share-links {
                gap: 8px;
            }
            
            .share-links a {
                width: 40px;
                height: 40px;
                font-size: 1rem;
            }
            
            .share-options .card-body {
                padding: 15px;
            }
            
            /* Theme controller for mobile in account menu */
            .account-menu li.theme-control-item {
                display: flex;
                justify-content: space-between;
                align-items: center;
            }
            
            .account-menu li.theme-control-item span {
                font-size: 0.9rem;
            }
            
            .account-menu li.theme-control-item .theme-switch {
                position: relative;
                display: inline-block;
                width: 50px;
                height: 24px;
            }
            
            .account-menu li.theme-control-item .theme-switch input {
                opacity: 0;
                width: 0;
                height: 0;
            }
            
            .account-menu li.theme-control-item .theme-slider {
                position: absolute;
                cursor: pointer;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background-color: #ccc;
                transition: .4s;
                border-radius: 34px;
            }
            
            .account-menu li.theme-control-item .theme-slider:before {
                position: absolute;
                content: "";
                height: 16px;
                width: 16px;
                left: 4px;
                bottom: 4px;
                background-color: white;
                transition: .4s;
                border-radius: 50%;
            }
            
            .account-menu li.theme-control-item input:checked + .theme-slider {
                background-color: var(--primary-color);
            }
            
            .account-menu li.theme-control-item input:checked + .theme-slider:before {
                transform: translateX(26px);
            }
        }

        @media (min-width: 769px) {
            .mobile-nav {
                display: none;
            }
            .mobile-theme-toggle {
                display: none !important;
            }
        }

        .star-rating {
            display: flex;
            gap: 5px;
            margin: 10px 0;
        }

        .star {
            font-size: 24px;
            color: #ddd;
            cursor: pointer;
            transition: color 0.2s;
        }

        .star.active {
            color: #ffc107;
        }
        
        .rating-section {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            background-color: var(--card-bg);
        }
        
        .rating-label {
            font-weight: bold;
            margin-bottom: 8px;
            color: var(--text-color);
        }
        
        .enhanced-rating {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .rating-value {
            font-weight: bold;
            color: var(--primary-color);
            min-width: 30px;
        }
        
        .rating-comment {
            margin-top: 10px;
            font-size: 0.9rem;
            color: var(--light-text);
            font-style: italic;
        }
        
        .order-actions {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }
        
        .order-actions .btn {
            font-size: 0.8rem;
            padding: 4px 8px;
        }
        
        .cancel-reason-input {
            margin-top: 10px;
        }
        
        .return-period-info {
            background-color: #f5c014;
            border: 1px solid #ffeaa7;
            border-radius: 5px;
            padding: 10px;
            margin-bottom: 15px;
            font-size: 0.9rem;
        }
        
        .order-details-modal .order-items {
            max-height: 300px;
            overflow-y: auto;
        }
        
        .order-item-row {
            border-bottom: 1px solid var(--border-color);
            padding: 10px 0;
        }
        
        .order-item-row:last-child {
            border-bottom: none;
        }
        
        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            max-height: 300px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }
        
        .search-result-item {
            padding: 10px 15px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .search-result-item:hover {
            background-color: var(--secondary-color);
        }
        
        .search-result-item:last-child {
            border-bottom: none;
        }
        
        .no-results {
            padding: 15px;
            text-align: center;
            color: var(--light-text);
        }
        
        .product-carousel-container {
            position: relative;
        }
        
        .product-carousel-thumbnails {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            overflow-x: auto;
            padding-bottom: 10px;
        }
        
        .product-carousel-thumbnails .thumbnail {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 8px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }
        
        .product-carousel-thumbnails .thumbnail.active {
            border-color: var(--primary-color);
        }
        
        .product-carousel-indicators {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-top: 15px;
        }
        
        .product-carousel-indicators .indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: var(--light-text);
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .product-carousel-indicators .indicator.active {
            background-color: var(--primary-color);
        }
        
        .product-rating-display {
            display: flex;
            align-items: center;
            gap: 5px;
            margin-bottom: 10px;
        }
        
        .product-rating-display .stars {
            color: #ffc107;
        }
        
        .product-rating-display .rating-text {
            font-size: 0.9rem;
            color: var(--light-text);
        }

        /* Enhanced Form Styling */
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-control-lg {
            padding: 15px;
            font-size: 16px;
        }
        
        .form-text {
            color: var(--light-text);
            font-size: 0.875rem;
            margin-top: 5px;
        }
        
        .input-group-text {
            background-color: var(--form-bg);
            border: 2px solid var(--form-border);
            color: var(--light-text);
        }
        
        /* Modal Form Styling */
        .modal-form .form-control {
            margin-bottom: 15px;
        }
        
        .modal-form .btn {
            margin-top: 10px;
            padding: 12px;
        }
        
        .forgot-password-link {
            color: var(--primary-color);
            cursor: pointer;
            text-decoration: none;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }
        
        .forgot-password-link:hover {
            color: var(--accent-color);
            text-decoration: underline;
        }
        
        .auth-switch-link {
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .auth-switch-link:hover {
            color: var(--accent-color);
            text-decoration: underline;
        }
        
        .form-divider {
            display: flex;
            align-items: center;
            margin: 25px 0;
            color: var(--light-text);
        }
        
        .form-divider::before,
        .form-divider::after {
            content: "";
            flex: 1;
            border-bottom: 1px solid var(--border-color);
        }
        
        .form-divider span {
            padding: 0 15px;
        }
        
        /* Enhanced Styling and Animations */
        .btn-confirm-order {
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
            padding: 12px 24px;
            font-weight: bold;
            font-size: 1.1rem;
        }

        .btn-confirm-order:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }

        .btn-confirm-order:active {
            transform: translateY(1px);
        }

        .btn-confirm-order .truck-icon {
            position: absolute;
            right: 15px;
            transition: transform 0.5s ease;
        }

        .btn-confirm-order.animating .truck-icon {
            animation: truckMove 1.5s ease-in-out;
        }

        @keyframes truckMove {
            0% {
                transform: translateX(0);
            }
            25% {
                transform: translateX(-10px);
            }
            50% {
                transform: translateX(-20px);
            }
            75% {
                transform: translateX(-10px);
            }
            100% {
                transform: translateX(0);
            }
        }

        .order-success-animation {
            text-align: center;
            padding: 20px;
        }

        .order-success-animation .success-icon {
            font-size: 5rem;
            color: var(--success-color);
            margin-bottom: 20px;
            animation: bounce 1s ease;
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% {
                transform: translateY(0);
            }
            40% {
                transform: translateY(-20px);
            }
            60% {
                transform: translateY(-10px);
            }
        }

        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            background-color: var(--accent-color);
            opacity: 0;
            z-index: 9999;
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.7);
            }
            70% {
                transform: scale(1.05);
                box-shadow: 0 0 0 10px rgba(40, 167, 69, 0);
            }
            100% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(40, 167, 69, 0);
            }
        }

        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .slide-in {
            animation: slideIn 0.5s ease-out;
        }

        @keyframes slideIn {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .btn-loading {
            pointer-events: none;
            opacity: 0.7;
        }

        .floating-action {
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
            100% { transform: translateY(0px); }
        }

        .progress-bar-animated {
            animation: progress-bar-stripes 1s linear infinite;
        }

        @keyframes progress-bar-stripes {
            0% { background-position: 1rem 0; }
            100% { background-position: 0 0; }
        }

        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: var(--danger-color);
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 0.7rem;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: pulse 1.5s infinite;
        }

        .cart-badge {
            position: relative;
        }

        .product-highlight {
            position: relative;
            overflow: hidden;
        }

        .product-highlight::before {
            content: "";
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(
                to bottom right,
                rgba(255, 255, 255, 0) 0%,
                rgba(255, 255, 255, 0.1) 50%,
                rgba(255, 255, 255, 0) 100%
            );
            transform: rotate(45deg);
            animation: shimmer 3s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
            100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
        }

        .discount-pulse {
            animation: discountPulse 2s infinite;
        }

        @keyframes discountPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .checkout-progress {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
            position: relative;
        }

        .checkout-progress::before {
            content: '';
            position: absolute;
            top: 15px;
            left: 0;
            right: 0;
            height: 2px;
            background-color: var(--border-color);
            z-index: 1;
        }

        .progress-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            z-index: 2;
        }

        .progress-step .step-circle {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background-color: var(--secondary-color);
            border: 2px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 8px;
            transition: all 0.3s ease;
        }

        .progress-step.active .step-circle {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
            color: white;
        }

        .progress-step.completed .step-circle {
            background-color: var(--success-color);
            border-color: var(--success-color);
            color: white;
        }

        .progress-step.completed .step-circle::after {
            content: "âœ“";
            font-weight: bold;
        }

        .progress-step .step-label {
            font-size: 0.8rem;
            text-align: center;
        }

        .delivery-estimation {
            background: linear-gradient(135deg, var(--primary-color), #4dabf7);
            color: white;
            border-radius: var(--radius);
            padding: 15px;
            margin: 20px 0;
            box-shadow: var(--shadow);
            animation: slideIn 0.5s ease-out;
        }

        .delivery-estimation h5 {
            margin-bottom: 10px;
            display: flex;
            align-items: center;
        }

        .delivery-estimation h5 i {
            margin-right: 10px;
        }

        .product-availability {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
            margin-left: 10px;
        }

        .in-stock {
            background-color: rgba(40, 167, 69, 0.1);
            color: var(--success-color);
        }

        .low-stock {
            background-color: rgba(255, 193, 7, 0.1);
            color: var(--warning-color);
        }

        .out-of-stock-badge {
            background-color: rgba(220, 53, 69, 0.1);
            color: var(--danger-color);
        }

        /* Admin Button Styles */
        .btn-admin {
            background-color: var(--admin-color);
            border-color: var(--admin-color);
            color: white;
            margin-left: 10px;
            transition: all 0.3s ease;
        }

        .btn-admin:hover {
            background-color: #5a32a3;
            border-color: #5a32a3;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(111, 66, 193, 0.3);
        }

        .btn-admin:active {
            transform: translateY(0);
        }

        .mobile-admin-btn {
            position: fixed;
            top: 15px;
            right: 15px;
            z-index: 1001;
            background-color: var(--admin-color);
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
        }

        .mobile-admin-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 12px rgba(0,0,0,0.3);
        }

        @media (max-width: 768px) {
            .desktop-admin-btn {
                display: none;
            }
        }

        @media (min-width: 769px) {
            .mobile-admin-btn {
                display: none;
            }
        }
        
        /* Password Verification Modal */
        .password-verification {
            padding: 20px;
        }
        
        .password-verification .form-control {
            margin-bottom: 15px;
        }
        
        .reset-options {
            margin-top: 20px;
        }
        
        .reset-options button {
            margin: 5px;
            width: 100%;
        }
        
        /* Additional Form Enhancements */
        .form-check {
            padding-left: 1.5rem;
        }
        
        .form-check-label {
            cursor: pointer;
        }
        
        .input-group {
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        
        .input-group .form-control:focus {
            z-index: 3;
        }
        
        .input-group-text {
            transition: all 0.3s ease;
        }
        
        .input-group:focus-within .input-group-text {
            border-color: var(--primary-color);
            color: var(--primary-color);
        }
        
        /* Select dropdown styling */
        .form-select {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%236c757d' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M2 5l6 6 6-6'/%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 16px 12px;
        }
        
        .form-select:focus {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%231a73e8' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M2 5l6 6 6-6'/%3e%3c/svg%3e");
        }
        
        /* Textarea styling */
        textarea.form-control {
            min-height: 100px;
            resize: vertical;
        }
        
        /* Alert styling in forms */
        .alert {
            border-radius: var(--radius);
            border: none;
            box-shadow: var(--shadow);
        }
        
        /* Form validation styling */
        .form-control.is-valid {
            border-color: var(--success-color);
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 8 8'%3e%3cpath fill='%2328a745' d='M2.3 6.73L.6 4.53c-.4-1.04.46-1.4 1.1-.8l1.1 1.4 3.4-3.8c.6-.63 1.6-.27 1.2.7l-4 4.6c-.43.5-.8.4-1.1.1z'/%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right calc(0.375em + 0.1875rem) center;
            background-size: calc(0.75em + 0.375rem) calc(0.75em + 0.375rem);
        }
        
        .form-control.is-invalid {
            border-color: var(--danger-color);
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 12 12' width='12' height='12' fill='none' stroke='%23dc3545'%3e%3ccircle cx='6' cy='6' r='4.5'/%3e%3cpath stroke-linejoin='round' d='M5.8 3.6h.4L6 6.5z'/%3e%3ccircle cx='6' cy='8.2' r='.6' fill='%23dc3545' stroke='none'/%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right calc(0.375em + 0.1875rem) center;
            background-size: calc(0.75em + 0.375rem) calc(0.75em + 0.375rem);
        }
        
        .invalid-feedback {
            color: var(--danger-color);
            font-size: 0.875rem;
            margin-top: 0.25rem;
        }
        
        .valid-feedback {
            color: var(--success-color);
            font-size: 0.875rem;
            margin-top: 0.25rem;
        }
        
        /* Form heading styles */
        .form-heading {
            color: var(--text-color);
            margin-bottom: 20px;
            font-weight: 600;
        }
        
        /* Form section styling */
        .form-section {
            background: var(--form-bg);
            border-radius: var(--form-radius);
            padding: 25px;
            margin-bottom: 25px;
            border: 1px solid var(--form-border);
            box-shadow: var(--shadow);
        }
        
        /* Placeholder styling */
        ::placeholder {
            color: var(--light-text);
            opacity: 0.7;
        }
        
        /* Form animation */
        .form-animate {
            animation: formSlideIn 0.5s ease-out;
        }
        
        @keyframes formSlideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Improved modal backdrop */
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.5);
        }
        
        /* Form button container */
        .form-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        /* Enhanced radio button styling */
        .form-check-input[type="radio"] {
            border-radius: 50%;
        }
        
        /* Checkbox styling */
        .form-check-input[type="checkbox"]:checked {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }
        
        /* Form field with icon */
        .form-field-with-icon {
            position: relative;
        }
        
        .form-field-with-icon .form-control {
            padding-left: 40px;
        }
        
        .form-field-with-icon i {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--light-text);
            z-index: 3;
        }
        
        /* Password strength indicator */
        .password-strength {
            height: 4px;
            margin-top: 5px;
            border-radius: 2px;
            background: var(--border-color);
            overflow: hidden;
        }
        
        .password-strength-meter {
            height: 100%;
            width: 0;
            border-radius: 2px;
            transition: all 0.3s ease;
        }
        
        .strength-weak {
            background: var(--danger-color);
            width: 25%;
        }
        
        .strength-medium {
            background: var(--warning-color);
            width: 50%;
        }
        
        .strength-strong {
            background: var(--success-color);
            width: 75%;
        }
        
        .strength-very-strong {
            background: var(--success-color);
            width: 100%;
        }
        
        .cart-size-badge {
            background-color: var(--primary-color);
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.7rem;
            margin-left: 5px;
        }
        
        .product-size-badge {
            background-color: var(--accent-color);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            margin-left: 5px;
        }
        
        .terms-link {
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 500;
        }
        
        .terms-link:hover {
            text-decoration: underline;
        }
        
        /* Enhanced Product Description Styling */
        .product-description-container {
            margin: 20px 0;
            padding: 20px;
            background-color: var(--card-bg);
            border-radius: var(--radius);
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow);
        }
        
        .product-description-container h4 {
            color: var(--primary-color);
            margin-bottom: 15px;
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 8px;
        }
        
        .product-description-text {
            line-height: 1.6;
            color: var(--text-color);
            font-size: 1rem;
            white-space: pre-line;
        }
        
        .product-description-text p {
            margin-bottom: 10px;
        }
        
        .description-placeholder {
            color: var(--light-text);
            font-style: italic;
        }
        
        /* Button Loading State */
        .btn-loading-state {
            position: relative;
            pointer-events: none;
            opacity: 0.8;
        }
        
        .btn-loading-state .btn-text {
            visibility: hidden;
        }
        
        .btn-loading-state::after {
            content: "";
            position: absolute;
            width: 20px;
            height: 20px;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            margin: auto;
            border: 3px solid transparent;
            border-top-color: #ffffff;
            border-radius: 50%;
            animation: button-loading-spinner 1s ease infinite;
        }
        
        @keyframes button-loading-spinner {
            from {
                transform: rotate(0turn);
            }
            to {
                transform: rotate(1turn);
            }
        }
        
        /* Responsive adjustments */
        @media (max-width: 576px) {
            .product-description-container {
                padding: 15px;
            }
            
            .product-description-text {
                font-size: 0.95rem;
            }
            
            .size-option {
                height: 45px;
                font-size: 0.9rem;
            }
            
            /* Mobile cart quantity selector improvements - FIXED */
            .cart-item .row {
                flex-wrap: nowrap;
                margin: 0;
            }
            
            .cart-item .col-2 {
                flex: 0 0 50px;
                max-width: 50px;
                padding: 3px;
            }
            
            .cart-item .col-5 {
                flex: 1;
                max-width: none;
                padding: 3px;
                min-width: 0;
                overflow: hidden;
            }
            
            .cart-item .col-2:nth-child(3) {
                flex: 0 0 100px;
                max-width: 100px;
                padding: 3px;
            }
            
            .cart-item .col-2:nth-child(4) {
                flex: 0 0 80px;
                max-width: 80px;
                text-align: right;
                padding: 3px 5px 3px 3px;
            }
            
            .cart-item .col-1 {
                flex: 0 0 40px;
                max-width: 40px;
                padding: 3px 0 3px 3px;
            }
            
            .cart-item .text-primary {
                font-size: 0.85rem;
                white-space: nowrap;
            }
            
            /* Better spacing for cart items on very small screens */
            .cart-item {
                padding: 10px 0;
                margin: 0;
            }
        }

        /* Share button in product detail */
        .share-product-btn {
            position: fixed;
            bottom: 80px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-color), #0d6efd);
            color: white;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            z-index: 999;
            transition: all 0.3s ease;
        }

        .share-product-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 15px rgba(0,0,0,0.3);
        }

        @media (max-width: 768px) {
            .share-product-btn {
                bottom: 70px;
                right: 15px;
                width: 45px;
                height: 45px;
                font-size: 1rem;
            }
        }

        /* Improved cart item layout for mobile - FIXED */
        .cart-item .row > div {
            display: flex;
            align-items: center;
        }

        .cart-item .quantity-selector {
            justify-content: center;
            flex-wrap: nowrap;
        }

        .cart-item .text-end {
            justify-content: flex-end;
        }

        /* Share modal improvements */
        .share-modal-body {
            padding: 20px;
        }

        .share-platforms {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .share-platform {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 15px;
            border-radius: 10px;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
            cursor: pointer;
            text-decoration: none;
            color: var(--text-color);
        }

        .share-platform:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            border-color: var(--primary-color);
        }

        .share-platform i {
            font-size: 1.5rem;
            margin-bottom: 8px;
        }

        .share-platform-name {
            font-size: 0.8rem;
            font-weight: 500;
        }

        @media (max-width: 576px) {
            .share-platforms {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }
            
            .share-platform {
                padding: 10px;
            }
            
            .share-platform i {
                font-size: 1.2rem;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div id="loading-screen">
        <div class="loading-container">
            <div class="logo-animation">
                <div class="logo-circle"></div>
                <div class="logo-inner">FBSC</div>
            </div>
            
            <h3 class="loading-text">Four Brothers Sports Center</h3>
            <p class="loading-subtext">Inapakua programu yako...</p>
            
            <div class="progress-container">
                <div class="progress-bar"></div>
            </div>
            
            <div class="loading-dots">
                <div class="dot"></div>
                <div class="dot"></div>
                <div class="dot"></div>
            </div>
            
            <div class="loading-stats">
                <div class="stat-item">
                    <div class="stat-value" id="loading-products">0</div>
                    <div class="stat-label">Bidhaa</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="loading-users">0</div>
                    <div class="stat-label">Wateja</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="loading-orders">0</div>
                    <div class="stat-label">Maagizo</div>
                </div>
            </div>
            
            <div class="loading-error" id="loading-error">
                <i class="fas fa-exclamation-triangle me-2"></i>
                <strong>Hitilafu ya Mtandao:</strong> Haijaweza kuunganishwa na seva. 
                <p class="mb-0 mt-2">Programu itatumia data ya mfano kwa sasa. Unaweza kujaribu tena baadaye.</p>
                <button class="retry-button" id="retry-loading">
                    <i class="fas fa-redo me-2"></i>Jaribu Tena
                </button>
            </div>
            
            <div class="loading-success" id="loading-success">
                <i class="fas fa-check-circle me-2"></i>
                <strong>Imefanikiwa!</strong> Programu imepakuliwa na ina tayari kutumika.
                <p class="mb-0 mt-2">Tunaongoza kwenye ukurasa wa nyumbani...</p>
            </div>
        </div>
    </div>
    
    <!-- Main App Content (Initially Hidden) -->
    <div id="app-content" style="opacity: 0;">
        <!-- Navigation -->
        <nav class="navbar navbar-expand-lg navbar-light shadow-sm desktop-nav">
            <div class="container">
                <a class="navbar-brand" href="#">
                    <img src="images/FBSC.png" alt="Four Brothers Sports Center Logo">
                </a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarNav">
                    <ul class="navbar-nav me-auto">
                        <li class="nav-item">
                            <a class="nav-link active" href="#" data-section="home">Nyumbani</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link cart-badge" href="#" data-section="cart">
                                Karatasi
                                <span id="cart-badge" class="notification-badge" style="display: none;">0</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" data-section="account">Akaunti</a>
                        </li>
                    </ul>
                    <div class="d-flex align-items-center">
                        <div class="search-bar me-3">
                            <input type="text" class="form-control" placeholder="Tafuta bidhaa..." id="search-input">
                            <i class="fas fa-search"></i>
                            <div class="search-results" id="search-results"></div>
                        </div>
                        <button class="theme-toggle" id="theme-toggle">
                            <i class="fas fa-moon"></i>
                        </button>
                        <!-- Admin Button for Desktop -->
                        <a href="admin.html" class="btn btn-admin desktop-admin-btn">
                            <i class="fas fa-user-shield me-2"></i>Admin
                        </a>
                        <div id="auth-section">
                            <!-- Will be populated by JavaScript -->
                        </div>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Admin Button for Mobile -->
        <a href="admin.html" class="mobile-admin-btn">
            <i class="fas fa-user-shield"></i>
        </a>

        <!-- Mobile Navigation -->
        <div class="mobile-nav">
            <a href="#" class="mobile-nav-item active" data-section="home">
                <i class="fas fa-home"></i>
                <span>Nyumbani</span>
            </a>
            <a href="#" class="mobile-nav-item cart-badge" data-section="cart">
                <i class="fas fa-shopping-cart"></i>
                <span>Karatasi</span>
                <span id="mobile-cart-badge" class="notification-badge" style="display: none;">0</span>
            </a>
            <a href="#" class="mobile-nav-item" data-section="account">
                <i class="fas fa-user"></i>
                <span>Akaunti</span>
            </a>
        </div>

        <!-- Main Content -->
        <div class="container mt-4 mb-5 main-content">
            <!-- Home Section -->
            <section id="home-section">
                <!-- Ads Container -->
                <div class="ads-container">
                    <div id="adsCarousel" class="carousel slide h-100" data-bs-ride="carousel">
                        <div class="carousel-inner h-100">
                            <!-- Ads will be dynamically loaded -->
                        </div>
                        <button class="carousel-control-prev" type="button" data-bs-target="#adsCarousel" data-bs-slide="prev">
                            <span class="carousel-control-prev-icon"></span>
                        </button>
                        <button class="carousel-control-next" type="button" data-bs-target="#adsCarousel" data-bs-slide="next">
                            <span class="carousel-control-next-icon"></span>
                        </button>
                    </div>
                </div>

                <!-- Announcements -->
                <div class="announcements" id="announcements-container" style="display: none;">
                    <i class="fas fa-bullhorn me-2"></i>
                    <strong>Tangazo:</strong> 
                    <marquee behavior="scroll" direction="left" id="announcement-text">Inapakua...</marquee>
                </div>

                <!-- Products Grid -->
                <h3 class="section-title">Bidhaa Zetu</h3>
                <div class="row" id="products-grid">
                    <!-- Products will be loaded here -->
                </div>
            </section>

            <!-- Product Detail Section -->
            <section id="product-detail-section" class="hidden">
                <button class="btn btn-outline-secondary mb-3" id="back-to-products">
                    <i class="fas fa-arrow-left me-2"></i>Rudi kwenye bidhaa
                </button>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="product-carousel-container">
                            <div id="productImagesCarousel" class="carousel slide" data-bs-ride="carousel">
                                <div class="carousel-inner" id="product-carousel-inner">
                                    <!-- Product images will be loaded here -->
                                </div>
                                <button class="carousel-control-prev" type="button" data-bs-target="#productImagesCarousel" data-bs-slide="prev">
                                    <span class="carousel-control-prev-icon"></span>
                                </button>
                                <button class="carousel-control-next" type="button" data-bs-target="#productImagesCarousel" data-bs-slide="next">
                                    <span class="carousel-control-next-icon"></span>
                                </button>
                                <div class="product-carousel-indicators" id="product-carousel-indicators">
                                    <!-- Indicators will be loaded here -->
                                </div>
                            </div>
                            <div class="product-carousel-thumbnails" id="product-carousel-thumbnails">
                                <!-- Thumbnails will be loaded here -->
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h2 id="product-name">Jina la Bidhaa</h2>
                        <div class="product-rating-display" id="product-rating-display">
                            <div class="stars" id="product-rating-stars-display">
                                <!-- Stars will be loaded here -->
                            </div>
                            <div class="rating-text" id="product-rating-text">(0 tathmini)</div>
                        </div>
                        
                        <div class="mb-3">
                            <span class="price-old" id="old-price"></span>
                            <span class="price-new" id="current-price">TZS 0</span>
                            <span class="offer-badge discount-pulse" id="offer-badge" style="display: none;">0% OFF</span>
                        </div>
                        
                        <!-- Enhanced Product Description Section -->
                        <div class="product-description-container">
                            <h4>Maelezo ya Bidhaa</h4>
                            <div class="product-description-text" id="product-description">
                                Maelezo ya bidhaa yataonyeshwa hapa.
                            </div>
                            <div id="description-placeholder" class="description-placeholder hidden">
                                Bidhaa haina maelezo ya ziada.
                            </div>
                        </div>
                        
                        <!-- Enhanced Size Selection -->
                        <div class="size-options-container">
                            <h5>Chagua Saizi (EU)</h5>
                            <div class="size-options-grid" id="size-options">
                                <!-- Size options will be loaded here -->
                            </div>
                            <div class="mt-2">
                                <small class="text-muted">Nambari ndani ya mabano inaonyesha idadi ya akiba kwa kila saizi</small>
                            </div>
                        </div>
                        
                        <div class="d-flex align-items-center mb-4">
                            <span class="me-3"><strong>Idadi:</strong></span>
                            <div class="quantity-selector">
                                <div class="quantity-btn" id="decrease-qty">-</div>
                                <span id="quantity">1</span>
                                <div class="quantity-btn" id="increase-qty">+</div>
                            </div>
                            <span class="ms-3 text-muted" id="stock-info"></span>
                            <span id="stock-badge" class="product-availability in-stock"></span>
                        </div>
                        
                        <div class="delivery-estimation">
                            <h5><i class="fas fa-truck"></i> Makadirio ya Uwasilishaji</h5>
                            <p class="mb-0">Utapokea Bidhaa Hii: <strong id="delivery-date">Jumamosi ijayo</strong></p>
                        </div>
                        
                        <button class="btn btn-primary btn-lg w-100 floating-action" id="add-to-cart">
                            <i class="fas fa-shopping-cart me-2"></i>Weka kwenye Karatasi
                        </button>
                    </div>
                </div>
                
                <!-- Product Details Tabs -->
                <div class="mt-5">
                    <ul class="nav nav-tabs" id="productDetailsTabs">
                        <li class="nav-item">
                            <a class="nav-link active" data-bs-toggle="tab" href="#details">Maelezo Zaidi</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" data-bs-toggle="tab" href="#reviews">Tathmini</a>
                        </li>
                    </ul>
                    <div class="tab-content p-3 border border-top-0">
                        <div class="tab-pane fade show active" id="details">
                            <!-- Additional product details will be loaded here -->
                        </div>
                        <div class="tab-pane fade" id="reviews">
                            <!-- Reviews will be loaded here -->
                        </div>
                    </div>
                </div>
                
                <!-- Share Product Button (Fixed Position) -->
                <button class="share-product-btn" id="share-product-detail-btn" title="Shiriki bidhaa hii">
                    <i class="fas fa-share-alt"></i>
                </button>
            </section>

            <!-- Cart Section -->
            <section id="cart-section" class="hidden">
                <h2 class="section-title">Karatasi Yangu</h2>
                
                <div class="row">
                    <div class="col-md-8">
                        <div id="cart-items">
                            <!-- Cart items will be loaded here -->
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card slide-in">
                            <div class="card-header bg-primary text-white">
                                <h5 class="mb-0">Muhtasari wa Agizo</h5>
                            </div>
                            <div class="card-body">
                                <div class="d-flex justify-content-between mb-2">
                                    <span>Jumla ya Bidhaa:</span>
                                    <span id="cart-items-count">0 </span>
                                </div>
                                <div class="d-flex justify-content-between mb-2">
                                    <span>Jumla ya Bei:</span>
                                    <span id="cart-subtotal">TZS 0</span>
                                </div>
                                <div class="d-flex justify-content-between mb-2">
                                    <span>Usafirishaji:</span>
                                    <span>TZS 0</span>
                                </div>
                                <div class="d-flex justify-content-between mb-2">
                                    <span>Punguzo:</span>
                                    <span id="cart-discount">TZS 0</span>
                                </div>
                                <hr>
                                <div class="d-flex justify-content-between mb-3">
                                    <strong>Jumla:</strong>
                                    <strong id="cart-total">TZS 0</strong>
                                </div>
                                <button class="btn btn-primary w-100 pulse" id="proceed-to-checkout">
                                    Endelea kwa Malipo
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Checkout Section -->
            <section id="checkout-section" class="hidden">
                <h2 class="section-title">Malipo</h2>
                
                <!-- Enhanced Checkout Progress -->
                <div class="checkout-progress">
                    <div class="progress-step active" id="step-address">
                        <div class="step-circle">1</div>
                        <div class="step-label">Anwani</div>
                    </div>
                    <div class="progress-step" id="step-summary">
                        <div class="step-circle">2</div>
                        <div class="step-label">Muhtasari</div>
                    </div>
                    <div class="progress-step" id="step-payment">
                        <div class="step-circle">3</div>
                        <div class="step-label">Malipo</div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-8">
                        <!-- Step 1: Address Selection -->
                        <div id="checkout-step-1" class="fade-in">
                            <h4>Chagua Anwani ya Mshipisho</h4>
                            <div id="address-selection">
                                <!-- Saved addresses will be loaded here -->
                            </div>
                            <div class="mt-3">
                                <button class="btn btn-outline-primary" id="add-new-address-checkout">Ongeza Anwani Mpya</button>
                            </div>
                            <div class="mt-3" id="new-address-form" style="display: none;">
                                <div class="mb-3">
                                    <label for="new-shipping-address" class="form-label">Anwani Mpya Kamili</label>
                                    <textarea class="form-control" id="new-shipping-address" rows="3"></textarea>
                                </div>
                                <button class="btn btn-primary" id="save-new-address">Hifadhi Anwani Mpya</button>
                            </div>
                            <div class="mt-3">
                                <button class="btn btn-primary" id="continue-to-summary" style="display: none;">Endelea kwa Muhtasari</button>
                            </div>
                        </div>
                        
                        <!-- Step 2: Order Summary -->
                        <div id="checkout-step-2" class="hidden">
                            <h4>Muhtasari wa Agizo</h4>
                            <div class="card slide-in">
                                <div class="card-body">
                                    <div id="checkout-items">
                                        <!-- Order items will be loaded here -->
                                    </div>
                                    <hr>
                                    <div class="d-flex justify-content-between mb-2">
                                        <span>Jumla ya Bidhaa:</span>
                                        <span id="checkout-items-count">0 </span>
                                    </div>
                                    <div class="d-flex justify-content-between mb-2">
                                        <span>Jumla ya Bei:</span>
                                        <span id="checkout-subtotal">TZS 0</span>
                                    </div>
                                    <div class="d-flex justify-content-between mb-2">
                                        <span>Usafirishaji:</span>
                                        <span>TZS 0</span>
                                    </div>
                                    <div class="d-flex justify-content-between mb-2">
                                        <span>Punguzo:</span>
                                        <span id="checkout-discount">TZS 0</span>
                                    </div>
                                    <hr>
                                    <div class="d-flex justify-content-between mb-3">
                                        <strong>Jumla:</strong>
                                        <strong id="checkout-total">TZS 0</strong>
                                    </div>
                                </div>
                            </div>
                            <button class="btn btn-primary mt-3 pulse" id="proceed-to-payment">Endelea kwa Malipo</button>
                        </div>
                        
                        <!-- Step 3: Payment -->
                        <div id="checkout-step-3" class="hidden">
                            <h4>Malipo</h4>
                            <div class="card slide-in">
                                <div class="card-body">
                                    <p class="mb-3">Malipo yanafanyika kwa pesa taslimu (COD) unapopokea bidhaa.</p>
                                    
                                    <!-- Password Verification for First Order -->
                                    <div class="mb-3" id="password-verification-section" style="display: none;">
                                        <div class="alert alert-info">
                                            <i class="fas fa-info-circle me-2"></i>
                                            Kwa ajili ya usalama, tafadhali ingiza nenosiri lako kuthibitisha agizo lako la kwanza.
                                        </div>
                                        <div class="mb-3">
                                            <label for="password-verification" class="form-label">Nenosiri lako</label>
                                            <input type="password" class="form-control" id="password-verification" placeholder="Ingiza nenosiri lako">
                                            <div class="form-text">
                                                <span class="forgot-password-link" id="forgot-password-checkout">Umesahau nenosiri?</span>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <button class="btn btn-success w-100 btn-lg btn-confirm-order" id="confirm-order">
                                        <span class="btn-text">Thibitisha Agizo</span>
                                        <i class="fas fa-truck truck-icon"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Account Section -->
            <section id="account-section" class="hidden">
                <h2 class="section-title">Akaunti Yangu</h2>
                
                <div class="row">
                    <div class="col-md-3">
                        <ul class="account-menu">
                            <li class="active" data-account-tab="orders">Agizo Zangu</li>
                            <li data-account-tab="contact">Mawasiliano</li>
                            <li data-account-tab="addresses">Anwani Zilizohifadhiwa</li>
                            <li data-account-tab="profile">Hariri Profaili</li>
                            <!-- Theme Control Item for Mobile -->
                            <li class="theme-control-item" id="mobile-theme-control">
                                <span>Mwonekano</span>
                                <label class="theme-switch">
                                    <input type="checkbox" id="mobile-theme-switch">
                                    <span class="theme-slider"></span>
                                </label>
                            </li>
                            <li id="logout-btn">Toka</li>
                        </ul>
                    </div>
                    <div class="col-md-9">
                        <!-- Orders Tab -->
                        <div id="account-orders">
                            <h4>Historia ya Maagizo</h4>
                            <div class="table-responsive">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>Namba ya Agizo</th>
                                            <th>Jumla</th>
                                            <th>Hali</th>
                                            <th>Tarehe</th>
                                            <th>Vitendo</th>
                                        </tr>
                                    </thead>
                                    <tbody id="orders-table-body">
                                        <!-- Orders will be loaded here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <!-- Contact Tab -->
                        <div id="account-contact" class="hidden">
                            <h4>Mawasiliano</h4>
                            <div class="contact-links">
                                <a href="https://wa.me/255777730606" target="_blank">
                                    <i class="fab fa-whatsapp me-2"></i>WhatsApp: +255 777 730 606
                                </a>
                                <a href="https://www.instagram.com/four_brothers_sports_center?igsh=d20xYno3dmlwcnJ4" target="_blank">
                                    <i class="fab fa-instagram me-2"></i>Instagram: @four_brothers_sports_center
                                </a>
                                <a href="mailto:fourbrothers10112627@gmail.com">
                                    <i class="fas fa-envelope me-2"></i>Email: fourbrothers10112627@gmail.com
                                </a>
                                <a href="#" data-bs-toggle="modal" data-bs-target="#messageModal">
                                    <i class="fas fa-comment me-2"></i>Tuma Ujumbe Ndani ya Programu
                                </a>
                            </div>
                        </div>
                        
                        <!-- Addresses Tab -->
                        <div id="account-addresses" class="hidden">
                            <h4>Anwani Zilizohifadhiwa</h4>
                            <div id="saved-addresses">
                                <!-- Saved addresses will be loaded here -->
                            </div>
                            <button class="btn btn-primary mt-3" id="add-new-address">Ongeza Anwani Mpya</button>
                        </div>
                        
                        <!-- Profile Tab -->
                        <div id="account-profile" class="hidden">
                            <h4>Hariri Profaili</h4>
                            <form id="profile-form">
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label for="first-name" class="form-label">Jina la Kwanza</label>
                                        <input type="text" class="form-control" id="first-name">
                                    </div>
                                    <div class="col-md-6">
                                        <label for="last-name" class="form-label">Jina la Mwisho</label>
                                        <input type="text" class="form-control" id="last-name">
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="mobile" class="form-label">Nambari ya Simu</label>
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="mobile" readonly>
                                        <button class="btn btn-outline-secondary" type="button" id="change-mobile-btn">Badilisha</button>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="email" class="form-label">Barua Pepe</label>
                                    <div class="input-group">
                                        <input type="email" class="form-control" id="email">
                                        <button class="btn btn-outline-secondary" type="button" id="change-email-btn">Badilisha</button>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="address" class="form-label">Anwani</label>
                                    <textarea class="form-control" id="address" rows="3"></textarea>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Jinsia</label>
                                    <div>
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="radio" name="gender" id="male" value="mwanaume">
                                            <label class="form-check-label" for="male">Mwanaume</label>
                                        </div>
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="radio" name="gender" id="female" value="mwanamke">
                                            <label class="form-check-label" for="female">Mwanamke</label>
                                        </div>
                                    </div>
                                </div>
                                <button type="submit" class="btn btn-primary" id="profile-save-btn">
                                    <span class="btn-text">Hifadhi Mabadiliko</span>
                                </button>
                            </form>
                            
                            <!-- Change Password Section -->
                            <div class="mt-5">
                                <h5>Badilisha Nenosiri</h5>
                                <form id="change-password-form">
                                    <div class="mb-3">
                                        <label for="current-password" class="form-label">Nenosiri la Sasa</label>
                                        <input type="password" class="form-control" id="current-password" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="new-password" class="form-label">Nenosiri Jipya</label>
                                        <input type="password" class="form-control" id="new-password" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="confirm-new-password" class="form-label">Rudia Nenosiri Jipya</label>
                                        <input type="password" class="form-control" id="confirm-new-password" required>
                                    </div>
                                    <button type="submit" class="btn btn-primary" id="change-password-btn">
                                        <span class="btn-text">Badilisha Nenosiri</span>
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Login Modal with Professional Styling -->
            <div class="modal fade" id="loginModal" tabindex="-1">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Ingia kwenye Akaunti Yako</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="text-center mb-4">
                                <div class="profile-icon d-inline-flex align-items-center justify-content-center" style="width: 60px; height: 60px; font-size: 1.5rem; background: var(--primary-color);">
                                    <i class="fas fa-user"></i>
                                </div>
                                <h4 class="mt-3">Karibu Tena</h4>
                                <p class="text-muted">Ingia kwenye akaunti yako ili kuendelea</p>
                            </div>
                            
                            <form id="login-form" class="modal-form">
                                <div class="mb-3">
                                    <label for="login-mobile" class="form-label">Nambari ya Simu</label>
                                    <div class="form-field-with-icon">
                                        <i class="fas fa-phone"></i>
                                        <input type="text" class="form-control form-control-lg" id="login-mobile" placeholder="07XX XXX XXX" required>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="login-password" class="form-label">Nenosiri</label>
                                    <div class="form-field-with-icon">
                                        <i class="fas fa-lock"></i>
                                        <input type="password" class="form-control form-control-lg" id="login-password" placeholder="Ingiza nenosiri lako" required>
                                    </div>
                                    <div class="form-text text-end">
                                        <span class="forgot-password-link" id="forgot-password-login">Umesahau nenosiri?</span>
                                    </div>
                                </div>
                                <button type="submit" class="btn btn-primary w-100 btn-lg mt-3" id="login-submit-btn">
                                    <i class="fas fa-sign-in-alt me-2"></i>
                                    <span class="btn-text">Ingia</span>
                                </button>
                            </form>
                            
                            <div class="form-divider">
                                <span>Ama</span>
                            </div>
                            
                            <div class="text-center mt-4">
                                <p class="mb-0">Huna akaunti? 
                                    <a href="#" class="auth-switch-link" id="show-register">Jiandikishe hapa</a>
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Registration Modal with Professional Styling -->
            <div class="modal fade" id="registerModal" tabindex="-1">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Jiandikishe Sasa</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="text-center mb-4">
                                <div class="profile-icon d-inline-flex align-items-center justify-content-center" style="width: 60px; height: 60px; font-size: 1.5rem; background: var(--accent-color);">
                                    <i class="fas fa-user-plus"></i>
                                </div>
                                <h4 class="mt-3">Uanze Safari Yako</h4>
                                <p class="text-muted">Unda akaunti yako kwa dakika chache tu</p>
                            </div>
                            
                            <form id="register-form" class="modal-form">
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label for="reg-first-name" class="form-label">Jina la Kwanza</label>
                                        <div class="form-field-with-icon">
                                            <i class="fas fa-user"></i>
                                            <input type="text" class="form-control" id="reg-first-name" placeholder="Mohammed" required>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="reg-last-name" class="form-label">Jina la Mwisho</label>
                                        <div class="form-field-with-icon">
                                            <i class="fas fa-user"></i>
                                            <input type="text" class="form-control" id="reg-last-name" placeholder="Shehe" required>
                                        </div>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="reg-mobile" class="form-label">Nambari ya Simu</label>
                                    <div class="form-field-with-icon">
                                        <i class="fas fa-phone"></i>
                                        <input type="text" class="form-control" id="reg-mobile" placeholder="07XX XXX XXX" required>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="reg-password" class="form-label">Nenosiri</label>
                                    <div class="form-field-with-icon">
                                        <i class="fas fa-lock"></i>
                                        <input type="password" class="form-control" id="reg-password" placeholder="Chagua nenosiri lenye nguvu" required>
                                    </div>
                                    <div class="password-strength">
                                        <div class="password-strength-meter" id="password-strength-meter"></div>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="reg-confirm-password" class="form-label">Rudia Nenosiri</label>
                                    <div class="form-field-with-icon">
                                        <i class="fas fa-lock"></i>
                                        <input type="password" class="form-control" id="reg-confirm-password" placeholder="Rudia nenosiri lako" required>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="reg-email" class="form-label">Barua Pepe (Hiari)</label>
                                    <div class="form-field-with-icon">
                                        <i class="fas fa-envelope"></i>
                                        <input type="email" class="form-control" id="reg-email" placeholder="jina@mfano.com">
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="reg-address" class="form-label">Anwani Kamili</label>
                                    <div class="form-field-with-icon">
                                        <i class="fas fa-map-marker-alt"></i>
                                        <textarea class="form-control" id="reg-address" rows="2" placeholder="Andika anwani yako kamili" required></textarea>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Jinsia</label>
                                    <div class="d-flex gap-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="reg-gender" id="reg-male" value="mwanaume" required>
                                            <label class="form-check-label" for="reg-male">
                                                <i class="fas fa-male me-1"></i> Mwanaume
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="reg-gender" id="reg-female" value="mwanamke">
                                            <label class="form-check-label" for="reg-female">
                                                <i class="fas fa-female me-1"></i> Mwanamke
                                            </label>
                                        </div>
                                    </div>
                                </div>
                                <div class="mb-3 form-check">
                                    <input type="checkbox" class="form-check-input" id="agree-terms" required>
                                    <label class="form-check-label" for="agree-terms">
                                        Nimekubaliana na 
                                        <a href="regulations.html" target="_blank" class="terms-link" id="terms-link">Masharti ya Huduma</a>
                                    </label>
                                </div>
                                <button type="submit" class="btn btn-primary w-100 btn-lg" id="register-submit-btn">
                                    <i class="fas fa-user-plus me-2"></i>
                                    <span class="btn-text">Jiandikishe</span>
                                </button>
                            </form>
                            
                            <div class="text-center mt-4">
                                <p class="mb-0">Tayari una akaunti? 
                                    <a href="#" class="auth-switch-link" id="show-login">Ingia hapa</a>
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Forgot Password Modal with Professional Styling -->
            <div class="modal fade" id="forgotPasswordModal" tabindex="-1">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Umesahau Nenosiri?</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="text-center mb-4">
                                <div class="profile-icon d-inline-flex align-items-center justify-content-center" style="width: 60px; height: 60px; font-size: 1.5rem; background: var(--warning-color);">
                                    <i class="fas fa-key"></i>
                                </div>
                                <h4 class="mt-3">Pata Upya Nenosiri Lako</h4>
                                <p class="text-muted">Tutakusaidia kupata nenosiri lako upya kwa urahisi</p>
                            </div>
                            
                            <div id="forgot-password-step-1">
                                <form id="forgot-password-form">
                                    <div class="mb-4">
                                        <p class="mb-3">Weka jina lako la kwanza na jina la mwisho kuthibitisha utambulisho wako.</p>
                                    </div>
                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <label for="forgot-first-name" class="form-label">Jina la Kwanza</label>
                                            <div class="form-field-with-icon">
                                                <i class="fas fa-user"></i>
                                                <input type="text" class="form-control" id="forgot-first-name" placeholder="Mohammed" required>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <label for="forgot-last-name" class="form-label">Jina la Mwisho</label>
                                            <div class="form-field-with-icon">
                                                <i class="fas fa-user"></i>
                                                <input type="text" class="form-control" id="forgot-last-name" placeholder="Shehe" required>
                                            </div>
                                        </div>
                                    </div>
                                    <button type="submit" class="btn btn-primary w-100" id="forgot-password-submit-btn">
                                        <i class="fas fa-arrow-right me-2"></i>
                                        <span class="btn-text">Endelea</span>
                                    </button>
                                </form>
                            </div>
                            
                            <div id="forgot-password-step-2" class="hidden">
                                <div class="text-center mb-4">
                                    <p class="mb-3">Chagua kile unachotaka kubadilisha:</p>
                                </div>
                                <div class="reset-options">
                                    <button class="btn btn-outline-primary btn-lg mb-3" id="reset-password-btn">
                                        <i class="fas fa-lock me-2"></i>Badilisha Nenosiri
                                    </button>
                                    <button class="btn btn-outline-secondary btn-lg" id="reset-mobile-btn">
                                        <i class="fas fa-phone me-2"></i>Badilisha Nambari ya Simu
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Reset Password Form -->
                            <div id="reset-password-form" class="hidden">
                                <div class="text-center mb-4">
                                    <p class="mb-3">Weka nenosiri jipya lako:</p>
                                </div>
                                <form id="new-password-form">
                                    <div class="mb-3">
                                        <label for="new-password-reset" class="form-label">Nenosiri Jipya</label>
                                        <div class="form-field-with-icon">
                                            <i class="fas fa-lock"></i>
                                            <input type="password" class="form-control" id="new-password-reset" placeholder="Nenosiri jipya" required>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label for="confirm-new-password-reset" class="form-label">Rudia Nenosiri Jipya</label>
                                        <div class="form-field-with-icon">
                                            <i class="fas fa-lock"></i>
                                            <input type="password" class="form-control" id="confirm-new-password-reset" placeholder="Rudia nenosiri jipya" required>
                                        </div>
                                    </div>
                                    <button type="submit" class="btn btn-primary w-100" id="reset-password-submit-btn">
                                        <i class="fas fa-check me-2"></i>
                                        <span class="btn-text">Weka Nenosiri Jipya</span>
                                    </button>
                                </form>
                            </div>
                            
                            <!-- Reset Mobile Form -->
                            <div id="reset-mobile-form" class="hidden">
                                <div class="text-center mb-4">
                                    <p class="mb-3">Weka nambari mpya ya simu:</p>
                                </div>
                                <form id="new-mobile-form">
                                    <div class="mb-3">
                                        <label for="new-mobile" class="form-label">Nambari Mpya ya Simu</label>
                                        <div class="form-field-with-icon">
                                            <i class="fas fa-phone"></i>
                                            <input type="text" class="form-control" id="new-mobile" placeholder="07XX XXX XXX" required>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label for="confirm-new-mobile" class="form-label">Rudia Nambari ya Simu</label>
                                        <div class="form-field-with-icon">
                                            <i class="fas fa-phone"></i>
                                            <input type="text" class="form-control" id="confirm-new-mobile" placeholder="Rudia nambari ya simu" required>
                                        </div>
                                    </div>
                                    <button type="submit" class="btn btn-primary w-100" id="reset-mobile-submit-btn">
                                        <i class="fas fa-check me-2"></i>
                                        <span class="btn-text">Weka Nambari Mpya</span>
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Password Verification Modal for Order Confirmation -->
            <div class="modal fade" id="passwordVerificationModal" tabindex="-1">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Thibitisha kwa Nenosiri</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body password-verification text-center">
                            <div class="profile-icon d-inline-flex align-items-center justify-content-center mb-3" style="width: 60px; height: 60px; font-size: 1.5rem; background: var(--success-color);">
                                <i class="fas fa-shield-alt"></i>
                            </div>
                            <p class="mb-3">Tafadhali ingiza nenosiri lako kuthibitisha agizo:</p>
                            <form id="password-verification-form">
                                <input type="hidden" id="verification-order-id">
                                <div class="mb-3">
                                    <label for="verification-password" class="form-label">Nenosiri lako</label>
                                    <div class="form-field-with-icon">
                                        <i class="fas fa-lock"></i>
                                        <input type="password" class="form-control form-control-lg" id="verification-password" placeholder="Ingiza nenosiri lako" required>
                                    </div>
                                </div>
                                <button type="submit" class="btn btn-primary w-100 btn-lg" id="password-verification-submit-btn">
                                    <i class="fas fa-check-circle me-2"></i>
                                    <span class="btn-text">Nimepokea</span>
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Message Modal with Professional Styling -->
            <div class="modal fade" id="messageModal" tabindex="-1">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Tuma Ujumbe</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="text-center mb-4">
                                <div class="profile-icon d-inline-flex align-items-center justify-content-center" style="width: 60px; height: 60px; font-size: 1.5rem; background: var(--accent-color);">
                                    <i class="fas fa-comment-alt"></i>
                                </div>
                                <h4 class="mt-3">Wasiliana Nasi</h4>
                                <p class="text-muted">Tuma ujumbe wako na tutakujibu kwa haraka</p>
                            </div>
                            <form id="message-form">
                                <div class="mb-3">
                                    <label for="message-content" class="form-label">Ujumbe Wako</label>
                                    <div class="form-field-with-icon">
                                        <i class="fas fa-edit"></i>
                                        <textarea class="form-control" id="message-content" rows="4" placeholder="Andika ujumbe wako hapa..." required></textarea>
                                    </div>
                                </div>
                                <button type="submit" class="btn btn-primary w-100 btn-lg" id="message-submit-btn">
                                    <i class="fas fa-paper-plane me-2"></i>
                                    <span class="btn-text">Tuma Ujumbe</span>
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Enhanced Order Success Modal -->
            <div class="modal fade" id="orderSuccessModal" tabindex="-1">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-body text-center py-5 order-success-animation">
                            <i class="fas fa-check-circle success-icon"></i>
                            <h3>Agizo Limefanikiwa!</h3>
                            <p class="mb-4">Ahsante kwa ununuzi wako. Tutawasiliana nawe kuhusu mshipisho.</p>
                            <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Endelea na Ununuzi</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Enhanced Rating Modal -->
            <div class="modal fade" id="ratingModal" tabindex="-1">
                <div class="modal-dialog modal-lg modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Tathmini Agizo</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="text-center mb-4">
                                <div class="profile-icon d-inline-flex align-items-center justify-content-center" style="width: 60px; height: 60px; font-size: 1.5rem; background: var(--warning-color);">
                                    <i class="fas fa-star"></i>
                                </div>
                                <h4 class="mt-3">Tathmini Uzoefu Wako</h4>
                                <p class="text-muted">Shiriki maoni yako na tusaidie kuboresha huduma zetu</p>
                            </div>
                            
                            <form id="rating-form">
                                <input type="hidden" id="rating-order-id">
                                
                                <div class="rating-section">
                                    <div class="rating-label">Tathmini ya Kifurushi</div>
                                    <div class="enhanced-rating">
                                        <div class="star-rating" id="package-rating">
                                            <span class="star" data-rating="1">â˜…</span>
                                            <span class="star" data-rating="2">â˜…</span>
                                            <span class="star" data-rating="3">â˜…</span>
                                            <span class="star" data-rating="4">â˜…</span>
                                            <span class="star" data-rating="5">â˜…</span>
                                        </div>
                                        <div class="rating-value" id="package-rating-value">0</div>
                                    </div>
                                    <div class="rating-comment" id="package-comment">Bonyeza nyota kuweka tathmini</div>
                                </div>
                                
                                <div class="rating-section">
                                    <div class="rating-label">Tathmini ya Usafirishaji</div>
                                    <div class="enhanced-rating">
                                        <div class="star-rating" id="delivery-rating">
                                            <span class="star" data-rating="1">â˜…</span>
                                            <span class="star" data-rating="2">â˜…</span>
                                            <span class="star" data-rating="3">â˜…</span>
                                            <span class="star" data-rating="4">â˜…</span>
                                            <span class="star" data-rating="5">â˜…</span>
                                        </div>
                                        <div class="rating-value" id="delivery-rating-value">0</div>
                                    </div>
                                    <div class="rating-comment" id="delivery-comment">Bonyeza nyota kuweka tathmini</div>
                                </div>
                                
                                <div class="rating-section">
                                    <div class="rating-label">Tathmini ya Bidhaa</div>
                                    <div class="enhanced-rating">
                                        <div class="star-rating" id="product-rating-stars">
                                            <span class="star" data-rating="1">â˜…</span>
                                            <span class="star" data-rating="2">â˜…</span>
                                            <span class="star" data-rating="3">â˜…</span>
                                            <span class="star" data-rating="4">â˜…</span>
                                            <span class="star" data-rating="5">â˜…</span>
                                        </div>
                                        <div class="rating-value" id="product-rating-value">0</div>
                                    </div>
                                    <div class="rating-comment" id="product-comment">Bonyeza nyota kuweka tathmini</div>
                                </div>
                                
                                <div class="mb-4">
                                    <label for="overall-comment" class="form-label">Maoni Yako (Hiari)</label>
                                    <div class="form-field-with-icon">
                                        <i class="fas fa-comment"></i>
                                        <textarea class="form-control" id="overall-comment" rows="3" placeholder="Andika maoni yako kuhusu agizo lako..."></textarea>
                                    </div>
                                </div>
                                
                                <button type="submit" class="btn btn-primary w-100 btn-lg" id="rating-submit-btn">
                                    <i class="fas fa-paper-plane me-2"></i>
                                    <span class="btn-text">Wasilisha Tathmini Yako</span>
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Enhanced Return Order Modal -->
            <div class="modal fade" id="returnOrderModal" tabindex="-1">
                <div class="modal-dialog modal-lg modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Omba Kurudisha Agizo</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="return-period-info">
                                <i class="fas fa-info-circle me-2"></i>
                                <strong>Muhimu:</strong> Unaweza kurudisha bidhaa ndani ya siku 3 baada ya kupokea agizo. Tafadhali hakikisha bidhaa ziko katika hali yake ya awali.
                            </div>
                            
                            <form id="return-order-form">
                                <input type="hidden" id="return-order-id">
                                
                                <div class="mb-4">
                                    <label class="form-label">Chagua Sababu ya Kurudisha</label>
                                    <div class="mb-2">
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="radio" name="return-reason-type" id="reason-size" value="Saizi haifai">
                                            <label class="form-check-label" for="reason-size">
                                                <i class="fas fa-ruler me-2"></i>Saizi haifai
                                            </label>
                                        </div>
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="radio" name="return-reason-type" id="reason-color" value="Rangi si sahihi">
                                            <label class="form-check-label" for="reason-color">
                                                <i class="fas fa-palette me-2"></i>Rangi si sahihi
                                            </label>
                                        </div>
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="radio" name="return-reason-type" id="reason-damaged" value="Bidhaa imeharibika">
                                            <label class="form-check-label" for="reason-damaged">
                                                <i class="fas fa-exclamation-triangle me-2"></i>Bidhaa imeharibika
                                            </label>
                                        </div>
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="radio" name="return-reason-type" id="reason-wrong" value="Bidhaa nyingine tofauti">
                                            <label class="form-check-label" for="reason-wrong">
                                                <i class="fas fa-exchange-alt me-2"></i>Bidhaa nyingine tofauti
                                            </label>
                                        </div>
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="radio" name="return-reason-type" id="reason-other" value="Nyingine">
                                            <label class="form-check-label" for="reason-other">
                                                <i class="fas fa-ellipsis-h me-2"></i>Nyingine
                                            </label>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="mb-4">
                                    <label for="return-reason-details" class="form-label">Maelezo Zaidi (Inahitajika)</label>
                                    <div class="form-field-with-icon">
                                        <i class="fas fa-edit"></i>
                                        <textarea class="form-control" id="return-reason-details" rows="3" placeholder="Eleza kwa undani kwa nini unataka kurudisha bidhaa hii..." required></textarea>
                                    </div>
                                </div>
                                
                                <div class="mb-4">
                                    <label class="form-label">Hali ya Bidhaa</label>
                                    <div>
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="checkbox" id="original-packaging">
                                            <label class="form-check-label" for="original-packaging">
                                                Bidhaa iko kwenye kifurushi chake asili
                                            </label>
                                        </div>
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="checkbox" id="tags-attached">
                                            <label class="form-check-label" for="tags-attached">
                                                Lebo na vitambulisho vimeachwa
                                            </label>
                                        </div>
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="checkbox" id="not-used">
                                            <label class="form-check-label" for="not-used">
                                                Bidhaa haijatumika
                                            </label>
                                        </div>
                                    </div>
                                </div>
                                
                                <button type="submit" class="btn btn-primary w-100 btn-lg" id="return-order-submit-btn">
                                    <i class="fas fa-undo me-2"></i>
                                    <span class="btn-text">Wasilisha Ombi la Kurudisha</span>
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Cancel Order Modal -->
            <div class="modal fade" id="cancelOrderModal" tabindex="-1">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Batilisha Agizo</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <form id="cancel-order-form">
                                <input type="hidden" id="cancel-order-id">
                                
                                <div class="mb-4">
                                    <label class="form-label">Chagua Sababu ya Kughairi</label>
                                    <div class="mb-2">
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="radio" name="cancel-reason-type" id="cancel-change-mind" value="Nimebadilisha nia">
                                            <label class="form-check-label" for="cancel-change-mind">
                                                Nimebadilisha nia
                                            </label>
                                        </div>
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="radio" name="cancel-reason-type" id="cancel-price" value="Bei sio sahihi">
                                            <label class="form-check-label" for="cancel-price">
                                                Bei sio sahihi
                                            </label>
                                        </div>
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="radio" name="cancel-reason-type" id="cancel-delivery" value="Muda wa usafirishaji mrefu">
                                            <label class="form-check-label" for="cancel-delivery">
                                                Muda wa usafirishaji mrefu
                                            </label>
                                        </div>
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="radio" name="cancel-reason-type" id="cancel-other" value="Nyingine">
                                            <label class="form-check-label" for="cancel-other">
                                                Nyingine
                                            </label>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="mb-4">
                                    <label for="cancel-reason-details" class="form-label">Maelezo Zaidi (Inahitajika)</label>
                                    <div class="form-field-with-icon">
                                        <i class="fas fa-edit"></i>
                                        <textarea class="form-control" id="cancel-reason-details" rows="3" placeholder="Tafadhali andika sababu ya kughairi agizo hili..." required></textarea>
                                    </div>
                                </div>
                                
                                <div class="alert alert-warning mb-4">
                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                    <strong>Angalishi:</strong> Agizo linaweza kughairiwa tu ikiwa bado halijaanza kusafirishwa.
                                </div>
                                
                                <button type="submit" class="btn btn-danger w-100 btn-lg" id="cancel-order-submit-btn">
                                    <i class="fas fa-times me-2"></i>
                                    <span class="btn-text">Thibitisha Kughairi Agizo</span>
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Order Details Modal - Update with Share Button -->
            <div class="modal fade" id="orderDetailsModal" tabindex="-1">
                <div class="modal-dialog modal-lg modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Maelezo ya Agizo #<span id="order-details-id"></span></h5>
                            <div class="d-flex align-items-center gap-2">
                                <!-- Share Button -->
                                <button class="btn btn-sm btn-outline-primary" id="share-order-btn" title="Shiriki agizo">
                                    <i class="fas fa-share-alt me-1"></i> Shiriki
                                </button>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                        </div>
                        <div class="modal-body">
                            <div class="order-items mb-4">
                                <div id="order-items-list">
                                    <!-- Order items will be loaded here -->
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <h6>Maelezo ya Agizo</h6>
                                    <p><strong>Jumla ya Bei:</strong> TZS <span id="order-details-total"></span></p>
                                    <p><strong>Hali:</strong> <span id="order-details-status"></span></p>
                                    <p><strong>Tarehe ya Agizo:</strong> <span id="order-details-date"></span></p>
                                </div>
                                <div class="col-md-6">
                                    <h6>Maelezo ya Mteja</h6>
                                    <p id="order-details-customer"></p>
                                    <p id="order-details-address"></p>
                                </div>
                            </div>
                            
                            <!-- Share Options (Initially Hidden) -->
                            <div id="share-options" class="mt-4 hidden">
                                <div class="card">
                                    <div class="card-header">
                                        <h6 class="mb-0">Shiriki Bidhaa</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="share-links" id="share-links">
                                            <!-- Share links will be generated here -->
                                        </div>
                                        <div class="input-group mt-3">
                                            <input type="text" class="form-control" id="share-link-input" readonly value="">
                                            <button class="btn btn-outline-primary" type="button" id="copy-link-btn">
                                                <i class="fas fa-copy me-1"></i> Nakili Kiungo
                                            </button>
                                        </div>
                                        <div id="copy-success" class="text-success small mt-2 hidden">
                                            <i class="fas fa-check me-1"></i> Kiungo kimenakiliwa!
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Product Share Modal -->
            <div class="modal fade" id="productShareModal" tabindex="-1">
                <div class="modal-dialog modal-dialog-centered modal-md">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Shiriki Bidhaa</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body share-modal-body">
                            <div class="share-platforms" id="product-share-platforms">
                                <!-- Share platforms will be loaded here -->
                            </div>
                            <div class="input-group mt-3">
                                <input type="text" class="form-control" id="product-share-link-input" readonly value="">
                                <button class="btn btn-outline-primary" type="button" id="copy-product-link-btn">
                                    <i class="fas fa-copy me-1"></i> Nakili Kiungo
                                </button>
                            </div>
                            <div id="product-copy-success" class="text-success small mt-2 hidden">
                                <i class="fas fa-check me-1"></i> Kiungo kimenakiliwa!
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <footer>
            <div class="container">
                <div class="row">
                    <div class="col-md-4 footer-content">
                        <h5>Four Brothers Sports Center</h5>
                        <p>Wauzaji na wasambazaji wa viatu bora vya michezo nchini Tanzania. Tunatoa huduma bora kwa wateja wetu kwa bei nafuu.</p>
                        <div class="social-links">
                            <a href="https://chat.whatsapp.com/I8qaaMkm8EU2V77eJBkZ8g" target="_blank">
                                <i class="fab fa-whatsapp"></i>
                            </a>
                            <a href="https://www.instagram.com/four_brothers_sports_center?igsh=d20xYno3dmlwcnJ4" target="_blank">
                                <i class="fab fa-instagram"></i>
                            </a>
                            <a href="mailto:fourbrothers10112627@gmail.com">
                                <i class="fas fa-envelope"></i>
                            </a>
                        </div>
                    </div>
                    <div class="col-md-4 footer-content">
                        <h5>Mawasiliano</h5>
                        <ul class="footer-links">
                            <li>
                                <a href="https://wa.me/255777730606" target="_blank">
                                    <i class="fab fa-whatsapp"></i>WhatsApp: +255 777 730 606
                                </a>
                            </li>
                            <li>
                                <a href="https://www.instagram.com/four_brothers_sports_center?igsh=d20xYno3dmlwcnJ4" target="_blank">
                                    <i class="fab fa-instagram"></i>Instagram: @four_brothers_sports_center
                                </a>
                            </li>
                            <li>
                                <a href="mailto:fourbrothers10112627@gmail.com">
                                    <i class="fas fa-envelope"></i>Email: fourbrothers10112627@gmail.com
                                </a>
                            </li>
                            <li>
                                <a href="#" data-bs-toggle="modal" data-bs-target="#messageModal">
                                    <i class="fas fa-comment"></i>Tuma Ujumbe Ndani ya Programu
                                </a>
                            </li>
                        </ul>
                    </div>
                    <div class="col-md-4 footer-content">
                        <h5>Huduma</h5>
                        <ul class="footer-links">
                            <li><a href="#" data-section="home"><i class="fas fa-home"></i>Nyumbani</a></li>
                            <li><a href="#" data-section="cart"><i class="fas fa-shopping-cart"></i>Karatasi</a></li>
                            <li><a href="#" data-section="account"><i class="fas fa-user"></i>Akaunti Yangu</a></li>
                            <li><a href="#" data-bs-toggle="modal" data-bs-target="#loginModal"><i class="fas fa-sign-in-alt"></i>Ingia</a></li>
                        </ul>
                    </div>
                </div>
                <div class="footer-bottom">
                    <p>&copy; 2025 Four Brothers Sports Center. Haki zote zimehifadhiwa.</p>
                </div>
            </div>
        </footer>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
    // API Base URL - Update this to match your backend
    const API_BASE_URL = 'https://api.fourbrothers.online/api/customers';

    // Global variables
    let products = [];
    let ads = [];
    let announcement = null;
    let currentUser = null;
    let cart = [];
    let orders = [];
    let currentTheme = 'light';
    let authToken = localStorage.getItem('authToken');
    let refreshToken = localStorage.getItem('refreshToken');
    let savedAddresses = [];
    let isFirstOrder = true;
    let selectedAddress = null;
    let customerMessages = [];
    let productRatings = [];
    let resetToken = null;
    let registrationFormData = JSON.parse(localStorage.getItem('registrationFormData')) || {};
    let loadingProgress = 0;
    let loadingInterval;

    // DOM Elements
    const loadingScreen = document.getElementById('loading-screen');
    const loadingProducts = document.getElementById('loading-products');
    const loadingUsers = document.getElementById('loading-users');
    const loadingOrders = document.getElementById('loading-orders');
    const loadingError = document.getElementById('loading-error');
    const loadingSuccess = document.getElementById('loading-success');
    const retryLoadingBtn = document.getElementById('retry-loading');
    const appContent = document.getElementById('app-content');
    const homeSection = document.getElementById('home-section');
    const productDetailSection = document.getElementById('product-detail-section');
    const cartSection = document.getElementById('cart-section');
    const checkoutSection = document.getElementById('checkout-section');
    const accountSection = document.getElementById('account-section');
    const authSection = document.getElementById('auth-section');
    const productsGrid = document.getElementById('products-grid');
    const loginModal = new bootstrap.Modal(document.getElementById('loginModal'));
    const registerModal = new bootstrap.Modal(document.getElementById('registerModal'));
    const forgotPasswordModal = new bootstrap.Modal(document.getElementById('forgotPasswordModal'));
    const passwordVerificationModal = new bootstrap.Modal(document.getElementById('passwordVerificationModal'));
    const orderSuccessModal = new bootstrap.Modal(document.getElementById('orderSuccessModal'));
    const ratingModal = new bootstrap.Modal(document.getElementById('ratingModal'));
    const returnOrderModal = new bootstrap.Modal(document.getElementById('returnOrderModal'));
    const cancelOrderModal = new bootstrap.Modal(document.getElementById('cancelOrderModal'));
    const orderDetailsModal = new bootstrap.Modal(document.getElementById('orderDetailsModal'));
    const messageModal = new bootstrap.Modal(document.getElementById('messageModal'));
    const productShareModal = new bootstrap.Modal(document.getElementById('productShareModal'));
    const themeToggle = document.getElementById('theme-toggle');
    const mobileThemeToggle = document.getElementById('mobile-theme-toggle');
    const mobileThemeSwitch = document.getElementById('mobile-theme-switch');
    const searchInput = document.getElementById('search-input');
    const searchResults = document.getElementById('search-results');
    const confirmOrderBtn = document.getElementById('confirm-order');
    const shareProductDetailBtn = document.getElementById('share-product-detail-btn');
    
    // Initialize the application with loading screen
    document.addEventListener('DOMContentLoaded', function() {
        console.log('Initializing application with loading screen...');
        
        // Start loading animation
        startLoadingAnimation();
        
        // Check if coming from terms page
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('from') === 'terms') {
            // Save this to show registration modal later
            window.fromTermsPage = true;
            
            // Clear the parameter from URL without refreshing
            window.history.replaceState({}, document.title, window.location.pathname);
        }
        
        // Check for share redirect FIRST - before loading app
        handleShareRedirect();
        
        // Start loading data
        initializeApp();
    });

    // Handle share redirect - FIXED to show product directly
    function handleShareRedirect() {
        const urlParams = new URLSearchParams(window.location.search);
        const productId = urlParams.get('product');
        const isShare = urlParams.get('share');
        
        if (productId && isShare === 'true') {
            console.log('Share redirect detected for product:', productId);
            
            // Clear the parameters from URL immediately
            window.history.replaceState({}, document.title, window.location.pathname);
            
            // Store the product ID to show after app loads
            window.sharedProductId = parseInt(productId);
            
            // Show a notification after app loads
            setTimeout(() => {
                if (window.sharedProductId) {
                    const product = products.find(p => p.id == window.sharedProductId);
                    if (product) {
                        showProductDetail(window.sharedProductId);
                        
                        // Show notification after a short delay
                        setTimeout(() => {
                            alert('Bidhaa hii ilishirikiwa na mteja mwingine. Angalia maelezo yake hapa chini.');
                        }, 500);
                    }
                    // Clear the stored product ID
                    window.sharedProductId = null;
                }
            }, 2000);
        }
    }

    // Start loading animation
    function startLoadingAnimation() {
        loadingProgress = 0;
        
        // Animate loading stats
        loadingInterval = setInterval(() => {
            if (loadingProgress < 95) {
                loadingProgress += 5;
                
                // Update stats with random but realistic numbers
                if (loadingProgress < 30) {
                    loadingProducts.textContent = Math.floor(Math.random() * 5);
                } else if (loadingProgress < 60) {
                    loadingProducts.textContent = Math.floor(Math.random() * 20);
                    loadingUsers.textContent = Math.floor(Math.random() * 10);
                } else {
                    loadingProducts.textContent = Math.floor(Math.random() * 50);
                    loadingUsers.textContent = Math.floor(Math.random() * 25);
                    loadingOrders.textContent = Math.floor(Math.random() * 15);
                }
            }
        }, 200);
    }

    // Stop loading animation
    function stopLoadingAnimation() {
        clearInterval(loadingInterval);
        
        // Set final stats
        setTimeout(() => {
            loadingProducts.textContent = products.length;
            loadingUsers.textContent = currentUser ? 1 : 0;
            loadingOrders.textContent = orders.length;
            loadingProgress = 100;
        }, 500);
    }

    // Initialize the application
    async function initializeApp() {
        try {
            // Check theme first
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme) {
                currentTheme = savedTheme;
                applyTheme(currentTheme);
            }
            
            // Update mobile theme switch state
            if (mobileThemeSwitch) {
                mobileThemeSwitch.checked = currentTheme === 'dark';
            }
            
            // Update progress
            updateLoadingProgress(10);
            
            // Check authentication status
            await checkAuthStatus();
            updateLoadingProgress(30);
            
            // Load initial data
            await loadInitialData();
            updateLoadingProgress(70);
            
            // Setup event listeners
            setupEventListeners();
            updateLoadingProgress(90);
            
            // Show app content
            setTimeout(() => {
                showAppContent();
                
                // Show registration modal if coming from terms page
                if (window.fromTermsPage) {
                    setTimeout(() => {
                        loadRegistrationFormData();
                        registerModal.show();
                        window.fromTermsPage = false;
                    }, 1000);
                }
                
                // Show shared product if exists
                if (window.sharedProductId) {
                    const product = products.find(p => p.id == window.sharedProductId);
                    if (product) {
                        showProductDetail(window.sharedProductId);
                        
                        // Show notification after a short delay
                        setTimeout(() => {
                            alert('Bidhaa hii ilishirikiwa na mteja mwingine. Angalia maelezo yake hapa chini.');
                        }, 500);
                    }
                    window.sharedProductId = null;
                }
            }, 1000);
            
        } catch (error) {
            console.error('Initialization error:', error);
            showLoadingError();
        }
    }

    // Update loading progress
    function updateLoadingProgress(progress) {
        loadingProgress = progress;
    }

    // Show app content
    function showAppContent() {
        stopLoadingAnimation();
        
        // Show success message
        loadingSuccess.style.display = 'block';
        
        // Hide loading screen and show app content after delay
        setTimeout(() => {
            loadingScreen.style.opacity = '0';
            loadingScreen.style.visibility = 'hidden';
            
            appContent.style.opacity = '1';
            
            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }, 1500);
    }

    // Show loading error
    function showLoadingError() {
        stopLoadingAnimation();
        loadingError.style.display = 'block';
        
        // Set retry button event
        retryLoadingBtn.onclick = function() {
            loadingError.style.display = 'none';
            startLoadingAnimation();
            initializeApp();
        };
        
        // Show app with sample data after timeout
        setTimeout(() => {
            showAppContent();
        }, 3000);
    }

    // Save registration form data
    function saveRegistrationFormData() {
        registrationFormData = {
            firstName: document.getElementById('reg-first-name')?.value || '',
            lastName: document.getElementById('reg-last-name')?.value || '',
            mobile: document.getElementById('reg-mobile')?.value || '',
            email: document.getElementById('reg-email')?.value || '',
            address: document.getElementById('reg-address')?.value || '',
            gender: document.querySelector('input[name="reg-gender"]:checked')?.value || ''
        };
        localStorage.setItem('registrationFormData', JSON.stringify(registrationFormData));
    }

    // Load registration form data
    function loadRegistrationFormData() {
        if (Object.keys(registrationFormData).length > 0) {
            document.getElementById('reg-first-name').value = registrationFormData.firstName || '';
            document.getElementById('reg-last-name').value = registrationFormData.lastName || '';
            document.getElementById('reg-mobile').value = registrationFormData.mobile || '';
            document.getElementById('reg-email').value = registrationFormData.email || '';
            document.getElementById('reg-address').value = registrationFormData.address || '';
            
            if (registrationFormData.gender) {
                document.querySelector(`input[name="reg-gender"][value="${registrationFormData.gender}"]`).checked = true;
            }
        }
    }

    // Clear registration form data
    function clearRegistrationFormData() {
        registrationFormData = {};
        localStorage.removeItem('registrationFormData');
    }

    // Check authentication status
    async function checkAuthStatus() {
        if (authToken) {
            try {
                console.log('Checking auth status with token:', authToken);
                const response = await fetch(`${API_BASE_URL}/me`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    currentUser = data.customer;
                    console.log('User authenticated:', currentUser);
                    updateAuthSection();
                    await loadUserData();
                    
                    // Check if user has previous orders
                    if (orders.length > 0) {
                        isFirstOrder = false;
                    }
                    
                    // Load saved addresses from user profile
                    loadSavedAddresses();
                    
                } else {
                    console.log('Token invalid, trying refresh...');
                    await refreshAuthToken();
                }
            } catch (error) {
                console.error('Auth check failed:', error);
            }
        } else {
            console.log('No auth token found');
        }
    }

    // Load saved addresses from user profile
    function loadSavedAddresses() {
        if (!currentUser) return;
        
        // Initialize with user's main address
        if (currentUser.address) {
            savedAddresses = [currentUser.address];
        } else {
            savedAddresses = [];
        }
        
        // Load additional addresses from localStorage
        const additionalAddresses = JSON.parse(localStorage.getItem(`userAddresses_${currentUser.id}`)) || [];
        savedAddresses = [...savedAddresses, ...additionalAddresses];
        
        console.log('Loaded addresses:', savedAddresses);
    }

    // Save addresses to localStorage
    function saveAddresses() {
        if (!currentUser) return;
        
        // Separate main address and additional addresses
        const mainAddress = currentUser.address;
        const additionalAddresses = savedAddresses.filter(addr => addr !== mainAddress);
        
        // Save additional addresses to localStorage
        localStorage.setItem(`userAddresses_${currentUser.id}`, JSON.stringify(additionalAddresses));
    }

    // Refresh auth token
    async function refreshAuthToken() {
        if (!refreshToken) {
            console.log('No refresh token available');
            logout();
            return;
        }
        
        try {
            const response = await fetch(`${API_BASE_URL}/refresh-token`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ refreshToken: refreshToken })
            });
            
            if (response.ok) {
                const data = await response.json();
                authToken = data.accessToken;
                localStorage.setItem('authToken', authToken);
                console.log('Token refreshed successfully');
                await checkAuthStatus();
            } else {
                console.log('Refresh failed, logging out');
                logout();
            }
        } catch (error) {
            console.error('Token refresh failed:', error);
            logout();
        }
    }

    // Logout function
    function logout() {
        console.log('Logging out user');
        currentUser = null;
        authToken = null;
        refreshToken = null;
        isFirstOrder = true;
        selectedAddress = null;
        resetToken = null;
        localStorage.removeItem('authToken');
        localStorage.removeItem('refreshToken');
        updateAuthSection();
        showSection('home');
        // Clear any user-specific data
        cart = [];
        orders = [];
        savedAddresses = [];
        customerMessages = [];
        alert('Umefanikiwa kutoka!');
    }

    // Load initial data
    async function loadInitialData() {
        console.log('Loading initial data...');
        await loadProducts();
        await loadAds();
        await loadAnnouncement();
        renderProducts();
    }

    // Load products from API
    async function loadProducts() {
        try {
            console.log('Loading products from API...');
            const response = await fetch(`${API_BASE_URL}/products`);
            
            if (response.ok) {
                products = await response.json();
                console.log('Products loaded:', products.length);
                console.log('First product:', products[0]);
                
                // Process product data to match frontend structure
                products = products.map(product => {
                    // Extract size information from the response
                    const sizes = product.sizes || [];
                    
                    // Calculate total stock from all sizes
                    const total_stock = sizes.reduce((sum, size) => sum + (size.stock || 0), 0);
                    
                    // Get the first image if available
                    const images = product.images || [];
                    
                    // Calculate final price with discount
                    const discount_percent = product.discount_percent || 0;
                    const price = product.price || 0;
                    const final_price = discount_percent > 0 ? 
                        price * (1 - discount_percent / 100) : price;
                    
                    return {
                        id: product.id,
                        name: product.name || 'Bidhaa Bila Jina',
                        company: product.company || 'Hakuna Chapa',
                        color: product.color || 'Hakuna Rangi',
                        type: product.type || 'Hakuna Aina',
                        price: price,
                        discount_percent: discount_percent,
                        final_price: final_price,
                        total_stock: total_stock,
                        sizes: sizes,
                        images: images,
                        description: product.description || '',
                        created_at: product.created_at
                    };
                });
                
                console.log('Processed products:', products);
                
                // Load product ratings
                await loadProductRatings();
                renderProducts();
            } else {
                console.error('Failed to load products, status:', response.status, response.statusText);
                const errorText = await response.text();
                console.error('Error response:', errorText);
                // Use fallback sample data
                products = getSampleProducts();
                renderProducts();
            }
        } catch (error) {
            console.error('Error loading products:', error);
            products = getSampleProducts();
            renderProducts();
        }
    }

    // Load product ratings
    async function loadProductRatings() {
        try {
            console.log('Loading product ratings from API...');
            
            const headers = {};
            if (authToken) {
                headers['Authorization'] = `Bearer ${authToken}`;
            }
            
            const response = await fetch(`${API_BASE_URL}/ratings`, {
                headers: headers
            });
            
            if (response.ok) {
                const data = await response.json();
                productRatings = data.ratings || [];
                console.log('Product ratings loaded:', productRatings.length);
                
                // Fix: Ensure ratings are properly parsed as numbers
                productRatings.forEach(rating => {
                    rating.avg_rating = parseFloat(rating.avg_rating) || 0;
                    rating.total_ratings = parseInt(rating.total_ratings) || 0;
                });
                
            } else if (response.status === 401) {
                console.log('Product ratings require authentication, using default ratings');
                productRatings = [];
            } else {
                console.error('Failed to load product ratings, status:', response.status);
                productRatings = [];
            }
        } catch (error) {
            console.error('Error loading product ratings:', error);
            productRatings = [];
        }
    }

    // Load ads from API
    async function loadAds() {
        try {
            console.log('Loading ads from API...');
            const response = await fetch(`${API_BASE_URL}/ads`);
            
            if (response.ok) {
                const data = await response.json();
                ads = data.ads || [];
                console.log('Ads loaded:', ads.length);
                
                // Fix ad image URLs - Cloudinary URLs are already absolute
                ads.forEach(ad => {
                    if (ad.image_url && !ad.image_url.startsWith('http') && !ad.image_url.startsWith('https')) {
                        ad.image_url = `https://api.fourbrothers.online${ad.image_url}`;
                    }
                });
                renderAds();
            } else {
                console.error('Failed to load ads, status:', response.status);
            }
        } catch (error) {
            console.error('Error loading ads:', error);
        }
    }

    // Load announcement from API
    async function loadAnnouncement() {
        try {
            console.log('Loading announcement from API...');
            const headers = {};
            if (authToken) {
                headers['Authorization'] = `Bearer ${authToken}`;
            }
            
            const response = await fetch(`${API_BASE_URL}/announcements`, {
                headers: headers
            });
            
            if (response.ok) {
                const data = await response.json();
                announcement = data.announcement;
                console.log('Announcement loaded:', announcement);
                renderAnnouncement();
            } else {
                console.error('Failed to load announcement, status:', response.status);
            }
        } catch (error) {
            console.error('Error loading announcement:', error);
        }
    }

    // Load user data
    async function loadUserData() {
        if (!currentUser) {
            console.log('No user logged in, skipping user data load');
            return;
        }
        
        try {
            console.log('Loading user data...');
            
            // Load orders
            const ordersResponse = await fetch(`${API_BASE_URL}/orders`, {
                headers: {
                    'Authorization': `Bearer ${authToken}`
                }
            });
            
            if (ordersResponse.ok) {
                const data = await ordersResponse.json();
                orders = data.orders || [];
                console.log('Orders loaded from API:', orders);
                
                // Check if this is user's first order
                if (orders.length > 0) {
                    isFirstOrder = false;
                }
            } else {
                console.error('Failed to load orders, status:', ordersResponse.status);
            }
            
        } catch (error) {
            console.error('Error loading user data:', error);
        }
    }

    // Apply theme
    function applyTheme(theme) {
        document.documentElement.setAttribute('data-theme', theme);
        const icon = themeToggle?.querySelector('i');
        const mobileIcon = mobileThemeToggle?.querySelector('i');
        
        if (theme === 'dark') {
            if (icon) {
                icon.classList.remove('fa-moon');
                icon.classList.add('fa-sun');
            }
            if (mobileIcon) {
                mobileIcon.classList.remove('fa-moon');
                mobileIcon.classList.add('fa-sun');
            }
        } else {
            if (icon) {
                icon.classList.remove('fa-sun');
                icon.classList.add('fa-moon');
            }
            if (mobileIcon) {
                mobileIcon.classList.remove('fa-sun');
                mobileIcon.classList.add('fa-moon');
            }
        }
        
        // Update mobile theme switch
        if (mobileThemeSwitch) {
            mobileThemeSwitch.checked = theme === 'dark';
        }
        
        localStorage.setItem('theme', theme);
    }

    // Toggle theme
    function toggleTheme() {
        currentTheme = currentTheme === 'light' ? 'dark' : 'light';
        applyTheme(currentTheme);
    }

    // Render ads
    function renderAds() {
        const carouselInner = document.querySelector('#adsCarousel .carousel-inner');
        carouselInner.innerHTML = '';
        
        if (ads.length === 0) {
            // Default ad if no ads available
            carouselInner.innerHTML = `
                <div class="carousel-item active h-100">
                    <div class="d-block w-100 h-100 bg-primary d-flex align-items-center justify-content-center text-white">
                        Hakuna Tangazo kwa sasa
                    </div>
                </div>
            `;
            return;
        }
        
        ads.forEach((ad, index) => {
            const item = document.createElement('div');
            item.className = `carousel-item ${index === 0 ? 'active' : ''} h-100`;
            item.innerHTML = `
                <img src="${ad.image_url}" class="d-block w-100 h-100" style="object-fit: cover;" alt="Ad">
                ${ad.link ? `<a href="${ad.link}" target="_blank" class="stretched-link"></a>` : ''}
            `;
            carouselInner.appendChild(item);
        });
    }

    // Render announcement
    function renderAnnouncement() {
        const announcementContainer = document.getElementById('announcements-container');
        const announcementText = document.getElementById('announcement-text');
        
        if (announcement) {
            announcementText.textContent = announcement.message;
            announcementContainer.style.display = 'block';
            
            // Stop marquee after 30 seconds and show static text
            setTimeout(() => {
                const marquee = document.getElementById('announcement-text');
                const staticText = document.createElement('span');
                staticText.textContent = announcement.message;
                staticText.id = 'announcement-static';
                
                marquee.parentNode.replaceChild(staticText, marquee);
            }, 30000);
        } else {
            announcementContainer.style.display = 'none';
        }
    }

    // Render products on the home page
    function renderProducts(filteredProducts = null) {
        const productsToRender = filteredProducts || products;
        productsGrid.innerHTML = '';
        
        if (productsToRender.length === 0) {
            productsGrid.innerHTML = '<p class="text-center py-5">Hakuna bidhaa zilizopatikana kwa sasa.</p>';
            return;
        }
        
        productsToRender.forEach(product => {
            // Check if product has any stock (sum of all sizes)
            const totalStock = product.sizes ? 
                product.sizes.reduce((sum, size) => sum + (size.stock || 0), 0) : 0;
            const hasStock = totalStock > 0;
            const productCard = document.createElement('div');
            productCard.className = `col-md-6 col-lg-3 mb-4 ${!hasStock ? 'out-of-stock' : ''}`;
            
            // Get product rating
            const productRating = getProductRating(product.id);
            const ratingStars = generateStarRating(productRating.avg_rating);
            
            // Determine stock badge
            let stockBadge = '';
            if (!hasStock) {
                stockBadge = '<span class="product-availability out-of-stock-badge">Hakuna Akiba</span>';
            } else if (totalStock <= 5) {
                stockBadge = `<span class="product-availability low-stock">Akiba kidogo (${totalStock})</span>`;
            } else {
                stockBadge = `<span class="product-availability in-stock">Akiba (${totalStock})</span>`;
            }
            
            // Get the first image
            const productImage = product.images && product.images.length > 0 ? 
                product.images[0] : 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjMwMCIgdmlld0JveD0iMCAwIDMwMCAzMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHJlY3Qgd2lkdGg9IjMwMCIgaGVpZ2h0PSIzMDAiIGZpbGw9IiNFNUU1RTUiLz48dGV4dCB4PSI1MCUiIHk9IjUwJSIgZG9taW5hbnQtYmFzZWxpbmU9Im1pZGRsZSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZm9udC1mYW1pbHk9IkFyaWFsIiBZhb250LXNpemU9IjE0IiBmaWxsPSIjOTk5Ij5CaWRoYWE8L3RleHQ+PC9zdmc+';
            
            productCard.innerHTML = `
                <div class="card product-card h-100" data-product-id="${product.id}">
                    ${product.discount_percent > 0 ? `<div class="offer-badge discount-pulse">${product.discount_percent}% OFF</div>` : ''}
                    <img src="${productImage}" 
                        class="card-img-top product-img" alt="${product.name}"
                        onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjMwMCIgdmlld0JveD0iMCAwIDMwMCAzMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHJlY3Qgd2lkdGg9IjMwMCIgaGVpZ2h0PSIzMDAiIGZpbGw9IiNFNUU1RTUiLz48dGV4dCB4PSI1MCUiIHk9IjUwJSIgZG9taW5hbnQtYmFzZWxpbmU9Im1pZGRsZSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjE0IiBmaWxsPSIjOTk5Ij5CaWRoYWE8L3RleHQ+PC9zdmc+'">
                    <div class="card-body d-flex flex-column">
                        <h6 class="card-title">${product.name}</h6>
                        <div class="mb-2">
                            <small class="text-muted">${product.company} â€¢ ${product.color}</small>
                            <span class="product-type-badge">${product.type}</span>
                        </div>
                        <div class="mb-2">
                            <div class="product-rating-display">
                                <div class="stars">${ratingStars}</div>
                                <div class="rating-text">(${productRating.total_ratings || 0} tathmini)</div>
                            </div>
                        </div>
                        <div class="mt-auto">
                            <div class="d-flex align-items-center justify-content-between">
                                <div>
                                    ${product.discount_percent > 0 ? 
                                        `<span class="price-old">TZS ${formatPrice(product.price)}</span>` : 
                                        ''
                                    }
                                    <span class="price-new">TZS ${formatPrice(product.final_price)}</span>
                                </div>
                                ${hasStock ? `
                                <button class="btn btn-sm btn-outline-primary add-to-cart-btn">
                                    <i class="fas fa-cart-plus"></i>
                                </button>
                                ` : ''}
                            </div>
                            ${stockBadge}
                        </div>
                    </div>
                </div>
            `;
            productsGrid.appendChild(productCard);
        });

        // Add event listeners for product cards
        document.querySelectorAll('.product-card').forEach(card => {
            card.addEventListener('click', function(e) {
                if (!e.target.classList.contains('add-to-cart-btn') && !e.target.closest('.add-to-cart-btn')) {
                    const productId = parseInt(this.getAttribute('data-product-id'));
                    showProductDetail(productId);
                }
            });
        });

        // Add event listeners for add to cart buttons
        document.querySelectorAll('.add-to-cart-btn').forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.stopPropagation();
                const productCard = this.closest('.product-card');
                const productId = parseInt(productCard.getAttribute('data-product-id'));
                const product = products.find(p => p.id === productId);
                
                if (product) {
                    if (!currentUser) {
                        loginModal.show();
                        return;
                    }
                    
                    // Calculate total stock from sizes
                    const totalStock = product.sizes ? 
                        product.sizes.reduce((sum, size) => sum + (size.stock || 0), 0) : 0;
                        
                    if (totalStock <= 0) {
                        alert('Samahani, bidhaa hii hana akiba kwa sasa.');
                        return;
                    }
                    
                    // Get the first available size
                    let defaultSize = '';
                    if (product.sizes && product.sizes.length > 0) {
                        const availableSize = product.sizes.find(s => (s.stock || 0) > 0);
                        if (availableSize) {
                            defaultSize = cleanSizeCode(availableSize.code || availableSize.size_label);
                        } else {
                            // If no stock, use first size
                            defaultSize = cleanSizeCode(product.sizes[0].code || product.sizes[0].size_label);
                        }
                    } else {
                        defaultSize = 'M';
                    }
                    
                    addToCart(product, 1, defaultSize);
                }
            });
        });
    }

    // Helper function for cleaning size codes
    function cleanSizeCode(size) {
        if (!size) return '';
        
        // Convert to string and clean
        const sizeStr = size.toString();
        
        // Remove "EU", "eu", extra spaces, and any non-numeric characters except dash
        let clean = sizeStr
            .replace(/EU/gi, '')
            .replace(/saizi/gi, '')
            .replace(/size/gi, '')
            .replace(/\s+/g, ' ')
            .trim();
        
        // Extract the main size number (e.g., "39" from "39 10")
        const match = clean.match(/(\d+)/);
        if (match) {
            clean = match[1];
        }
        
        return clean;
    }

    // Get product rating
    function getProductRating(productId) {
        if (!productRatings || productRatings.length === 0) {
            return { avg_rating: 0, total_ratings: 0 };
        }
        
        const rating = productRatings.find(r => r.product_id == productId);
        
        if (!rating) {
            return { avg_rating: 0, total_ratings: 0 };
        }
        
        // Return the already parsed values
        return { 
            avg_rating: rating.avg_rating || 0, 
            total_ratings: rating.total_ratings || 0 
        };
    }

    // Generate star rating HTML
    function generateStarRating(rating) {
        const fullStars = Math.floor(rating);
        const halfStar = rating % 1 >= 0.5;
        const emptyStars = 5 - fullStars - (halfStar ? 1 : 0);
        
        let starsHTML = '';
        
        // Full stars
        for (let i = 0; i < fullStars; i++) {
            starsHTML += '<i class="fas fa-star"></i>';
        }
        
        // Half star
        if (halfStar) {
            starsHTML += '<i class="fas fa-star-half-alt"></i>';
        }
        
        // Empty stars
        for (let i = 0; i < emptyStars; i++) {
            starsHTML += '<i class="far fa-star"></i>';
        }
        
        return starsHTML;
    }

    // Format price with commas
    function formatPrice(price) {
        return new Intl.NumberFormat('en-TZ').format(price);
    }

    // Update authentication section based on login status
    function updateAuthSection() {
        if (currentUser) {
            const initials = (currentUser.first_name.charAt(0) + currentUser.last_name.charAt(0)).toUpperCase();
            authSection.innerHTML = `
                <div class="profile-icon" title="${currentUser.first_name} ${currentUser.last_name}">${initials}</div>
            `;
        } else {
            authSection.innerHTML = `
                <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#loginModal">Ingia</button>
            `;
        }
    }

    // Enhanced setupEventListeners function with theme control for mobile
    function setupEventListeners() {
        // Theme toggle for desktop
        if (themeToggle) {
            themeToggle.addEventListener('click', toggleTheme);
        }
        
        // Theme toggle for mobile button
        if (mobileThemeToggle) {
            mobileThemeToggle.addEventListener('click', toggleTheme);
        }
        
        // Theme switch for mobile in account menu
        if (mobileThemeSwitch) {
            mobileThemeSwitch.addEventListener('change', function() {
                toggleTheme();
            });
        }
        
        // Navigation
        document.querySelectorAll('[data-section]').forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                const section = this.getAttribute('data-section');
                showSection(section);
            });
        });

        // Mobile navigation
        document.querySelectorAll('.mobile-nav-item').forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                const section = this.getAttribute('data-section');
                
                // Update active state
                document.querySelectorAll('.mobile-nav-item').forEach(item => {
                    item.classList.remove('active');
                });
                this.classList.add('active');
                
                showSection(section);
            });
        });

        // Back to products
        document.getElementById('back-to-products').addEventListener('click', function() {
            showSection('home');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        });

        // Add to cart from product detail
        document.getElementById('add-to-cart').addEventListener('click', function() {
            if (!currentUser) {
                loginModal.show();
                return;
            }
            
            const productId = parseInt(productDetailSection.getAttribute('data-product-id'));
            const product = products.find(p => p.id === productId);
            const quantity = parseInt(document.getElementById('quantity').textContent);
            const selectedSizeElement = document.querySelector('.size-option.active');
            
            if (!product) {
                alert('Bidhaa haijapatikana.');
                return;
            }
            
            if (product.total_stock <= 0) {
                alert('Samahani, bidhaa hii hana akiba kwa sasa.');
                return;
            }
            
            // Check if selected size has stock
            if (selectedSizeElement) {
                const selectedSize = selectedSizeElement.querySelector('.size-label').textContent;
                const sizeStock = getSizeStock(product, selectedSize);
                
                if (quantity > sizeStock) {
                    alert(`Samahani, kuna akiba ya ${sizeStock} tu kwa saizi ${selectedSize}. Tafadhali punguza idadi.`);
                    return;
                }
                
                addToCart(product, quantity, selectedSize);
                showSection('cart');
            } else {
                alert('Tafadhali chagua saizi ya bidhaa.');
            }
        });

        // Quantity controls
        document.getElementById('increase-qty').addEventListener('click', function() {
            const quantityElement = document.getElementById('quantity');
            let quantity = parseInt(quantityElement.textContent);
            const productId = parseInt(productDetailSection.getAttribute('data-product-id'));
            const product = products.find(p => p.id === productId);
            const selectedSizeElement = document.querySelector('.size-option.active');
            
            if (product && selectedSizeElement) {
                const selectedSize = selectedSizeElement.querySelector('.size-label').textContent;
                const sizeStock = getSizeStock(product, selectedSize);
                
                if (quantity < sizeStock) {
                    quantityElement.textContent = quantity + 1;
                } else {
                    alert(`Samahani, kuna akiba ya ${sizeStock} tu kwa saizi ${selectedSize}.`);
                }
            }
        });

        document.getElementById('decrease-qty').addEventListener('click', function() {
            const quantityElement = document.getElementById('quantity');
            let quantity = parseInt(quantityElement.textContent);
            if (quantity > 1) {
                quantityElement.textContent = quantity - 1;
            }
        });

        // Proceed to checkout
        document.getElementById('proceed-to-checkout').addEventListener('click', function() {
            if (!currentUser) {
                loginModal.show();
                return;
            }
            
            if (cart.length === 0) {
                alert('Karatasi yako ni tupu. Ongeza bidhaa kwanza.');
                return;
            }
            
            showSection('checkout');
            updateAddressSelection();
            // Scroll to top of checkout section
            setTimeout(() => {
                checkoutSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 100);
        });

        // Account menu tabs
        document.querySelectorAll('.account-menu li').forEach(tab => {
            tab.addEventListener('click', function() {
                // Handle logout separately
                if (this.id === 'logout-btn') {
                    logout();
                    return;
                }
                
                // Handle theme control separately
                if (this.id === 'mobile-theme-control') {
                    return;
                }
                
                const tabName = this.getAttribute('data-account-tab');
                if (!tabName) return;
                
                document.querySelectorAll('.account-menu li').forEach(t => {
                    if (t.id !== 'mobile-theme-control') {
                        t.classList.remove('active');
                    }
                });
                this.classList.add('active');
                
                document.getElementById('account-orders').classList.add('hidden');
                document.getElementById('account-contact').classList.add('hidden');
                document.getElementById('account-addresses').classList.add('hidden');
                document.getElementById('account-profile').classList.add('hidden');
                
                document.getElementById(`account-${tabName}`).classList.remove('hidden');
                
                if (tabName === 'orders') {
                    updateOrdersDisplay();
                } else if (tabName === 'addresses') {
                    updateAddressesDisplay();
                } else if (tabName === 'profile') {
                    loadProfileData();
                }
            });
        });

        // Search functionality
        searchInput.addEventListener('input', function() {
            const searchTerm = this.value.trim().toLowerCase();
            if (searchTerm.length > 0) {
                const filteredProducts = products.filter(product => 
                    product.name.toLowerCase().includes(searchTerm) ||
                    (product.company && product.company.toLowerCase().includes(searchTerm)) ||
                    (product.color && product.color.toLowerCase().includes(searchTerm)) ||
                    (product.type && product.type.toLowerCase().includes(searchTerm))
                );
                showSearchResults(filteredProducts, searchTerm);
            } else {
                hideSearchResults();
            }
        });

        // Hide search results when clicking outside
        document.addEventListener('click', function(e) {
            if (!searchInput.contains(e.target) && !searchResults.contains(e.target)) {
                hideSearchResults();
            }
        });

        // Login/Register modals
        document.getElementById('show-register').addEventListener('click', function(e) {
            e.preventDefault();
            loginModal.hide();
            loadRegistrationFormData(); // Load saved data
            registerModal.show();
        });

        document.getElementById('show-login').addEventListener('click', function(e) {
            e.preventDefault();
            registerModal.hide();
            loginModal.show();
        });

        // Forgot password links
        document.getElementById('forgot-password-login').addEventListener('click', function(e) {
            e.preventDefault();
            loginModal.hide();
            forgotPasswordModal.show();
        });

        document.getElementById('forgot-password-checkout').addEventListener('click', function(e) {
            e.preventDefault();
            forgotPasswordModal.show();
        });

        // Login form with loading state
        document.getElementById('login-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            const loginBtn = document.getElementById('login-submit-btn');
            const originalText = loginBtn.querySelector('.btn-text').textContent;
            
            // Set loading state
            loginBtn.classList.add('btn-loading-state');
            
            const phone = document.getElementById('login-mobile').value.trim();
            const password = document.getElementById('login-password').value;
            
            if (!phone || !password) {
                alert('Tafadhali weka nambari ya simu na nenosiri.');
                loginBtn.classList.remove('btn-loading-state');
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ phone, password })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    currentUser = data.customer;
                    authToken = data.accessToken;
                    refreshToken = data.refreshToken;
                    
                    localStorage.setItem('authToken', authToken);
                    localStorage.setItem('refreshToken', refreshToken);
                    
                    updateAuthSection();
                    loginModal.hide();
                    await loadUserData();
                    
                    // Reset form
                    document.getElementById('login-form').reset();
                    
                    alert('Umefanikiwa kuingia!');
                    
                    // If we were trying to checkout, go back to checkout
                    if (window.pendingCheckout) {
                        showSection('checkout');
                        window.pendingCheckout = false;
                    }
                } else {
                    alert(data.message || 'Nambari ya simu au nenosiri si sahihi. Tafadhali jaribu tena.');
                }
            } catch (error) {
                console.error('Login error:', error);
                alert('Hitilafu ya mtandao. Tafadhali jaribu tena.');
            } finally {
                // Reset loading state
                loginBtn.classList.remove('btn-loading-state');
            }
        });

        // Save registration form data on input
        document.getElementById('register-form').addEventListener('input', function() {
            saveRegistrationFormData();
        });

        // Registration form with loading state
        document.getElementById('register-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            const registerBtn = document.getElementById('register-submit-btn');
            
            // Set loading state
            registerBtn.classList.add('btn-loading-state');
            
            const firstName = document.getElementById('reg-first-name').value.trim();
            const lastName = document.getElementById('reg-last-name').value.trim();
            const mobile = document.getElementById('reg-mobile').value.trim();
            const password = document.getElementById('reg-password').value;
            const confirmPassword = document.getElementById('reg-confirm-password').value;
            const email = document.getElementById('reg-email').value.trim();
            const address = document.getElementById('reg-address').value.trim();
            const gender = document.querySelector('input[name="reg-gender"]:checked')?.value;
            
            if (!firstName || !lastName || !mobile || !password || !confirmPassword || !address || !gender) {
                alert('Tafadhali jaza sehemu zote zinazohitajika.');
                registerBtn.classList.remove('btn-loading-state');
                return;
            }

            if (password !== confirmPassword) {
                alert('Nenosiri halifanani. Tafadhali hakikisha nenosiri ni sawa.');
                registerBtn.classList.remove('btn-loading-state');
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/register`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        first_name: firstName,
                        last_name: lastName,
                        phone: mobile,
                        password: password,
                        confirm_password: confirmPassword,
                        email: email || null,
                        address: address,
                        gender: gender
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    alert('Usajili umefanikiwa! Sasa unaweza kuingia.');
                    registerModal.hide();
                    loginModal.show();
                    document.getElementById('login-mobile').value = mobile;
                    
                    // Clear saved form data
                    clearRegistrationFormData();
                    
                    // Reset form
                    document.getElementById('register-form').reset();
                } else {
                    alert(data.message || 'Hitilafu katika usajili. Tafadhali jaribu tena.');
                }
            } catch (error) {
                console.error('Registration error:', error);
                alert('Hitilafu ya mtandao. Tafadhali jaribu tena.');
            } finally {
                // Reset loading state
                registerBtn.classList.remove('btn-loading-state');
            }
        });

        // Forgot password form with loading state
        document.getElementById('forgot-password-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            const forgotBtn = document.getElementById('forgot-password-submit-btn');
            
            // Set loading state
            forgotBtn.classList.add('btn-loading-state');
            
            const firstName = document.getElementById('forgot-first-name').value.trim();
            const lastName = document.getElementById('forgot-last-name').value.trim();
            
            if (!firstName || !lastName) {
                alert('Tafadhali weka jina lako la kwanza na jina la mwisho.');
                forgotBtn.classList.remove('btn-loading-state');
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/forgot-password`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ first_name: firstName, last_name: lastName })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    resetToken = data.reset_token;
                    // Show step 2
                    document.getElementById('forgot-password-step-1').classList.add('hidden');
                    document.getElementById('forgot-password-step-2').classList.remove('hidden');
                } else {
                    alert(data.message || 'Mteja hajapatikana na maelezo hayo. Tafadhali jaribu tena.');
                }
            } catch (error) {
                console.error('Forgot password error:', error);
                alert('Hitilafu ya mtandao. Tafadhali jaribu tena.');
            } finally {
                // Reset loading state
                forgotBtn.classList.remove('btn-loading-state');
            }
        });

        // Reset password button
        document.getElementById('reset-password-btn').addEventListener('click', function() {
            document.getElementById('forgot-password-step-2').classList.add('hidden');
            document.getElementById('reset-password-form').classList.remove('hidden');
        });

        // Reset mobile button
        document.getElementById('reset-mobile-btn').addEventListener('click', function() {
            document.getElementById('forgot-password-step-2').classList.add('hidden');
            document.getElementById('reset-mobile-form').classList.remove('hidden');
        });

        // New password form with loading state
        document.getElementById('new-password-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            const resetBtn = document.getElementById('reset-password-submit-btn');
            
            // Set loading state
            resetBtn.classList.add('btn-loading-state');
            
            const newPassword = document.getElementById('new-password-reset').value;
            const confirmPassword = document.getElementById('confirm-new-password-reset').value;
            
            if (!newPassword || !confirmPassword) {
                alert('Tafadhali weka nenosiri jipya na urudie.');
                resetBtn.classList.remove('btn-loading-state');
                return;
            }

            if (newPassword !== confirmPassword) {
                alert('Nenosiri halifanani. Tafadhali hakikisha nenosiri ni sawa.');
                resetBtn.classList.remove('btn-loading-state');
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/reset-password`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        reset_token: resetToken,
                        new_password: newPassword,
                        confirm_password: confirmPassword
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    alert('Nenosiri limebadilishwa kikamilifu! Unaweza kuingia sasa kwa nenosiri jipya.');
                    forgotPasswordModal.hide();
                    loginModal.show();
                    resetToken = null;
                    
                    // Reset forms
                    document.getElementById('forgot-password-form').reset();
                    document.getElementById('new-password-form').reset();
                    document.getElementById('forgot-password-step-1').classList.remove('hidden');
                    document.getElementById('forgot-password-step-2').classList.add('hidden');
                    document.getElementById('reset-password-form').classList.add('hidden');
                } else {
                    alert(data.message || 'Hitilafu katika kubadilisha nenosiri. Tafadhali jaribu tena.');
                }
            } catch (error) {
                console.error('Reset password error:', error);
                alert('Hitilafu ya mtandao. Tafadhali jaribu tena.');
            } finally {
                // Reset loading state
                resetBtn.classList.remove('btn-loading-state');
            }
        });

        // New mobile form with loading state
        document.getElementById('new-mobile-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            const mobileBtn = document.getElementById('reset-mobile-submit-btn');
            
            // Set loading state
            mobileBtn.classList.add('btn-loading-state');
            
            const newMobile = document.getElementById('new-mobile').value.trim();
            const confirmMobile = document.getElementById('confirm-new-mobile').value.trim();
            
            if (!newMobile || !confirmMobile) {
                alert('Tafadhali weka nambari mpya ya simu na urudie.');
                mobileBtn.classList.remove('btn-loading-state');
                return;
            }

            if (newMobile !== confirmMobile) {
                alert('Nambari za simu hazifanani. Tafadhali hakikisha nambari ni sawa.');
                mobileBtn.classList.remove('btn-loading-state');
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/change-mobile`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        first_name: document.getElementById('forgot-first-name').value,
                        last_name: document.getElementById('forgot-last-name').value,
                        new_mobile: newMobile,
                        confirm_mobile: confirmMobile
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    alert('Nambari ya simu imebadilishwa kikamilifu! Unaweza kuingia sasa kwa nambari mpya.');
                    forgotPasswordModal.hide();
                    loginModal.show();
                    
                    // Reset forms
                    document.getElementById('forgot-password-form').reset();
                    document.getElementById('new-mobile-form').reset();
                    document.getElementById('forgot-password-step-1').classList.remove('hidden');
                    document.getElementById('forgot-password-step-2').classList.add('hidden');
                    document.getElementById('reset-mobile-form').classList.add('hidden');
                } else {
                    alert(data.message || 'Hitilafu katika kubadilisha nambari ya simu. Tafadhali jaribu tena.');
                }
            } catch (error) {
                console.error('Change mobile error:', error);
                alert('Hitilafu ya mtandao. Tafadhali jaribu tena.');
            } finally {
                // Reset loading state
                mobileBtn.classList.remove('btn-loading-state');
            }
        });

        // Checkout steps
        document.getElementById('add-new-address-checkout').addEventListener('click', function() {
            document.getElementById('new-address-form').style.display = 'block';
        });

        document.getElementById('save-new-address').addEventListener('click', function() {
            const newAddress = document.getElementById('new-shipping-address').value.trim();
            
            if (!newAddress) {
                alert('Tafadhali weka anwani mpya.');
                return;
            }
            
            // Add to saved addresses
            if (!savedAddresses.includes(newAddress)) {
                savedAddresses.push(newAddress);
                saveAddresses();
                updateAddressSelection();
                document.getElementById('new-address-form').style.display = 'none';
                document.getElementById('new-shipping-address').value = '';
                alert('Anwani mpya imehifadhiwa!');
            } else {
                alert('Anwani hii tayari ipo kwenye orodha yako.');
            }
        });

        document.getElementById('continue-to-summary').addEventListener('click', function() {
            if (!selectedAddress) {
                alert('Tafadhali chagua anwani ya mshipisho.');
                return;
            }
            
            document.getElementById('checkout-step-1').classList.add('hidden');
            document.getElementById('checkout-step-2').classList.remove('hidden');
            
            // Update checkout progress UI
            updateCheckoutProgress(2);
            
            updateCheckoutSummary();
        });

        document.getElementById('proceed-to-payment').addEventListener('click', function() {
            // Show password verification for first order
            if (isFirstOrder) {
                document.getElementById('password-verification-section').style.display = 'block';
            }
            
            document.getElementById('checkout-step-2').classList.add('hidden');
            document.getElementById('checkout-step-3').classList.remove('hidden');
            
            // Update checkout progress UI
            updateCheckoutProgress(3);
        });

        // Password verification for checkout
        document.getElementById('password-verification').addEventListener('input', function() {
            const password = this.value;
            if (password.length >= 6) {
                confirmOrderBtn.disabled = false;
            } else {
                confirmOrderBtn.disabled = true;
            }
        });

        // Enhanced Confirm order with password verification and loading state
        confirmOrderBtn.addEventListener('click', async function(e) {
            e.preventDefault();
            
            if (!selectedAddress) {
                alert('Tafadhali chagua anwani ya mshipisho.');
                return;
            }
            
            // Set loading state
            confirmOrderBtn.classList.add('btn-loading-state');
            
            // For first order, require password verification
            if (isFirstOrder) {
                const password = document.getElementById('password-verification').value;
                
                if (!password) {
                    alert('Tafadhali ingiza nenosiri lako kuthibitisha agizo lako la kwanza.');
                    confirmOrderBtn.classList.remove('btn-loading-state');
                    return;
                }
                
                // Verify password first
                try {
                    const response = await fetch(`${API_BASE_URL}/verify-password`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${authToken}`
                        },
                        body: JSON.stringify({ password })
                    });
                    
                    const data = await response.json();
                    
                    if (!response.ok) {
                        alert(data.message || 'Nenosiri si sahihi. Tafadhali jaribu tena.');
                        confirmOrderBtn.classList.remove('btn-loading-state');
                        return;
                    }
                } catch (error) {
                    console.error('Password verification error:', error);
                    alert('Hitilafu ya mtandao. Tafadhali jaribu tena.');
                    confirmOrderBtn.classList.remove('btn-loading-state');
                    return;
                }
            }
            
            try {
                // Prepare order items with product_id and size_id
                const orderItems = cart.map(item => {
                    // Find the size_id for the selected size
                    const size = item.product.sizes?.find(s => {
                        const cleanSizeCodeToFind = cleanSizeCode(item.size);
                        const sizeCodeToCheck = s.code || s.size_label;
                        const cleanSizeToCheck = cleanSizeCode(sizeCodeToCheck);
                        return cleanSizeToCheck === cleanSizeCodeToFind;
                    });
                    
                    return {
                        product_id: item.product.id,
                        size_id: size?.id || null,
                        quantity: item.quantity
                    };
                }).filter(item => item.product_id && item.size_id); // Filter out items without size_id

                if (orderItems.length === 0) {
                    alert('Hitilafu: Hakuna bidhaa zilizochaguliwa kwa saizi sahihi.');
                    confirmOrderBtn.classList.remove('btn-loading-state');
                    return;
                }

                const response = await fetch(`${API_BASE_URL}/orders`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        items: orderItems
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    // Create confetti effect
                    createConfetti();
                    
                    // Show success modal after a short delay
                    setTimeout(() => {
                        orderSuccessModal.show();
                        
                        // Add to orders
                        const order = {
                            id: data.order_id,
                            items: [...cart],
                            total_price: data.total_price,
                            created_at: new Date().toISOString(),
                            status: data.status || 'Imewekwa'
                        };
                        
                        orders.push(order);
                        cart = [];
                        updateCartDisplay();
                        
                        // Mark that user has made at least one order
                        isFirstOrder = false;
                        
                        // Reset checkout
                        setTimeout(() => {
                            showSection('home');
                            resetCheckout();
                        }, 3000);
                    }, 1500);
                } else {
                    alert(data.message || 'Hitilafu katika kuweka agizo. Tafadhali jaribu tena.');
                }
            } catch (error) {
                console.error('Order error:', error);
                alert('Hitilafu ya mtandao. Tafadhali jaribu tena.');
            } finally {
                // Reset button state after delay
                setTimeout(() => {
                    confirmOrderBtn.classList.remove('btn-loading-state');
                }, 2000);
            }
        });

        // Profile form with loading state
        document.getElementById('profile-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            const profileBtn = document.getElementById('profile-save-btn');
            
            // Set loading state
            profileBtn.classList.add('btn-loading-state');
            
            const firstName = document.getElementById('first-name').value.trim();
            const lastName = document.getElementById('last-name').value.trim();
            const address = document.getElementById('address').value.trim();
            const gender = document.querySelector('input[name="gender"]:checked')?.value;
            
            if (!firstName || !lastName || !address || !gender) {
                alert('Tafadhali jaza sehemu zote zinazohitajika.');
                profileBtn.classList.remove('btn-loading-state');
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/me/update`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        first_name: firstName,
                        last_name: lastName,
                        address: address,
                        gender: gender
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    currentUser = data.customer;
                    // Update main address in saved addresses
                    if (savedAddresses.length > 0) {
                        savedAddresses[0] = address;
                    } else {
                        savedAddresses.push(address);
                    }
                    saveAddresses();
                    alert('Profaili imesasishwa kikamilifu!');
                } else {
                    alert(data.message || 'Hitilafu katika kusasisha profaili. Tafadhali jaribu tena.');
                }
            } catch (error) {
                console.error('Profile update error:', error);
                alert('Hitilafu ya mtandao. Tafadhali jaribu tena.');
            } finally {
                // Reset loading state
                profileBtn.classList.remove('btn-loading-state');
            }
        });

        // Change password form in profile with loading state
        document.getElementById('change-password-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            const changePassBtn = document.getElementById('change-password-btn');
            
            // Set loading state
            changePassBtn.classList.add('btn-loading-state');
            
            const currentPassword = document.getElementById('current-password').value;
            const newPassword = document.getElementById('new-password').value;
            const confirmNewPassword = document.getElementById('confirm-new-password').value;
            
            if (!currentPassword || !newPassword || !confirmNewPassword) {
                alert('Tafadhali jaza sehemu zote.');
                changePassBtn.classList.remove('btn-loading-state');
                return;
            }

            if (newPassword !== confirmNewPassword) {
                alert('Nenosiri jipya halifanani. Tafadhali hakikisha nenosiri ni sawa.');
                changePassBtn.classList.remove('btn-loading-state');
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/me/change-password`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        current_password: currentPassword,
                        new_password: newPassword,
                        confirm_password: confirmNewPassword
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    alert('Nenosiri limebadilishwa kikamilifu!');
                    document.getElementById('change-password-form').reset();
                } else {
                    alert(data.message || 'Hitilafu katika kubadilisha nenosiri. Tafadhali jaribu tena.');
                }
            } catch (error) {
                console.error('Change password error:', error);
                alert('Hitilafu ya mtandao. Tafadhali jaribu tena.');
            } finally {
                // Reset loading state
                changePassBtn.classList.remove('btn-loading-state');
            }
        });

        // Change phone number
        document.getElementById('change-mobile-btn').addEventListener('click', function() {
            const newMobile = prompt('Weka nambari mpya ya simu:');
            if (!newMobile) return;
            
            const confirmMobile = prompt('Rudia nambari mpya ya simu:');
            if (!confirmMobile) return;
            
            if (newMobile !== confirmMobile) {
                alert('Nambari za simu hazifanani.');
                return;
            }
            
            const currentPassword = prompt('Weka nenosiri lako la sasa kuthibitisha:');
            if (!currentPassword) return;
            
            // Make API call to change mobile
            fetch(`${API_BASE_URL}/me/change-phone`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${authToken}`
                },
                body: JSON.stringify({
                    new_phone: newMobile,
                    current_password: currentPassword
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.message) {
                    alert(data.message);
                    if (data.customer) {
                        currentUser = data.customer;
                        loadProfileData();
                    }
                }
            })
            .catch(error => {
                console.error('Change mobile error:', error);
                alert('Hitilafu ya mtandao. Tafadhali jaribu tena.');
            });
        });

        // Change email
        document.getElementById('change-email-btn').addEventListener('click', function() {
            const newEmail = prompt('Weka barua pepe mpya:');
            if (!newEmail) return;
            
            const currentPassword = prompt('Weka nenosiri lako la sasa kuthibitisha:');
            if (!currentPassword) return;
            
            // Make API call to change email
            fetch(`${API_BASE_URL}/me/change-email`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${authToken}`
                },
                body: JSON.stringify({
                    new_email: newEmail,
                    current_password: currentPassword
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.message) {
                    alert(data.message);
                    if (data.customer) {
                        currentUser = data.customer;
                        loadProfileData();
                    }
                }
            })
            .catch(error => {
                console.error('Change email error:', error);
                alert('Hitilafu ya mtandao. Tafadhali jaribu tena.');
            });
        });

        // Add new address in account section
        document.getElementById('add-new-address').addEventListener('click', function() {
            const address = prompt('Weka anwani mpya:');
            if (address && address.trim()) {
                if (!savedAddresses.includes(address.trim())) {
                    savedAddresses.push(address.trim());
                    saveAddresses();
                    updateAddressesDisplay();
                    alert('Anwani imehifadhiwa!');
                } else {
                    alert('Anwani hii tayari ipo kwenye orodha yako.');
                }
            }
        });

        // Customer message form with loading state
        document.getElementById('message-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            const messageBtn = document.getElementById('message-submit-btn');
            
            // Set loading state
            messageBtn.classList.add('btn-loading-state');
            
            const messageContent = document.getElementById('message-content').value.trim();
            
            if (!messageContent) {
                alert('Tafadhali andika ujumbe wako.');
                messageBtn.classList.remove('btn-loading-state');
                return;
            }
            
            if (!currentUser) {
                alert('Tafadhali ingia kwenye akaunti yako kwanza.');
                messageBtn.classList.remove('btn-loading-state');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/send-message`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        message: messageContent
                    })
                });
                
                if (response.ok) {
                    alert('Asante kwa ujumbe wako! Tutawasiliana nawe hivi karibuni.');
                    messageModal.hide();
                    document.getElementById('message-form').reset();
                    
                } else {
                    const data = await response.json();
                    alert(data.message || 'Hitilafu katika kutuma ujumbe. Tafadhali jaribu tena.');
                }
            } catch (error) {
                console.error('Message sending error:', error);
                alert('Hitilafu ya mtandao. Tafadhali jaribu tena.');
            } finally {
                // Reset loading state
                messageBtn.classList.remove('btn-loading-state');
            }
        });

        // Password verification form for order confirmation with loading state
        document.getElementById('password-verification-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            const verifyBtn = document.getElementById('password-verification-submit-btn');
            
            // Set loading state
            verifyBtn.classList.add('btn-loading-state');
            
            const password = document.getElementById('verification-password').value;
            const orderId = document.getElementById('verification-order-id').value;
            
            if (!password) {
                alert('Tafadhali ingiza nenosiri lako.');
                verifyBtn.classList.remove('btn-loading-state');
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/orders/${orderId}/confirm`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ password })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    alert('Agizo limepokelewa kikamilifu! Asante kwa ununuzi wako.');
                    passwordVerificationModal.hide();
                    
                    // Update order status locally
                    const order = orders.find(o => o.id == orderId);
                    if (order) {
                        order.status = 'Imepokelewa';
                    }
                    updateOrdersDisplay();
                    
                    // Reset form
                    document.getElementById('password-verification-form').reset();
                } else {
                    alert(data.message || 'Nenosiri si sahihi. Tafadhali jaribu tena.');
                }
            } catch (error) {
                console.error('Order confirmation error:', error);
                alert('Hitilafu ya mtandao. Tafadhali jaribu tena.');
            } finally {
                // Reset loading state
                verifyBtn.classList.remove('btn-loading-state');
            }
        });

        // Enhanced Star Rating System
        const ratingComments = {
            1: "Mbaya sana",
            2: "Mbaya",
            3: "Wastani",
            4: "Nzuri",
            5: "Bora kabisa"
        };

        // Handle star rating click, hover, and value/comment update
        document.querySelectorAll('.star-rating').forEach(ratingContainer => {
            // Click to set rating
            ratingContainer.addEventListener('click', function(e) {
                if (e.target.classList.contains('star')) {
                    const rating = parseInt(e.target.getAttribute('data-rating'));
                    const stars = this.querySelectorAll('.star');
                    const ratingType = this.id;

                    // Update active stars
                    stars.forEach((star, index) => {
                        star.classList.toggle('active', index < rating);
                        star.style.color = index < rating ? '#ffc107' : '#ddd';
                    });

                    // Update rating value
                    let ratingValueElement;
                    if (ratingType === 'product-rating-stars') {
                        ratingValueElement = document.getElementById('product-rating-value');
                    } else {
                        ratingValueElement = document.getElementById(`${ratingType}-value`);
                    }
                    if (ratingValueElement) ratingValueElement.textContent = rating;

                    // Update comment
                    let commentElement;
                    if (ratingType === 'product-rating-stars') {
                        commentElement = document.getElementById('product-comment');
                    } else {
                        commentElement = document.getElementById(`${ratingType.replace('-rating', '-comment')}`);
                    }
                    if (commentElement) commentElement.textContent = ratingComments[rating] || "Tathmini imewekwa";
                }
            });

            // Hover effect
            ratingContainer.addEventListener('mouseover', function(e) {
                if (e.target.classList.contains('star')) {
                    const rating = parseInt(e.target.getAttribute('data-rating'));
                    const stars = this.querySelectorAll('.star');
                    stars.forEach((star, index) => {
                        star.style.color = index < rating ? '#ffc107' : '#ddd';
                    });
                }
            });

            ratingContainer.addEventListener('mouseout', function(e) {
                const stars = this.querySelectorAll('.star');
                stars.forEach(star => {
                    star.style.color = star.classList.contains('active') ? '#ffc107' : '#ddd';
                });
            });
        });

        // Rating form submit with loading state
        document.getElementById('rating-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            const ratingBtn = document.getElementById('rating-submit-btn');
            
            // Set loading state
            ratingBtn.classList.add('btn-loading-state');

            const orderId = document.getElementById('rating-order-id').value;
            const packageRating = getRatingValue('package-rating');
            const deliveryRating = getRatingValue('delivery-rating');
            const productRating = getRatingValue('product-rating-stars');
            const overallComment = document.getElementById('overall-comment').value;

            if (!packageRating || !deliveryRating || !productRating) {
                alert('Tafadhali tathmini vipengele vyote vitatu.');
                ratingBtn.classList.remove('btn-loading-state');
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/orders/${orderId}/rate`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        package_rating: packageRating,
                        delivery_rating: deliveryRating,
                        product_rating: productRating,
                        overall_comment: overallComment || null
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    alert('Asante kwa tathmini yako! Maoni yako yanatusaidia kuboresha huduma zetu.');
                    ratingModal.hide();

                    // Reset form & stars
                    document.getElementById('rating-form').reset();
                    document.querySelectorAll('.star-rating .star').forEach(star => {
                        star.classList.remove('active');
                        star.style.color = '#ddd';
                    });
                    document.querySelectorAll('.rating-value').forEach(el => el.textContent = '0');
                    document.querySelectorAll('.rating-comment').forEach(el => el.textContent = 'Bonyeza nyota kuweka tathmini');

                    updateOrdersDisplay();
                } else {
                    alert(data.message || 'Hitilafu katika kuwasilisha tathmini. Tafadhali jaribu tena.');
                }
            } catch (error) {
                console.error('Rating error:', error);
                alert('Hitilafu ya mtandao. Tafadhali jaribu tena.');
            } finally {
                // Reset loading state
                ratingBtn.classList.remove('btn-loading-state');
            }
        });

        // Return order form with loading state
        document.getElementById('return-order-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            const returnBtn = document.getElementById('return-order-submit-btn');
            
            // Set loading state
            returnBtn.classList.add('btn-loading-state');

            const orderId = document.getElementById('return-order-id').value;
            const selectedReason = document.querySelector('input[name="return-reason-type"]:checked');
            const reasonDetails = document.getElementById('return-reason-details').value.trim();
            const originalPackaging = document.getElementById('original-packaging').checked;
            const tagsAttached = document.getElementById('tags-attached').checked;
            const notUsed = document.getElementById('not-used').checked;

            if (!selectedReason || !reasonDetails) {
                alert('Tafadhali chagua sababu na uandike maelezo zaidi.');
                returnBtn.classList.remove('btn-loading-state');
                return;
            }
            if (!originalPackaging || !tagsAttached || !notUsed) {
                alert('Bidhaa lazima iwe kwenye kifurushi chake asili, lebo ziwe zimeachwa, na haijatumika.');
                returnBtn.classList.remove('btn-loading-state');
                return;
            }

            const productCondition = { originalPackaging, tagsAttached, notUsed };
            const fullReason = `${selectedReason.value}: ${reasonDetails}`;

            try {
                const response = await fetch(`${API_BASE_URL}/orders/${orderId}/return`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ reason: fullReason, productCondition })
                });

                const data = await response.json();

                if (response.ok) {
                    alert('Ombi lako la kurudisha bidhaa limepokelewa! Tutawasiliana nawe hivi karibuni kuhusu mchakato wa kurudisha.');
                    returnOrderModal.hide();

                    // Reset form
                    document.getElementById('return-order-form').reset();

                    // Update order status locally
                    const order = orders.find(o => o.id == orderId);
                    if (order) order.status = 'Kurudishwa';
                    updateOrdersDisplay();
                } else {
                    alert(data.message || 'Hitilafu katika kuwasilisha ombi la kurudisha. Tafadhali jaribu tena.');
                }
            } catch (error) {
                console.error('Return order error:', error);
                alert('Hitilafu ya mtandao. Tafadhali jaribu tena.');
            } finally {
                // Reset loading state
                returnBtn.classList.remove('btn-loading-state');
            }
        });

        // Cancel order form with loading state
        document.getElementById('cancel-order-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            const cancelBtn = document.getElementById('cancel-order-submit-btn');
            
            // Set loading state
            cancelBtn.classList.add('btn-loading-state');
            
            const orderId = document.getElementById('cancel-order-id').value;
            const selectedReason = document.querySelector('input[name="cancel-reason-type"]:checked');
            const reasonDetails = document.getElementById('cancel-reason-details').value.trim();
            
            if (!selectedReason || !reasonDetails) {
                alert('Tafadhali chagua sababu na uandike maelezo zaidi.');
                cancelBtn.classList.remove('btn-loading-state');
                return;
            }

            const fullReason = `${selectedReason.value}: ${reasonDetails}`;

            try {
                const response = await fetch(`${API_BASE_URL}/orders/${orderId}/cancel`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ reason: fullReason })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    alert('Agizo limeghairiwa kikamilifu.');
                    cancelOrderModal.hide();
                    
                    // Reset form
                    document.getElementById('cancel-order-form').reset();
                    
                    // Update order status locally
                    const order = orders.find(o => o.id == orderId);
                    if (order) {
                        order.status = 'Ghairishwa';
                    }
                    updateOrdersDisplay();
                } else {
                    alert(data.message || 'Hitilafu katika kughairi agizo. Tafadhali jaribu tena.');
                }
            } catch (error) {
                console.error('Cancel order error:', error);
                alert('Hitilafu ya mtandao. Tafadhali jaribu tena.');
            } finally {
                // Reset loading state
                cancelBtn.classList.remove('btn-loading-state');
            }
        });

        // Password strength indicator
        const passwordInput = document.getElementById('reg-password');
        const strengthMeter = document.getElementById('password-strength-meter');
        
        if (passwordInput && strengthMeter) {
            passwordInput.addEventListener('input', function() {
                const password = this.value;
                let strength = 0;
                
                // Check password strength
                if (password.length >= 8) strength++;
                if (/[A-Z]/.test(password)) strength++;
                if (/[0-9]/.test(password)) strength++;
                if (/[^A-Za-z0-9]/.test(password)) strength++;
                
                // Update strength meter
                strengthMeter.className = 'password-strength-meter';
                if (password.length === 0) {
                    strengthMeter.style.width = '0';
                } else if (strength === 1) {
                    strengthMeter.classList.add('strength-weak');
                } else if (strength === 2) {
                    strengthMeter.classList.add('strength-medium');
                } else if (strength === 3) {
                    strengthMeter.classList.add('strength-strong');
                } else if (strength >= 4) {
                    strengthMeter.classList.add('strength-very-strong');
                }
            });
        }

        // Terms link - open in new tab and save form data
        document.getElementById('terms-link').addEventListener('click', function(e) {
            e.preventDefault();
            saveRegistrationFormData();
            window.open('regulations.html', '_blank');
        });

        // Share product button in product detail
        if (shareProductDetailBtn) {
            shareProductDetailBtn.addEventListener('click', function() {
                const productId = parseInt(productDetailSection.getAttribute('data-product-id'));
                const product = products.find(p => p.id === productId);
                
                if (product) {
                    showProductShareModal(product);
                }
            });
        }

        // Copy link button for product share modal
        document.getElementById('copy-product-link-btn')?.addEventListener('click', function() {
            const shareLinkInput = document.getElementById('product-share-link-input');
            const copySuccess = document.getElementById('product-copy-success');
            
            shareLinkInput.select();
            shareLinkInput.setSelectionRange(0, 99999);
            
            navigator.clipboard.writeText(shareLinkInput.value).then(() => {
                copySuccess.classList.remove('hidden');
                setTimeout(() => {
                    copySuccess.classList.add('hidden');
                }, 3000);
            });
        });

        // Copy link button for order share modal
        document.getElementById('copy-link-btn')?.addEventListener('click', function() {
            const shareLinkInput = document.getElementById('share-link-input');
            const copySuccess = document.getElementById('copy-success');
            
            shareLinkInput.select();
            shareLinkInput.setSelectionRange(0, 99999);
            
            navigator.clipboard.writeText(shareLinkInput.value).then(() => {
                copySuccess.classList.remove('hidden');
                setTimeout(() => {
                    copySuccess.classList.add('hidden');
                }, 3000);
            });
        });
    }

    // Get rating value from stars
    function getRatingValue(ratingId) {
        const stars = document.querySelectorAll(`#${ratingId} .star`);
        let rating = 0;
        stars.forEach(star => { if (star.classList.contains('active')) rating++; });
        return rating > 0 ? rating : null;
    }

    // Get stock for specific size
    function getSizeStock(product, sizeCode) {
        if (!product.sizes || product.sizes.length === 0) {
            return product.total_stock || 0;
        }
        
        const cleanSizeCodeToFind = cleanSizeCode(sizeCode);
        
        const size = product.sizes.find(s => {
            const sizeCodeToCheck = s.code || s.size_label;
            const cleanSizeToCheck = cleanSizeCode(sizeCodeToCheck);
            return cleanSizeToCheck === cleanSizeCodeToFind;
        });
        
        return size ? (size.stock || 0) : 0;
    }

    // Search functionality
    function showSearchResults(filteredProducts, searchTerm) {
        searchResults.innerHTML = '';
        
        if (filteredProducts.length === 0) {
            searchResults.innerHTML = '<div class="no-results">Hakuna bidhaa zilizopatikana kwa "' + searchTerm + '"</div>';
        } else {
            filteredProducts.forEach(product => {
                const resultItem = document.createElement('div');
                resultItem.className = 'search-result-item';
                resultItem.innerHTML = `
                    <div class="d-flex align-items-center">
                        <img src="${product.images && product.images.length > 0 ? product.images[0] : 'https://via.placeholder.com/50x50?text=Bidhaa'}" 
                             class="rounded me-3" style="width: 40px; height: 40px; object-fit: cover;" 
                             alt="${product.name}"
                             onerror="this.src='https://via.placeholder.com/50x50?text=Bidhaa'">
                        <div>
                            <div class="fw-bold">${product.name}</div>
                            <div class="text-muted small">TZS ${formatPrice(product.final_price || product.price)}</div>
                        </div>
                    </div>
                `;
                resultItem.addEventListener('click', function() {
                    showProductDetail(product.id);
                    hideSearchResults();
                    searchInput.value = '';
                });
                searchResults.appendChild(resultItem);
            });
        }
        
        searchResults.style.display = 'block';
    }

    function hideSearchResults() {
        searchResults.style.display = 'none';
    }

    // Create confetti effect
    function createConfetti() {
        const colors = ['#ff6b35', '#1a73e8', '#28a745', '#ffc107', '#dc3545'];
        const confettiCount = 100;
        
        for (let i = 0; i < confettiCount; i++) {
            const confetti = document.createElement('div');
            confetti.className = 'confetti';
            confetti.style.left = Math.random() * 100 + 'vw';
            confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
            confetti.style.width = Math.random() * 10 + 5 + 'px';
            confetti.style.height = Math.random() * 10 + 5 + 'px';
            confetti.style.opacity = '1';
            confetti.style.transform = `rotate(${Math.random() * 360}deg)`;
            
            document.body.appendChild(confetti);
            
            // Animate confetti
            const animation = confetti.animate([
                { transform: 'translateY(-100vh) rotate(0deg)', opacity: 1 },
                { transform: `translateY(${window.innerHeight}px) rotate(${Math.random() * 360}deg)`, opacity: 0 }
            ], {
                duration: Math.random() * 3000 + 2000,
                easing: 'cubic-bezier(0.215, 0.61, 0.355, 1)'
            });
            
            // Remove confetti after animation
            animation.onfinish = () => {
                confetti.remove();
            };
        }
    }

    // Update checkout progress
    function updateCheckoutProgress(step) {
        // Reset all steps
        document.querySelectorAll('.progress-step').forEach(stepEl => {
            stepEl.classList.remove('active', 'completed');
        });
        
        // Mark previous steps as completed and current step as active
        for (let i = 1; i <= step; i++) {
            const stepEl = document.getElementById(`step-${i === 1 ? 'address' : i === 2 ? 'summary' : 'payment'}`);
            if (i < step) {
                stepEl.classList.add('completed');
            } else {
                stepEl.classList.add('active');
            }
        }
    }

    // Show specific section
    function showSection(sectionName) {
        homeSection.classList.add('hidden');
        productDetailSection.classList.add('hidden');
        cartSection.classList.add('hidden');
        checkoutSection.classList.add('hidden');
        accountSection.classList.add('hidden');
        
        switch(sectionName) {
            case 'home':
                homeSection.classList.remove('hidden');
                window.scrollTo({ top: 0, behavior: 'smooth' });
                break;
            case 'cart':
                cartSection.classList.remove('hidden');
                updateCartDisplay();
                setTimeout(() => {
                    cartSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }, 100);
                break;
            case 'account':
                if (!currentUser) {
                    loginModal.show();
                    window.pendingAccount = true;
                    return;
                }
                accountSection.classList.remove('hidden');
                updateOrdersDisplay();
                setTimeout(() => {
                    accountSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }, 100);
                break;
            case 'checkout':
                if (!currentUser) {
                    loginModal.show();
                    window.pendingCheckout = true;
                    return;
                }
                checkoutSection.classList.remove('hidden');
                updateAddressSelection();
                updateCheckoutProgress(1);
                setTimeout(() => {
                    checkoutSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }, 100);
                break;
        }
        
        // Update active nav link
        document.querySelectorAll('.nav-link').forEach(link => {
            link.classList.remove('active');
            if (link.getAttribute('data-section') === sectionName) {
                link.classList.add('active');
            }
        });
    }

    // Update address selection in checkout
    function updateAddressSelection() {
        const addressSelection = document.getElementById('address-selection');
        addressSelection.innerHTML = '';
        
        if (savedAddresses.length === 0) {
            addressSelection.innerHTML = '<p class="text-muted">Huna anwani zilizohifadhiwa. Tafadhali ongeza anwani mpya.</p>';
            document.getElementById('new-address-form').style.display = 'block';
            document.getElementById('continue-to-summary').style.display = 'none';
            return;
        }
        
        savedAddresses.forEach((address, index) => {
            const addressCard = document.createElement('div');
            addressCard.className = `address-card ${selectedAddress === address ? 'selected' : ''}`;
            addressCard.innerHTML = `
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="shipping-address" 
                           id="address-${index}" value="${address}" 
                           ${selectedAddress === address ? 'checked' : ''}>
                    <label class="form-check-label" for="address-${index}">
                        ${address}
                    </label>
                </div>
                ${index === 0 ? '<small class="text-muted">(Anwani yako kuu)</small>' : ''}
            `;
            addressSelection.appendChild(addressCard);
            
            // Add event listener for address selection
            const radio = addressCard.querySelector('input[type="radio"]');
            radio.addEventListener('change', function() {
                if (this.checked) {
                    selectedAddress = this.value;
                    updateAddressSelection(); // Re-render to update selected state
                    document.getElementById('continue-to-summary').style.display = 'block';
                }
            });
        });
        
        // Show continue button if an address is selected
        if (selectedAddress) {
            document.getElementById('continue-to-summary').style.display = 'block';
        }
    }

    // Update addresses display in account section
    function updateAddressesDisplay() {
        const savedAddressesContainer = document.getElementById('saved-addresses');
        savedAddressesContainer.innerHTML = '';
        
        if (savedAddresses.length === 0) {
            savedAddressesContainer.innerHTML = '<p class="text-muted">Huna anwani zilizohifadhiwa.</p>';
            return;
        }
        
        savedAddresses.forEach((address, index) => {
            const addressCard = document.createElement('div');
            addressCard.className = 'address-card';
            addressCard.innerHTML = `
                <p class="mb-1">${address}</p>
                ${index === 0 ? '<small class="text-muted">(Anwani yako kuu)</small>' : ''}
                ${index > 0 ? `
                <button class="btn btn-sm btn-outline-danger remove-address" data-index="${index}">
                    Ondoa
                </button>
                ` : ''}
            `;
            savedAddressesContainer.appendChild(addressCard);
        });
        
        // Add event listeners for remove buttons
        document.querySelectorAll('.remove-address').forEach(btn => {
            btn.addEventListener('click', function() {
                const index = parseInt(this.getAttribute('data-index'));
                const addressToRemove = savedAddresses[index];
                
                if (confirm(`Una uhakika unataka kuondoa anwani hii?\n${addressToRemove}`)) {
                    savedAddresses.splice(index, 1);
                    saveAddresses();
                    updateAddressesDisplay();
                    alert('Anwani imeondolewa!');
                }
            });
        });
    }

    // Enhanced Show product detail with beautiful size selector and proper description display
    function showProductDetail(productId) {
        const product = products.find(p => p.id === productId);
        if (!product) {
            alert('Bidhaa haijapatikana.');
            return;
        }
        
        // Set product ID on detail section
        productDetailSection.setAttribute('data-product-id', productId);
        
        // Update product images with enhanced carousel
        const carouselInner = document.getElementById('product-carousel-inner');
        const carouselIndicators = document.getElementById('product-carousel-indicators');
        const carouselThumbnails = document.getElementById('product-carousel-thumbnails');
        
        carouselInner.innerHTML = '';
        carouselIndicators.innerHTML = '';
        carouselThumbnails.innerHTML = '';
        
        const images = product.images || [];
        if (images.length === 0) {
            // Default image if no images available
            carouselInner.innerHTML = `
                <div class="carousel-item active">
                    <img src="https://via.placeholder.com/500x500?text=Bidhaa" class="d-block w-100 product-detail-img" alt="${product.name}">
                </div>
            `;
        } else {
            images.forEach((img, index) => {
                // Main carousel items
                const item = document.createElement('div');
                item.className = `carousel-item ${index === 0 ? 'active' : ''}`;
                item.innerHTML = `
                    <img src="${img}" class="d-block w-100 product-detail-img" alt="${product.name}" 
                         onerror="this.src='https://via.placeholder.com/500x500?text=Bidhaa'">
                `;
                carouselInner.appendChild(item);
                
                // Indicators
                const indicator = document.createElement('div');
                indicator.className = `indicator ${index === 0 ? 'active' : ''}`;
                indicator.setAttribute('data-bs-target', '#productImagesCarousel');
                indicator.setAttribute('data-bs-slide-to', index);
                indicator.addEventListener('click', function() {
                    document.querySelectorAll('.indicator').forEach(ind => ind.classList.remove('active'));
                    this.classList.add('active');
                });
                carouselIndicators.appendChild(indicator);
                
                // Thumbnails
                const thumbnail = document.createElement('img');
                thumbnail.src = img;
                thumbnail.className = `thumbnail ${index === 0 ? 'active' : ''}`;
                thumbnail.alt = `${product.name} - Picha ${index + 1}`;
                thumbnail.onerror = function() {
                    this.src = 'https://via.placeholder.com/80x80?text=Bidhaa';
                };
                thumbnail.addEventListener('click', function() {
                    // Update main carousel
                    const carousel = bootstrap.Carousel.getInstance(document.getElementById('productImagesCarousel'));
                    if (carousel) {
                        carousel.to(index);
                    }
                    
                    // Update active states
                    document.querySelectorAll('.thumbnail').forEach(thumb => thumb.classList.remove('active'));
                    this.classList.add('active');
                    
                    document.querySelectorAll('.indicator').forEach(ind => ind.classList.remove('active'));
                    document.querySelectorAll('.indicator')[index].classList.add('active');
                });
                carouselThumbnails.appendChild(thumbnail);
            });
        }
        
        // Update product info
        document.getElementById('product-name').textContent = product.name;
        
        // Update product description - show properly formatted text
        const descriptionElement = document.getElementById('product-description');
        const placeholderElement = document.getElementById('description-placeholder');
        
        if (product.description && product.description.trim().length > 0) {
            descriptionElement.textContent = product.description;
            descriptionElement.classList.remove('hidden');
            placeholderElement.classList.add('hidden');
        } else {
            descriptionElement.classList.add('hidden');
            placeholderElement.classList.remove('hidden');
        }
        
        // Update product rating display
        const productRating = getProductRating(product.id);
        const ratingStars = generateStarRating(productRating.avg_rating);
        document.getElementById('product-rating-stars-display').innerHTML = ratingStars;
        document.getElementById('product-rating-text').textContent = `(${productRating.total_ratings || 0} tathmini)`;
        
        // Update pricing
        if (product.discount_percent > 0) {
            document.getElementById('old-price').textContent = `TZS ${formatPrice(product.price)}`;
            document.getElementById('old-price').style.display = 'inline';
            document.getElementById('current-price').textContent = `TZS ${formatPrice(product.final_price)}`;
            document.getElementById('offer-badge').textContent = `${product.discount_percent}% OFF`;
            document.getElementById('offer-badge').style.display = 'block';
        } else {
            document.getElementById('old-price').style.display = 'none';
            document.getElementById('current-price').textContent = `TZS ${formatPrice(product.price)}`;
            document.getElementById('offer-badge').style.display = 'none';
        }
        
        // Update stock info and badge
        const totalStock = product.sizes ? 
            product.sizes.reduce((sum, size) => sum + (size.stock || 0), 0) : 0;
            
        document.getElementById('stock-info').textContent = `(${totalStock} vitu vilivyobaki)`;

        let stockBadge = '';
        if (totalStock <= 0) {
            stockBadge = '<span class="product-availability out-of-stock-badge">Hakuna Akiba</span>';
        } else if (totalStock <= 5) {
            stockBadge = `<span class="product-availability low-stock">Akiba kidogo (${totalStock})</span>`;
        } else {
            stockBadge = `<span class="product-availability in-stock">Akiba (${totalStock})</span>`;
        }
        document.getElementById('stock-badge').innerHTML = stockBadge;
        
        // Update size options with enhanced design
        const sizeOptions = document.getElementById('size-options');
        sizeOptions.innerHTML = '';

        // Get available sizes from product.sizes array
        const sizes = product.sizes || [];
        if (sizes.length === 0) {
            // Default size if no sizes available
            const sizeOption = document.createElement('div');
            sizeOption.className = 'size-option active';
            sizeOption.innerHTML = `
                <span class="size-label">M</span>
                <span class="size-stock">Akiba</span>
            `;
            sizeOption.addEventListener('click', function() {
                document.querySelectorAll('.size-option').forEach(opt => opt.classList.remove('active'));
                this.classList.add('active');
            });
            sizeOptions.appendChild(sizeOption);
        } else {
            sizes.forEach((size, index) => {
                const sizeOption = document.createElement('div');
                const sizeCode = size.code || size.size_label;
                const sizeStock = size.stock || 0;
                
                // Clean the size code for display
                const cleanSizeCodeDisplay = cleanSizeCode(sizeCode);
                
                sizeOption.className = `size-option ${index === 0 ? 'active' : ''} ${sizeStock <= 0 ? 'disabled' : ''}`;
                sizeOption.innerHTML = `
                    <span class="size-label">${cleanSizeCodeDisplay}</span>
                    <span class="size-stock">${sizeStock}</span>
                `;
                
                if (sizeStock > 0) {
                    sizeOption.addEventListener('click', function() {
                        document.querySelectorAll('.size-option').forEach(opt => opt.classList.remove('active'));
                        this.classList.add('active');
                        
                        // Reset quantity to 1 when changing size
                        document.getElementById('quantity').textContent = '1';
                    });
                } else {
                    sizeOption.title = 'Hakuna akiba kwa saizi hii';
                }
                sizeOptions.appendChild(sizeOption);
            });
        }
        
        // Update product details tab
        const detailsTab = document.getElementById('details');
        detailsTab.innerHTML = `
            <h5>Maelezo ya Ziada</h5>
            <div class="row">
                <div class="col-md-6">
                    <p><strong>Chapa:</strong> ${product.company || 'Hakuna chapa'}</p>
                    <p><strong>Rangi:</strong> ${product.color || 'Hakuna rangi maalum'}</p>
                </div>
                <div class="col-md-6">
                    <p><strong>Aina:</strong> ${product.type || 'Hakuna aina maalum'}</p>
                    <p><strong>Ukubwa:</strong> ${sizes.map(s => `${cleanSizeCode(s.code || s.size_label)}`).join(', ')}</p>
                </div>
            </div>
            ${product.description && product.description.trim().length > 0 ? `
                <div class="mt-3">
                    <h6>Maelezo Kamili:</h6>
                    <p class="text-muted">${product.description}</p>
                </div>
            ` : ''}
        `;
        
        // Update reviews tab
        const reviewsTab = document.getElementById('reviews');
        reviewsTab.innerHTML = `
            <h5>Tathmini za Wateja</h5>
            <div class="product-rating-display mb-3">
                <div class="stars">${ratingStars}</div>
                <div class="rating-text">${productRating.avg_rating ? productRating.avg_rating.toFixed(1) : '0'} kutoka kwa tathmini ${productRating.total_ratings || 0}</div>
            </div>
            ${productRating.total_ratings > 0 ? 
                `<p>Wateja wamepata bidhaa hii kuwa ya ubora mzuri.</p>` : 
                `<div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    Bado hakuna tathmini za bidhaa hii. Kuwa wa kwanza kutathmini!
                </div>`
            }
        `;
        
        // Reset quantity
        document.getElementById('quantity').textContent = '1';
        
        // Show the section
        homeSection.classList.add('hidden');
        productDetailSection.classList.remove('hidden');
        
        // Scroll to top of product detail section
        setTimeout(() => {
            productDetailSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }, 100);
        
        // Initialize carousel if it exists
        setTimeout(() => {
            const carouselElement = document.getElementById('productImagesCarousel');
            if (carouselElement) {
                new bootstrap.Carousel(carouselElement, {
                    interval: 5000
                });
            }
        }, 100);
    }

    // Add product to cart
    function addToCart(product, quantity, size) {
        // Clean the size code to remove any extra text
        const cleanSize = cleanSizeCode(size);
        
        // Check if size has stock
        const sizeStock = getSizeStock(product, size);
        if (sizeStock <= 0) {
            alert(`Samahani, saizi ${cleanSize} hana akiba.`);
            return;
        }
        
        const existingItem = cart.find(item => 
            item.product.id === product.id && cleanSizeCode(item.size) === cleanSize
        );
        
        if (existingItem) {
            if (existingItem.quantity + quantity > sizeStock) {
                alert(`Samahani, kuna akiba ya ${sizeStock} tu kwa saizi ${cleanSize}. Huwezi kuongeza zaidi.`);
                return;
            }
            existingItem.quantity += quantity;
        } else {
            if (quantity > sizeStock) {
                alert(`Samahani, kuna akiba ya ${sizeStock} tu kwa saizi ${cleanSize}.`);
                return;
            }
            cart.push({
                product,
                quantity,
                size: cleanSize
            });
        }
        
        updateCartDisplay();
        alert(`${product.name} (Saizi: ${cleanSize}) imeongezwa kwenye karatasi!`);
    }

    // Enhanced Update cart display with FIXED responsive improvements
    function updateCartDisplay() {
        const cartItems = document.getElementById('cart-items');
        cartItems.innerHTML = '';
        
        if (cart.length === 0) {
            cartItems.innerHTML = '<p class="text-center py-5">Hakuna bidhaa kwenye karatasi yako.</p>';
            document.getElementById('cart-items-count').textContent = '0 ';
            document.getElementById('cart-subtotal').textContent = 'TZS 0';
            document.getElementById('cart-discount').textContent = 'TZS 0';
            document.getElementById('cart-total').textContent = 'TZS 0';
            
            // Update cart badges
            document.getElementById('cart-badge').style.display = 'none';
            document.getElementById('mobile-cart-badge').style.display = 'none';
            return;
        }
        
        let subtotal = 0;
        let totalItems = 0;
        
        cart.forEach((item, index) => {
            const itemPrice = item.product.final_price || item.product.price;
            const itemTotal = itemPrice * item.quantity;
            subtotal += itemTotal;
            totalItems += item.quantity;
            
            const cartItem = document.createElement('div');
            cartItem.className = 'cart-item';
            cartItem.innerHTML = `
                <div class="row align-items-center g-2">
                    <div class="col-2 col-md-2">
                        <img src="${item.product.images && item.product.images.length > 0 ? item.product.images[0] : 'https://via.placeholder.com/100x100?text=Bidhaa'}" 
                             class="img-fluid rounded" alt="${item.product.name}" 
                             style="height: 50px; width: 50px; object-fit: cover;"
                             onerror="this.src='https://via.placeholder.com/100x100?text=Bidhaa'">
                    </div>
                    <div class="col-5 col-md-4">
                        <h6 class="mb-1" style="font-size: 0.85rem; line-height: 1.2;">${item.product.name}</h6>
                        <p class="mb-0 small" style="font-size: 0.75rem; line-height: 1.2;">Saizi: <span class="cart-size-badge">${item.size}</span></p>
                        <p class="mb-0 small text-primary" style="font-size: 0.8rem; line-height: 1.2;">TZS ${formatPrice(itemPrice)}</p>
                    </div>
                    <div class="col-2">
                        <div class="quantity-selector d-flex align-items-center justify-content-center">
                            <div class="quantity-btn" data-index="${index}" data-action="decrease" style="width: 28px; height: 28px; font-size: 0.9rem;">-</div>
                            <span class="mx-2" style="min-width: 30px; text-align: center; font-size: 0.9rem; font-weight: bold;">${item.quantity}</span>
                            <div class="quantity-btn" data-index="${index}" data-action="increase" style="width: 28px; height: 28px; font-size: 0.9rem;">+</div>
                        </div>
                    </div>
                    <div class="col-2 text-end">
                        <strong class="text-primary" style="font-size: 0.85rem; white-space: nowrap; font-weight: bold;">TZS ${formatPrice(itemTotal)}</strong>
                    </div>
                    <div class="col-1">
                        <button class="btn btn-sm btn-outline-danger remove-item" data-index="${index}" style="padding: 5px 8px; font-size: 0.75rem; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center;">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `;
            cartItems.appendChild(cartItem);
        });
        
        // Add event listeners for quantity buttons and remove buttons
        document.querySelectorAll('.quantity-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const index = parseInt(this.getAttribute('data-index'));
                const action = this.getAttribute('data-action');
                const product = cart[index].product;
                const size = cart[index].size;
                const sizeStock = getSizeStock(product, size);
                
                if (action === 'increase') {
                    if (cart[index].quantity < sizeStock) {
                        cart[index].quantity += 1;
                    } else {
                        alert(`Samahani, kuna akiba ya ${sizeStock} tu kwa saizi ${size}.`);
                    }
                } else if (action === 'decrease' && cart[index].quantity > 1) {
                    cart[index].quantity -= 1;
                }
                
                updateCartDisplay();
            });
        });
        
        document.querySelectorAll('.remove-item').forEach(btn => {
            btn.addEventListener('click', function() {
                const index = parseInt(this.getAttribute('data-index'));
                const productName = cart[index].product.name;
                const size = cart[index].size;
                cart.splice(index, 1);
                updateCartDisplay();
                alert(`${productName} (Saizi: ${size}) imeondolewa kwenye karatasi.`);
            });
        });
        
        // Calculate discount (10% if 3 or more items)
        let discount = 0;
        if (totalItems >= 3) {
            discount = subtotal * 0.1;
        }
        
        const total = subtotal - discount;
        
        document.getElementById('cart-items-count').textContent = `${totalItems} `;
        document.getElementById('cart-subtotal').textContent = `TZS ${formatPrice(subtotal)}`;
        document.getElementById('cart-discount').textContent = `TZS ${formatPrice(discount)}`;
        document.getElementById('cart-total').textContent = `TZS ${formatPrice(total)}`;
        
        // Update cart badges
        document.getElementById('cart-badge').textContent = totalItems;
        document.getElementById('cart-badge').style.display = totalItems > 0 ? 'flex' : 'none';
        document.getElementById('mobile-cart-badge').textContent = totalItems;
        document.getElementById('mobile-cart-badge').style.display = totalItems > 0 ? 'flex' : 'none';
    }

    // Update checkout summary
    function updateCheckoutSummary() {
        const checkoutItems = document.getElementById('checkout-items');
        checkoutItems.innerHTML = '';
        
        let subtotal = 0;
        let totalItems = 0;
        
        cart.forEach(item => {
            const itemPrice = item.product.final_price || item.product.price;
            const itemTotal = itemPrice * item.quantity;
            subtotal += itemTotal;
            totalItems += item.quantity;
            
            const itemElement = document.createElement('div');
            itemElement.className = 'd-flex justify-content-between mb-2';
            itemElement.innerHTML = `
                <span>${item.product.name} <span class="cart-size-badge">${item.size}</span> x ${item.quantity}</span>
                <span>TZS ${formatPrice(itemTotal)}</span>
            `;
            checkoutItems.appendChild(itemElement);
        });
        
        // Calculate discount (10% if 3 or more items)
        let discount = 0;
        if (totalItems >= 3) {
            discount = subtotal * 0.1;
        }
        
        const total = subtotal - discount;
        
        document.getElementById('checkout-items-count').textContent = `${totalItems} `;
        document.getElementById('checkout-subtotal').textContent = `TZS ${formatPrice(subtotal)}`;
        document.getElementById('checkout-discount').textContent = `TZS ${formatPrice(discount)}`;
        document.getElementById('checkout-total').textContent = `TZS ${formatPrice(total)}`;
    }

    // Enhanced updateOrdersDisplay function
    function updateOrdersDisplay() {
        const ordersTableBody = document.getElementById('orders-table-body');
        ordersTableBody.innerHTML = '';
        
        if (orders.length === 0) {
            ordersTableBody.innerHTML = `
                <tr>
                    <td colspan="5" class="text-center py-4">Huna maagizo ya awali.</td>
                </tr>
            `;
            return;
        }

        // Sort orders by date (newest first)
        orders.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
        
        orders.forEach(order => {
            const row = document.createElement('tr');
            
            let statusClass = '';
            let statusText = order.status;
            
            switch(order.status) {
                case 'Imewekwa':
                    statusClass = 'status-imewekwa';
                    break;
                case 'Inasafirishwa':
                    statusClass = 'status-inasafirishwa';
                    break;
                case 'Imepokelewa':
                    statusClass = 'status-imepokelewa';
                    break;
                case 'Ghairishwa':
                    statusClass = 'status-ghairishwa';
                    break;
                case 'Kurudishwa':
                    statusClass = 'status-kurudishwa';
                    break;
                default:
                    statusClass = 'status-imewekwa';
            }
            
            const orderDate = new Date(order.created_at).toLocaleDateString('sw-TZ');
            const canReturn = canOrderBeReturned(order);
            
            row.innerHTML = `
                <td>
                    <a href="#" class="view-order-details" data-order-id="${order.id}">
                        #${order.id}
                    </a>
                </td>
                <td>TZS ${formatPrice(order.total_price)}</td>
                <td><span class="order-status ${statusClass}">${statusText}</span></td>
                <td>${orderDate}</td>
                <td>
                    <div class="order-actions">
                        <button class="btn btn-sm btn-outline-info view-order-details" data-order-id="${order.id}">
                            <i class="fas fa-eye"></i>
                        </button>
                        ${order.status === 'Imewekwa' ? 
                            `<button class="btn btn-sm btn-outline-danger cancel-order-btn" data-order-id="${order.id}">
                                <i class="fas fa-times"></i> Batilisha
                            </button>` : 
                            ''
                        }
                        ${order.status === 'Inasafirishwa' ? 
                            `<button class="btn btn-sm btn-outline-success confirm-order-btn" data-order-id="${order.id}">
                                <i class="fas fa-check"></i> Nimepokea
                            </button>` : 
                            ''
                        }
                        ${order.status === 'Imepokelewa' ? 
                            `<button class="btn btn-sm btn-outline-primary rate-order-btn" data-order-id="${order.id}">
                                <i class="fas fa-star"></i> Tathmini
                            </button>` : 
                            ''
                        }
                        ${order.status === 'Imepokelewa' && canReturn ? 
                            `<button class="btn btn-sm btn-outline-warning return-order-btn" data-order-id="${order.id}">
                                <i class="fas fa-undo"></i> Rudisha
                            </button>` : 
                            ''
                        }
                    </div>
                </td>
            `;
            ordersTableBody.appendChild(row);
        });
        
        // Add event listeners for order actions
        document.querySelectorAll('.cancel-order-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const orderId = this.getAttribute('data-order-id');
                showCancelOrderModal(orderId);
            });
        });
        
        document.querySelectorAll('.confirm-order-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const orderId = this.getAttribute('data-order-id');
                showPasswordVerificationModal(orderId);
            });
        });
        
        document.querySelectorAll('.rate-order-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const orderId = this.getAttribute('data-order-id');
                showRatingModal(orderId);
            });
        });
        
        document.querySelectorAll('.return-order-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const orderId = this.getAttribute('data-order-id');
                showReturnOrderModal(orderId);
            });
        });
        
        document.querySelectorAll('.view-order-details').forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                const orderId = this.getAttribute('data-order-id');
                showOrderDetails(orderId);
            });
        });
    }

    // Show password verification modal for order confirmation
    function showPasswordVerificationModal(orderId) {
        document.getElementById('verification-order-id').value = orderId;
        document.getElementById('verification-password').value = '';
        passwordVerificationModal.show();
    }

    // Check if order can be returned
    function canOrderBeReturned(order) {
        if (order.status !== 'Imepokelewa') {
            return false;
        }
        
        const orderDate = new Date(order.created_at);
        const currentDate = new Date();
        const diffTime = currentDate - orderDate;
        const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
        
        return diffDays <= 3;
    }

    // Show rating modal
    function showRatingModal(orderId) {
        // Reset star ratings
        document.querySelectorAll('.star-rating .star').forEach(star => {
            star.classList.remove('active');
            star.style.color = '#ddd';
        });
        
        // Reset rating values and comments
        document.querySelectorAll('.rating-value').forEach(el => {
            el.textContent = '0';
        });
        document.querySelectorAll('.rating-comment').forEach(el => {
            el.textContent = 'Bonyeza nyota kuweka tathmini';
        });
        
        // Clear comment
        document.getElementById('overall-comment').value = '';
        
        // Set order ID
        document.getElementById('rating-order-id').value = orderId;
        
        // Show modal
        ratingModal.show();
    }

    // Show return order modal
    function showReturnOrderModal(orderId) {
        // Reset form
        document.getElementById('return-order-form').reset();
        
        // Set order ID
        document.getElementById('return-order-id').value = orderId;
        
        // Show modal
        returnOrderModal.show();
    }

    // Show cancel order modal
    function showCancelOrderModal(orderId) {
        // Reset form
        document.getElementById('cancel-order-form').reset();
        
        // Set order ID
        document.getElementById('cancel-order-id').value = orderId;
        
        // Show modal
        cancelOrderModal.show();
    }

    // Show order details
    function showOrderDetails(orderId) {
        const order = orders.find(o => o.id == orderId);
        if (!order) return;
        
        document.getElementById('order-details-id').textContent = orderId;
        document.getElementById('order-details-total').textContent = formatPrice(order.total_price);
        document.getElementById('order-details-status').textContent = order.status;
        document.getElementById('order-details-date').textContent = new Date(order.created_at).toLocaleDateString('sw-TZ');
        
        if (currentUser) {
            document.getElementById('order-details-customer').textContent = `${currentUser.first_name} ${currentUser.last_name}`;
            document.getElementById('order-details-address').textContent = currentUser.address || 'Hakuna anwani';
        }
        
        orderDetailsModal.show();
    }

    // Enhanced Show order details with share functionality
    function showOrderDetails(orderId) {
        const order = orders.find(o => o.id == orderId);
        if (!order) return;
        
        document.getElementById('order-details-id').textContent = orderId;
        document.getElementById('order-details-total').textContent = formatPrice(order.total_price);
        document.getElementById('order-details-status').textContent = order.status;
        document.getElementById('order-details-date').textContent = new Date(order.created_at).toLocaleDateString('sw-TZ');
        
        if (currentUser) {
            document.getElementById('order-details-customer').textContent = `${currentUser.first_name} ${currentUser.last_name}`;
            document.getElementById('order-details-address').textContent = currentUser.address || 'Hakuna anwani';
        }
        
        // Update order items list
        const orderItemsList = document.getElementById('order-items-list');
        orderItemsList.innerHTML = '';
        
        order.items.forEach(item => {
            const itemElement = document.createElement('div');
            itemElement.className = 'order-item-row';
            itemElement.innerHTML = `
                <div class="row align-items-center">
                    <div class="col-2">
                        <img src="${item.product.images && item.product.images.length > 0 ? item.product.images[0] : 'https://via.placeholder.com/100x100?text=Bidhaa'}" 
                            class="img-fluid rounded" alt="${item.product.name}" 
                            style="height: 50px; object-fit: cover;"
                            onerror="this.src='https://via.placeholder.com/100x100?text=Bidhaa'">
                    </div>
                    <div class="col-5">
                        <h6 class="mb-1">${item.product.name}</h6>
                        <p class="mb-0 small">Saizi: <span class="product-size-badge">${item.size}</span></p>
                    </div>
                    <div class="col-2 text-center">
                        <span class="badge bg-secondary">${item.quantity}</span>
                    </div>
                    <div class="col-3 text-end">
                        <strong class="text-primary">TZS ${formatPrice((item.product.final_price || item.product.price) * item.quantity)}</strong>
                    </div>
                </div>
            `;
            orderItemsList.appendChild(itemElement);
        });
        
        // Hide share options initially
        document.getElementById('share-options').classList.add('hidden');
        
        // Show modal
        orderDetailsModal.show();
        
        // Add event listener for share button
        const shareBtn = document.getElementById('share-order-btn');
        if (shareBtn) {
            // Remove existing event listeners
            const newShareBtn = shareBtn.cloneNode(true);
            shareBtn.parentNode.replaceChild(newShareBtn, shareBtn);
            
            // Add new event listener
            newShareBtn.addEventListener('click', function() {
                showOrderShareOptions(order);
                
                // Scroll to share options
                setTimeout(() => {
                    document.getElementById('share-options').scrollIntoView({ 
                        behavior: 'smooth', 
                        block: 'start' 
                    });
                }, 100);
            });
        }
    }

    // Function to generate share links for order products
    function generateOrderShareLinks(order) {
        if (!order || !order.items || order.items.length === 0) {
            return [];
        }
        
        // Get base URL for sharing
        const baseUrl = window.location.origin + window.location.pathname;
        
        // Generate share links for each product
        const shareLinks = order.items.map((item, index) => {
            const product = item.product;
            const productName = encodeURIComponent(product.name);
            const productId = product.id;
            const productSize = item.size;
            const productPrice = formatPrice(product.final_price || product.price);
            
            // Generate product URL with query parameters
            const productUrl = `${baseUrl}?product=${productId}&share=true`;
            
            // Generate share text
            const shareText = `Nimepata bidhaa nzuri kutoka Four Brothers Sports Center!\n\n` +
                            `Bidhaa: ${product.name}\n` +
                            `Saizi: ${productSize}\n` +
                            `Bei: TZS ${productPrice}\n` +
                            `Kiungo: ${productUrl}`;
            
            const shareTextEncoded = encodeURIComponent(shareText);
            const shareUrlEncoded = encodeURIComponent(productUrl);
            
            return {
                productId: productId,
                productName: product.name,
                productUrl: productUrl,
                shareText: shareText,
                whatsapp: `https://wa.me/?text=${shareTextEncoded}`,
                facebook: `https://www.facebook.com/sharer/sharer.php?u=${shareUrlEncoded}&quote=${shareTextEncoded}`,
                twitter: `https://twitter.com/intent/tweet?text=${shareTextEncoded}&url=${shareUrlEncoded}`,
                telegram: `https://t.me/share/url?url=${shareUrlEncoded}&text=${shareTextEncoded}`,
                instagram: `https://www.instagram.com/?url=${shareUrlEncoded}`,
                copy: productUrl
            };
        });
        
        return shareLinks;
    }

    // Function to show share options for order
    function showOrderShareOptions(order) {
        const shareOptions = document.getElementById('share-options');
        const shareLinksContainer = document.getElementById('share-links');
        const shareLinkInput = document.getElementById('share-link-input');
        
        if (!order || !order.items || order.items.length === 0) {
            shareOptions.classList.add('hidden');
            return;
        }
        
        // Generate share links
        const productShareLinks = generateOrderShareLinks(order);
        
        // If there are multiple products, show product selector
        if (productShareLinks.length > 1) {
            // Create product selector
            shareLinksContainer.innerHTML = `
                <div class="mb-3">
                    <label for="share-product-select" class="form-label">Chagua Bidhaa ya Kushiriki:</label>
                    <select class="form-select" id="share-product-select">
                        ${productShareLinks.map((link, index) => `
                            <option value="${index}">${link.productName} (Saizi: ${order.items[index].size})</option>
                        `).join('')}
                    </select>
                </div>
                <div id="share-icons-container"></div>
            `;
            
            // Function to update share icons based on selected product
            const updateShareIcons = (selectedIndex) => {
                const selectedLinks = productShareLinks[selectedIndex];
                const shareIconsContainer = document.getElementById('share-icons-container');
                
                shareIconsContainer.innerHTML = `
                    <div class="share-links">
                        <a href="${selectedLinks.whatsapp}" 
                        class="share-whatsapp" 
                        target="_blank" 
                        title="Shiriki kwenye WhatsApp">
                            <i class="fab fa-whatsapp"></i>
                        </a>
                        <a href="${selectedLinks.facebook}" 
                        class="share-facebook" 
                        target="_blank" 
                        title="Shiriki kwenye Facebook">
                            <i class="fab fa-facebook-f"></i>
                        </a>
                        <a href="${selectedLinks.twitter}" 
                        class="share-twitter" 
                        target="_blank" 
                        title="Shiriki kwenye Twitter">
                            <i class="fab fa-twitter"></i>
                        </a>
                        <a href="${selectedLinks.telegram}" 
                        class="share-telegram" 
                        target="_blank" 
                        title="Shiriki kwenye Telegram">
                            <i class="fab fa-telegram"></i>
                        </a>
                        <a href="${selectedLinks.instagram}" 
                        class="share-instagram" 
                        target="_blank" 
                        title="Shiriki kwenye Instagram">
                            <i class="fab fa-instagram"></i>
                        </a>
                        <a href="#" 
                        class="share-copy" 
                        title="Nakili kiungo" 
                        id="share-copy-btn">
                            <i class="fas fa-copy"></i>
                        </a>
                    </div>
                `;
                
                // Update share link input
                shareLinkInput.value = selectedLinks.productUrl;
                
                // Add copy button event listener
                document.getElementById('share-copy-btn').addEventListener('click', function(e) {
                    e.preventDefault();
                    shareLinkInput.select();
                    shareLinkInput.setSelectionRange(0, 99999);
                    
                    navigator.clipboard.writeText(shareLinkInput.value).then(() => {
                        const copySuccess = document.getElementById('copy-success');
                        copySuccess.classList.remove('hidden');
                        setTimeout(() => {
                            copySuccess.classList.add('hidden');
                        }, 3000);
                    });
                });
            };
            
            // Initial update
            updateShareIcons(0);
            
            // Add event listener for product selection change
            document.getElementById('share-product-select').addEventListener('change', function() {
                updateShareIcons(parseInt(this.value));
            });
            
        } else if (productShareLinks.length === 1) {
            // Only one product, show share icons directly
            const links = productShareLinks[0];
            
            shareLinksContainer.innerHTML = `
                <div class="mb-3">
                    <h6>${links.productName} (Saizi: ${order.items[0].size})</h6>
                </div>
                <div class="share-links">
                    <a href="${links.whatsapp}" 
                    class="share-whatsapp" 
                    target="_blank" 
                    title="Shiriki kwenye WhatsApp">
                        <i class="fab fa-whatsapp"></i>
                    </a>
                    <a href="${links.facebook}" 
                    class="share-facebook" 
                    target="_blank" 
                    title="Shiriki kwenye Facebook">
                        <i class="fab fa-facebook-f"></i>
                    </a>
                    <a href="${links.twitter}" 
                    class="share-twitter" 
                    target="_blank" 
                    title="Shiriki kwenye Twitter">
                        <i class="fab fa-twitter"></i>
                    </a>
                    <a href="${links.telegram}" 
                    class="share-telegram" 
                    target="_blank" 
                    title="Shiriki kwenye Telegram">
                        <i class="fab fa-telegram"></i>
                    </a>
                    <a href="${links.instagram}" 
                    class="share-instagram" 
                    target="_blank" 
                    title="Shiriki kwenye Instagram">
                        <i class="fab fa-instagram"></i>
                    </a>
                    <a href="#" 
                    class="share-copy" 
                    title="Nakili kiungo" 
                    id="share-copy-btn">
                        <i class="fas fa-copy"></i>
                    </a>
                </div>
            `;
            
            shareLinkInput.value = links.productUrl;
            
            // Add copy button event listener
            document.getElementById('share-copy-btn').addEventListener('click', function(e) {
                e.preventDefault();
                shareLinkInput.select();
                shareLinkInput.setSelectionRange(0, 99999);
                
                navigator.clipboard.writeText(shareLinkInput.value).then(() => {
                    const copySuccess = document.getElementById('copy-success');
                    copySuccess.classList.remove('hidden');
                    setTimeout(() => {
                        copySuccess.classList.add('hidden');
                    }, 3000);
                });
            });
        }
        
        // Show share options
        shareOptions.classList.remove('hidden');
    }

    // Function to show product share modal
    function showProductShareModal(product) {
        const sharePlatformsContainer = document.getElementById('product-share-platforms');
        const shareLinkInput = document.getElementById('product-share-link-input');
        
        // Generate product URL
        const baseUrl = window.location.origin + window.location.pathname;
        const productUrl = `${baseUrl}?product=${product.id}&share=true`;
        
        // Generate share text
        const shareText = `Nimepata bidhaa nzuri ya ${product.name} kutoka Four Brothers Sports Center!\n\n` +
                        `Bei: TZS ${formatPrice(product.final_price || product.price)}\n` +
                        `Kiungo: ${productUrl}`;
        
        const shareTextEncoded = encodeURIComponent(shareText);
        const shareUrlEncoded = encodeURIComponent(productUrl);
        
        // Create share platforms
        const sharePlatforms = [
            {
                name: 'WhatsApp',
                icon: 'fab fa-whatsapp',
                color: '#25D366',
                url: `https://wa.me/?text=${shareTextEncoded}`
            },
            {
                name: 'Facebook',
                icon: 'fab fa-facebook-f',
                color: '#1877F2',
                url: `https://www.facebook.com/sharer/sharer.php?u=${shareUrlEncoded}&quote=${shareTextEncoded}`
            },
            {
                name: 'Twitter',
                icon: 'fab fa-twitter',
                color: '#1DA1F2',
                url: `https://twitter.com/intent/tweet?text=${shareTextEncoded}&url=${shareUrlEncoded}`
            },
            {
                name: 'Telegram',
                icon: 'fab fa-telegram',
                color: '#0088cc',
                url: `https://t.me/share/url?url=${shareUrlEncoded}&text=${shareTextEncoded}`
            },
            {
                name: 'Instagram',
                icon: 'fab fa-instagram',
                color: '#E4405F',
                url: `https://www.instagram.com/?url=${shareUrlEncoded}`
            },
            {
                name: 'Nakili Kiungo',
                icon: 'fas fa-copy',
                color: '#1a73e8',
                url: '#',
                action: 'copy'
            }
        ];
        
        // Create platform elements
        sharePlatformsContainer.innerHTML = sharePlatforms.map(platform => `
            <a href="${platform.url}" 
               class="share-platform ${platform.action === 'copy' ? 'copy-link' : ''}" 
               ${platform.action === 'copy' ? 'onclick="copyProductLink(event)"' : 'target="_blank"'}
               style="background: ${platform.color};">
                <i class="${platform.icon}"></i>
                <span class="share-platform-name">${platform.name}</span>
            </a>
        `).join('');
        
        // Set share link input value
        shareLinkInput.value = productUrl;
        
        // Show modal
        productShareModal.show();
    }

    // Function to copy product link
    window.copyProductLink = function(e) {
        e.preventDefault();
        const shareLinkInput = document.getElementById('product-share-link-input');
        const copySuccess = document.getElementById('product-copy-success');
        
        shareLinkInput.select();
        shareLinkInput.setSelectionRange(0, 99999);
        
        navigator.clipboard.writeText(shareLinkInput.value).then(() => {
            copySuccess.classList.remove('hidden');
            setTimeout(() => {
                copySuccess.classList.add('hidden');
            }, 3000);
        });
    };

    // Load profile data
    function loadProfileData() {
        if (!currentUser) return;
        
        document.getElementById('first-name').value = currentUser.first_name || '';
        document.getElementById('last-name').value = currentUser.last_name || '';
        document.getElementById('mobile').value = currentUser.phone || '';
        document.getElementById('email').value = currentUser.email || '';
        document.getElementById('address').value = currentUser.address || '';
        
        // Set gender
        if (currentUser.gender) {
            const genderInput = document.querySelector(`input[name="gender"][value="${currentUser.gender}"]`);
            if (genderInput) {
                genderInput.checked = true;
            }
        }
    }

    // Reset checkout process
    function resetCheckout() {
        document.getElementById('checkout-step-1').classList.remove('hidden');
        document.getElementById('checkout-step-2').classList.add('hidden');
        document.getElementById('checkout-step-3').classList.add('hidden');
        
        // Reset checkout progress UI
        updateCheckoutProgress(1);
        
        // Clear password input
        document.getElementById('password-verification').value = '';
        document.getElementById('password-verification-section').style.display = 'none';
        
        // Reset selected address
        selectedAddress = null;
    }

    // Sample products data (fallback)
    function getSampleProducts() {
        return [
            {
                id: 1,
                name: "Viatu vya Kukimbia Nike Air Max",
                company: "Nike",
                color: "Nyeusi/Nyeupe",
                type: "Njumu na Trainer",
                price: 150000,
                discount_percent: 17,
                final_price: 124500,
                total_stock: 15,
                images: ["https://via.placeholder.com/400x400?text=Nike+Air+Max"],
                sizes: [
                    { id: 1, code: "M", size_label: "Medium", stock: 5 },
                    { id: 2, code: "L", size_label: "Large", stock: 5 },
                    { id: 3, code: "XL", size_label: "Extra Large", stock: 5 }
                ],
                description: "Viatu vya kukimbia vya Nike Air Max vilivyoundwa kwa ustadi. Vinatosha hewa, vinavyobana vizuri na vinakupa faraja siku nzima. Vinaunganishwa na teknolojia ya Air Max inayopunguza mshtuko wakati wa mkimbio."
            },
            {
                id: 2,
                name: "Viatu vya Soka Adidas Predator",
                company: "Adidas",
                color: "Nyekundu/Nyeupe",
                type: "Njumu",
                price: 120000,
                discount_percent: 0,
                final_price: 120000,
                total_stock: 8,
                images: ["https://via.placeholder.com/400x400?text=Adidas+Predator"],
                sizes: [
                    { id: 4, code: "S", size_label: "Small", stock: 3 },
                    { id: 5, code: "M", size_label: "Medium", stock: 3 },
                    { id: 6, code: "L", size_label: "Large", stock: 2 }
                ],
                description: "Viatu vya soka vya Adidas Predator vilivyoundwa kwa wachezaji wa kitaalamu. Vina ukombozi bora wa mpira, udhibiti, na usahihi wa kupiga pasi. Vimeundwa kwa ngozi ya ubora wa juu."
            },
            {
                id: 3,
                name: "Viatu vya Basketball Jordan",
                company: "Jordan",
                color: "Nyekundu/Nyeusi",
                type: "Trainer",
                price: 200000,
                discount_percent: 20,
                final_price: 160000,
                total_stock: 5,
                images: ["https://via.placeholder.com/400x400?text=Jordan+Basketball"],
                sizes: [
                    { id: 7, code: "L", size_label: "Large", stock: 3 },
                    { id: 8, code: "XL", size_label: "Extra Large", stock: 2 }
                ],
                description: "Viatu vya mpira wa kikapu vya Jordan vilivyoundwa kwa usanifu wa kisasa. Vina msaada bora wa tumbo la mguu, udhibiti wa mwendo, na faraja wakati wa kuruka na kukanyaga. Vimeunganishwa na teknolojia ya Air cushioning."
            }
        ];
    }
</script>
</body>
</html>